(()=>{var e={};e.id=8435,e.ids=[5069,8435],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,r)=>{"use strict";r.d(t,{db:()=>a,prisma:()=>n});var i=r(96330);let a=globalThis.prisma??new i.PrismaClient({log:["query"]}),n=a},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19089:(e,t,r)=>{"use strict";r.d(t,{h:()=>n});var i=r(5069);class a{static async triggerWelcomeEmail(e){let t=await i.db.users.findUnique({where:{id:e}});t&&console.log(`Welcome email sent to ${t.email}`)}static async triggerCashbackEmail(e,t,r){let a=await i.db.users.findUnique({where:{id:e}});a&&console.log(`Cashback email sent to ${a.email}: $${t} for ${r}`)}static async triggerMilestoneEmail(e,t){let r=await i.db.users.findUnique({where:{id:e}});r&&console.log(`Milestone email sent to ${r.email}: ${t}`)}static async triggerReferralEmail(e,t){let r=await i.db.users.findUnique({where:{id:e}});r&&console.log(`Referral email sent to ${r.email}`)}static async triggerMonthlyReport(e,t){let r=await i.db.users.findUnique({where:{id:e}});r&&console.log(`Monthly report sent to ${r.email}`)}}let n=a},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47228:(e,t,r)=>{"use strict";r.d(t,{D:()=>s});var i=r(5069),a=r(96330),n=r(59232);class s{static async createOrUpdateUser(e){try{let t=await i.db.users.findUnique({where:{email:e.email}}),r=null;if(e.referralCode&&!t){let t=await i.db.users.findUnique({where:{referralCode:e.referralCode}});t&&(r=t.id)}if(t)return await i.db.users.update({where:{email:e.email},data:{tradingVolume:e.tradingVolume?parseFloat(e.tradingVolume):void 0,preferredBroker:e.preferredBroker,experience:e.experience,referralSource:e.referralSource,lastActiveAt:new Date,updatedAt:new Date}});{let t=(0,n.Ak)(8).toUpperCase();return await i.db.users.create({data:{email:e.email,name:e.name,tradingVolume:e.tradingVolume?parseFloat(e.tradingVolume):0,preferredBroker:e.preferredBroker,experience:e.experience,referralSource:e.referralSource,referralCode:t,referredBy:r,tier:a.UserTier.BRONZE,totalSaved:0,referralCount:0,points:0,streak:1,badgeCount:0,updatedAt:new Date}})}}catch(e){throw console.error("Error creating/updating user:",e),e}}static async getUserByEmail(e){try{return await i.db.users.findUnique({where:{email:e},include:{payouts:{orderBy:{createdAt:"desc"},take:10},achievements:{include:{achievement:!0}},activities:{orderBy:{createdAt:"desc"},take:20}}})}catch(e){throw console.error("Error fetching user:",e),e}}static async updateUserSavings(e,t){try{let r=await i.db.users.findUnique({where:{id:e}});if(!r)throw Error("User not found");let n=r.totalSaved+t,s=this.calculateUserTier(n),o=await i.db.users.update({where:{id:e},data:{totalSaved:n,tier:s,lastActiveAt:new Date}});return await this.recordActivity(e,a.ActivityType.SAVINGS_MILESTONE,`Saved $${t.toFixed(2)} in rebates`,{amount:t,newTotal:n}),s!==r.tier&&await this.recordActivity(e,a.ActivityType.TIER_UPGRADE,`Upgraded to ${s} tier`,{oldTier:r.tier,newTier:s}),o}catch(e){throw console.error("Error updating user savings:",e),e}}static calculateUserTier(e){return e>=1e4?a.UserTier.DIAMOND:e>=5e3?a.UserTier.PLATINUM:e>=2e3?a.UserTier.GOLD:e>=500?a.UserTier.SILVER:a.UserTier.BRONZE}static async recordActivity(e,t,r,a){try{return await i.db.userActivity.create({data:{userId:e,type:t,description:r,metadata:a?JSON.stringify(a):null,points:this.getActivityPoints(t)}})}catch(e){throw console.error("Error recording activity:",e),e}}static getActivityPoints(e){switch(e){case a.ActivityType.LOGIN:return 1;case a.ActivityType.REFERRAL:return 50;case a.ActivityType.SAVINGS_MILESTONE:return 10;case a.ActivityType.TIER_UPGRADE:return 100;case a.ActivityType.ACHIEVEMENT_UNLOCKED:return 25;case a.ActivityType.TRADING_VOLUME:return 5;case a.ActivityType.PAYOUT_RECEIVED:return 15;case a.ActivityType.STREAK_MILESTONE:return 20;default:return 0}}static async getWallOfFame(e=50){try{return(await i.db.users.findMany({where:{totalSaved:{gt:0}},orderBy:{totalSaved:"desc"},take:e,select:{id:!0,name:!0,totalSaved:!0,tier:!0,createdAt:!0,payouts:{select:{broker:!0,amount:!0,createdAt:!0},orderBy:{createdAt:"desc"},take:1}}})).map((e,t)=>({id:e.id,anonymousName:`Trader ${String.fromCharCode(65+t)}`,totalSavings:e.totalSaved,broker:e.payouts[0]?.broker||"Unknown",memberSince:e.createdAt.toISOString().split("T")[0],tier:e.tier,rank:t+1}))}catch(e){throw console.error("Error fetching Wall of Fame:",e),e}}static async getDashboardAnalytics(e){try{let t=await i.db.users.findUnique({where:{id:e},include:{payouts:{orderBy:{createdAt:"desc"},take:100},activities:{orderBy:{createdAt:"desc"},take:50},achievements:{include:{achievement:!0}}}});if(!t)throw Error("User not found");let r=t.payouts,a=r.reduce((e,t)=>e+t.tradingVolume,0),n=this.calculateMonthlySavings(r),s=this.calculateBrokerStats(r),o=this.calculateSavingsHistory(r);return{userData:{totalSavings:t.totalSaved,monthlySavings:n,totalVolume:a,memberSince:t.createdAt.toISOString().split("T")[0],rank:t.tier,nextRankProgress:this.calculateNextRankProgress(t.totalSaved,t.tier),referrals:t.referralCount,referralEarnings:47.5*t.referralCount},savingsHistory:o,brokerStats:s,achievements:t.achievements.map(e=>({id:e.achievement.id,title:e.achievement.title,description:e.achievement.description,icon:e.achievement.icon,unlocked:100===e.progress,date:e.unlockedAt.toISOString().split("T")[0],progress:e.progress}))}}catch(e){throw console.error("Error fetching dashboard analytics:",e),e}}static calculateMonthlySavings(e){let t=new Date().getMonth(),r=new Date().getFullYear();return e.filter(e=>{let i=new Date(e.createdAt);return i.getMonth()===t&&i.getFullYear()===r}).reduce((e,t)=>e+t.amount,0)}static calculateBrokerStats(e){let t=new Map;e.forEach(e=>{let r=t.get(e.broker)||{volume:0,savings:0};t.set(e.broker,{volume:r.volume+e.tradingVolume,savings:r.savings+e.amount})});let r=Array.from(t.values()).reduce((e,t)=>e+t.volume,0);return Array.from(t.entries()).map(([e,t])=>({broker:e,volume:t.volume,savings:t.savings,percentage:r>0?t.volume/r*100:0}))}static calculateSavingsHistory(e){let t=new Map;return e.forEach(e=>{let r=e.createdAt.toISOString().substring(0,7),i=t.get(r)||{savings:0,volume:0};t.set(r,{savings:i.savings+e.amount,volume:i.volume+e.tradingVolume})}),Array.from(t.entries()).sort((e,t)=>e[0].localeCompare(t[0])).slice(-12).map(([e,t])=>({month:e,savings:t.savings,volume:t.volume}))}static calculateNextRankProgress(e,t){let r={[a.UserTier.BRONZE]:500,[a.UserTier.SILVER]:2e3,[a.UserTier.GOLD]:5e3,[a.UserTier.PLATINUM]:1e4,[a.UserTier.DIAMOND]:1e4},i=r[t],n=r[this.getNextTier(t)];return t===a.UserTier.DIAMOND?100:Math.min(100,Math.max(0,(e-i)/(n-i)*100))}static getNextTier(e){switch(e){case a.UserTier.BRONZE:return a.UserTier.SILVER;case a.UserTier.SILVER:return a.UserTier.GOLD;case a.UserTier.GOLD:return a.UserTier.PLATINUM;case a.UserTier.PLATINUM:default:return a.UserTier.DIAMOND}}}},54732:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>u,serverHooks:()=>m,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>p});var i={};r.r(i),r.d(i,{POST:()=>d});var a=r(96559),n=r(48088),s=r(37719),o=r(32190),c=r(47228),l=r(71810);async function d(e){try{let{email:t,tradingVolume:r,preferredBroker:i,experience:a,referralSource:n,referralCode:s}=await e.json();if(!t||!r||!i)return o.NextResponse.json({error:"Missing required fields: email, tradingVolume, preferredBroker"},{status:400});let d=4e-4*parseFloat(r),u=.4*d*.1,g=t.split("@")[0],p=g.charAt(0).toUpperCase()+g.slice(1),m=await c.D.createOrUpdateUser({email:t,name:p,tradingVolume:r,preferredBroker:i,experience:a,referralSource:n,referralCode:s});console.log("New intake submission:",{...m,estimatedMonthlySavings:u}),m.referredBy&&await l.b.processReferral(m.referredBy,m.id);try{console.log("Welcome email sent successfully to:",t)}catch(e){console.error("Error sending welcome email:",e)}return await new Promise(e=>setTimeout(e,2e3)),o.NextResponse.json({success:!0,userId:m.id,estimatedMonthlySavings:u,message:"Application received. Our concierge team will contact you within 24 hours.",emailSent:!0,referralApplied:!!m.referredBy})}catch(e){return console.error("Intake form error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let u=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/submit-intake/route",pathname:"/api/submit-intake",filename:"route",bundlePath:"app/api/submit-intake/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/submit-intake/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:g,workUnitAsyncStorage:p,serverHooks:m}=u;function h(){return(0,s.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:p})}},55511:e=>{"use strict";e.exports=require("crypto")},59232:(e,t,r)=>{"use strict";let i,a;r.d(t,{Ak:()=>o});var n=r(55511);let s=e=>{!i||i.length<e?(i=Buffer.allocUnsafe(128*e),n.randomFillSync(i),a=0):a+e>i.length&&(n.randomFillSync(i),a=0),a+=e},o=(e=21)=>{s(e|=0);let t="";for(let r=a-e;r<a;r++)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&i[r]];return t}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},71810:(e,t,r)=>{"use strict";r.d(t,{b:()=>o});var i=r(5069),a=r(19089);let n=[{id:"first_savings",name:"first_savings",title:"Bắt đầu tiết kiệm",description:"Tiết kiệm được khoản đầu ti\xean của bạn",icon:"\uD83C\uDFAF",category:"SAVINGS",points:10,condition:{type:"savings",target:1,operator:">="}},{id:"savings_100",name:"savings_100",title:"Nh\xe0 tiết kiệm",description:"Tiết kiệm được 100 USD",icon:"\uD83D\uDCB0",category:"SAVINGS",points:50,condition:{type:"savings",target:100,operator:">="}},{id:"savings_500",name:"savings_500",title:"Chuy\xean gia tiết kiệm",description:"Tiết kiệm được 500 USD",icon:"\uD83D\uDC8E",category:"SAVINGS",points:200,condition:{type:"savings",target:500,operator:">="}},{id:"savings_1000",name:"savings_1000",title:"Bậc thầy tiết kiệm",description:"Tiết kiệm được 1,000 USD",icon:"\uD83D\uDC51",category:"SAVINGS",points:500,tier:"SILVER",condition:{type:"savings",target:1e3,operator:">="}},{id:"first_referral",name:"first_referral",title:"Người giới thiệu",description:"Giới thiệu th\xe0nh c\xf4ng người d\xf9ng đầu ti\xean",icon:"\uD83E\uDD1D",category:"REFERRALS",points:25,condition:{type:"referrals",target:1,operator:">="}},{id:"referrals_5",name:"referrals_5",title:"Người kết nối",description:"Giới thiệu th\xe0nh c\xf4ng 5 người d\xf9ng",icon:"\uD83C\uDF1F",category:"REFERRALS",points:100,condition:{type:"referrals",target:5,operator:">="}},{id:"referrals_10",name:"referrals_10",title:"Người dẫn dắt",description:"Giới thiệu th\xe0nh c\xf4ng 10 người d\xf9ng",icon:"\uD83D\uDE80",category:"REFERRALS",points:250,tier:"GOLD",condition:{type:"referrals",target:10,operator:">="}},{id:"streak_7",name:"streak_7",title:"Tuần lễ t\xedch cực",description:"Đăng nhập 7 ng\xe0y li\xean tiếp",icon:"\uD83D\uDD25",category:"ACTIVITY",points:30,condition:{type:"streak",target:7,operator:">="}},{id:"streak_30",name:"streak_30",title:"Th\xe1ng trung th\xe0nh",description:"Đăng nhập 30 ng\xe0y li\xean tiếp",icon:"\uD83D\uDCAA",category:"ACTIVITY",points:150,tier:"SILVER",condition:{type:"streak",target:30,operator:">="}},{id:"volume_100k",name:"volume_100k",title:"Nh\xe0 giao dịch t\xedch cực",description:"Khối lượng giao dịch 100,000 USD",icon:"\uD83D\uDCC8",category:"TRADING",points:40,condition:{type:"trading_volume",target:1e5,operator:">="}},{id:"volume_1m",name:"volume_1m",title:"Nh\xe0 giao dịch chuy\xean nghiệp",description:"Khối lượng giao dịch 1,000,000 USD",icon:"\uD83D\uDCCA",category:"TRADING",points:200,tier:"GOLD",condition:{type:"trading_volume",target:1e6,operator:">="}}],s={BRONZE:0,SILVER:500,GOLD:1500,PLATINUM:3e3,DIAMOND:5e3};class o{static async initializeAchievements(){for(let e of n)await i.db.achievement.upsert({where:{name:e.name},update:{title:e.title,description:e.description,icon:e.icon,category:e.category,points:e.points,tier:e.tier,condition:JSON.stringify(e.condition)},create:{name:e.name,title:e.title,description:e.description,icon:e.icon,category:e.category,points:e.points,tier:e.tier,condition:JSON.stringify(e.condition)}})}static async checkAchievements(e){let t=await i.db.users.findUnique({where:{id:e},include:{achievements:{include:{achievement:!0}}}});if(!t)return;let r=t.achievements.map(e=>e.achievementId);for(let a of(await i.db.achievement.findMany({where:{isActive:!0,id:{notIn:r}}}))){let r=JSON.parse(a.condition);await this.checkCondition(t,r)&&await this.unlockAchievement(e,a.id)}}static async checkCondition(e,t){let{type:r,target:i,operator:a=">="}=t,n=0;switch(r){case"savings":n=e.totalSaved||0;break;case"referrals":n=e.referralCount||0;break;case"streak":n=e.streak||0;break;case"trading_volume":n=e.tradingVolume||0;break;default:return!1}switch(a){case">":return n>i;case">=":default:return n>=i;case"=":return n===i;case"<=":return n<=i}}static async unlockAchievement(e,t){let r=await i.db.achievement.findUnique({where:{id:t}});if(r){await i.db.userAchievement.create({data:{userId:e,achievementId:t,unlockedAt:new Date,progress:100,pointsAwarded:r.points}}),await i.db.users.update({where:{id:e},data:{points:{increment:r.points},badgeCount:{increment:1}}}),await this.logActivity(e,"ACHIEVEMENT_UNLOCKED",`Mở th\xe0nh tựu: ${r.title}`,{achievementId:t,points:r.points},r.points);try{await a.h.onAchievementUnlocked(e,r.title,r.points)}catch(e){console.error("Failed to send achievement email:",e)}await this.checkTierUpgrade(e)}}static async checkTierUpgrade(e){let t=await i.db.users.findUnique({where:{id:e}});if(!t)return;let r=t.tier;if(t.points>=s.DIAMOND?r="DIAMOND":t.points>=s.PLATINUM?r="PLATINUM":t.points>=s.GOLD?r="GOLD":t.points>=s.SILVER&&(r="SILVER"),r!==t.tier){await i.db.users.update({where:{id:e},data:{tier:r}}),await this.logActivity(e,"TIER_UPGRADE",`N\xe2ng cấp l\xean hạng: ${r}`,{oldTier:t.tier,newTier:r},100);try{await a.h.onTierUpgrade(e,r)}catch(e){console.error("Failed to send tier upgrade email:",e)}}}static async logActivity(e,t,r,a,n){await i.db.userActivity.create({data:{userId:e,type:t,description:r,metadata:a?JSON.stringify(a):null,points:n||0}}),n&&n>0&&await i.db.users.update({where:{id:e},data:{points:{increment:n},lastActiveAt:new Date}})}static async updateActivityStreak(e){let t=await i.db.users.findUnique({where:{id:e}});if(!t)return;let r=new Date,a=t.lastActiveAt?new Date(t.lastActiveAt):null,n=a&&r.getDate()===a.getDate()+1&&r.getMonth()===a.getMonth()&&r.getFullYear()===a.getFullYear(),s=1;if(n)s=(t.streak||0)+1;else if(a&&r.toDateString()===a.toDateString())return;await i.db.users.update({where:{id:e},data:{streak:s,lastActiveAt:r}}),await this.logActivity(e,"LOGIN","Đăng nhập h\xe0ng ng\xe0y",{streak:s},5),await this.checkAchievements(e)}static async getUserGamification(e){let t=await i.db.users.findUnique({where:{id:e},include:{achievements:{include:{achievement:!0},orderBy:{unlockedAt:"desc"}},activities:{orderBy:{createdAt:"desc"},take:10},referredUsers:{select:{id:!0,createdAt:!0}}}});if(!t)return null;let r=s[t.tier],a=Object.entries(s).sort(([,e],[,t])=>e-t),n=a.findIndex(([e])=>e===t.tier),o=a[n+1],c=o?o[1]:null,l=c?(t.points-r)/(c-r)*100:100;return{user:{id:t.id,name:t.name,email:t.email,image:t.image,tier:t.tier,points:t.points,totalSaved:t.totalSaved,referralCount:t.referralCount,streak:t.streak,badgeCount:t.badgeCount,lastActiveAt:t.lastActiveAt},achievements:t.achievements,recentActivities:t.activities,referrals:t.referredUsers,tierProgress:{currentTier:t.tier,nextTier:o?o[0]:null,currentPoints:t.points,currentThreshold:r,nextThreshold:c,progressPercentage:Math.min(l,100)}}}static async processReferral(e,t){let r=await i.db.users.findUnique({where:{id:t},select:{name:!0,email:!0}});if(await i.db.users.update({where:{id:e},data:{referralCount:{increment:1}}}),await this.logActivity(e,"REFERRAL","Giới thiệu th\xe0nh c\xf4ng người d\xf9ng mới",{referredUserId:t},50),r)try{await a.h.onReferralSuccess(e,r.name||r.email?.split("@")[0]||"Anonymous")}catch(e){console.error("Failed to send referral success email:",e)}await this.checkAchievements(e)}static async updateSavings(e,t){await i.db.users.update({where:{id:e},data:{totalSaved:{increment:t}}}),await this.logActivity(e,"SAVINGS_MILESTONE",`Tiết kiệm th\xeam $${t.toFixed(2)}`,{amount:t},Math.floor(t/10)),await this.checkAchievements(e)}}},78335:()=>{},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[7719,580],()=>r(54732));module.exports=i})();