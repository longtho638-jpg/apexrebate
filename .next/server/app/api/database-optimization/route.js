(()=>{var e={};e.id=7449,e.ids=[5069,7449],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,s)=>{"use strict";s.d(t,{db:()=>r,prisma:()=>n});var a=s(96330);let r=globalThis.prisma??new a.PrismaClient({log:["query"]}),n=r},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,t,s)=>{"use strict";s.d(t,{N:()=>c});var a=s(60890),r=s(13581),n=s(36344),i=s(5069),o=s(85663);let c={adapter:(0,a.y)(i.db),providers:[...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,n.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[],(0,r.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await i.db.users.findUnique({where:{email:e.email}});return t&&t.password&&await o.Ay.compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"}}},13581:(e,t)=>{"use strict";t.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},36344:(e,t)=>{"use strict";t.A=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},60890:(e,t)=>{"use strict";t.y=void 0,t.y=function(e){return{createUser:t=>e.user.create({data:t}),getUser:t=>e.user.findUnique({where:{id:t}}),getUserByEmail:t=>e.user.findUnique({where:{email:t}}),async getUserByAccount(t){var s;let a=await e.account.findUnique({where:{provider_providerAccountId:t},select:{user:!0}});return null!=(s=null==a?void 0:a.user)?s:null},updateUser:({id:t,...s})=>e.user.update({where:{id:t},data:s}),deleteUser:t=>e.user.delete({where:{id:t}}),linkAccount:t=>e.account.create({data:t}),unlinkAccount:t=>e.account.delete({where:{provider_providerAccountId:t}}),async getSessionAndUser(t){let s=await e.session.findUnique({where:{sessionToken:t},include:{user:!0}});if(!s)return null;let{user:a,...r}=s;return{user:a,session:r}},createSession:t=>e.session.create({data:t}),updateSession:t=>e.session.update({where:{sessionToken:t.sessionToken},data:t}),deleteSession:t=>e.session.delete({where:{sessionToken:t}}),async createVerificationToken(t){let s=await e.verificationToken.create({data:t});return s.id&&delete s.id,s},async useVerificationToken(t){try{let s=await e.verificationToken.delete({where:{identifier_token:t}});return s.id&&delete s.id,s}catch(e){if("P2025"===e.code)return null;throw e}}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},88309:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>v,routeModule:()=>T,serverHooks:()=>S,workAsyncStorage:()=>N,workUnitAsyncStorage:()=>O});var a={};s.r(a),s.d(a,{GET:()=>d,POST:()=>l});var r=s(96559),n=s(48088),i=s(37719),o=s(32190),c=s(19854),u=s(12909);async function d(e){try{let t=await (0,c.getServerSession)(u.N);if(t?.user?.role!=="ADMIN")return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:s}=new URL(e.url);switch(s.get("action")){case"metrics":return await p();case"performance":return await m();case"indexes":return await x();case"slow-queries":return await y();case"cache-stats":return await g();case"optimization-suggestions":return await h();default:return o.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return console.error("Database optimization API error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function l(e){try{let t=await (0,c.getServerSession)(u.N);if(t?.user?.role!=="ADMIN")return o.NextResponse.json({error:"Unauthorized"},{status:401});let s=await e.json(),{action:a}=s;switch(a){case"optimize-table":return await f(s.tableName);case"create-index":return await w(s.indexConfig);case"drop-index":return await E(s.indexName);case"analyze-query":return await I(s.query);case"clear-cache":return await R();case"update-statistics":return await _();default:return o.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return console.error("Database optimization POST error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function p(){let e=[{query:"SELECT * FROM users WHERE email = ?",executionTime:2.3,rowsAffected:1,timestamp:new Date,cacheHit:!0,indexes:["users_email_unique"]},{query:"SELECT * FROM payouts WHERE userId = ? AND status = ?",executionTime:15.7,rowsAffected:25,timestamp:new Date,cacheHit:!1,indexes:["payouts_userId_status_index"]},{query:"SELECT COUNT(*) FROM exchange_transactions WHERE createdAt > ?",executionTime:89.2,rowsAffected:1,timestamp:new Date,cacheHit:!1,indexes:["exchange_transactions_createdAt_index"]}];return o.NextResponse.json({metrics:e,totalQueries:e.length,averageExecutionTime:e.reduce((e,t)=>e+t.executionTime,0)/e.length})}async function m(){let e={totalQueries:15420,averageExecutionTime:12.5,slowQueries:[{query:"SELECT * FROM exchange_transactions WHERE accountId = ? ORDER BY timestamp DESC LIMIT 100",executionTime:234.5,rowsAffected:100,timestamp:new Date,cacheHit:!1,indexes:["exchange_transactions_accountId_timestamp_index"]},{query:"SELECT u.*, COUNT(p.id) as payout_count FROM users u LEFT JOIN payouts p ON u.id = p.userId GROUP BY u.id",executionTime:189.3,rowsAffected:5230,timestamp:new Date,cacheHit:!1,indexes:["users_primary_key","payouts_userId_index"]}],cacheHitRate:78.5,indexUsage:{users_email_unique:2450,payouts_userId_status_index:1890,exchange_transactions_accountId_index:1230,exchange_transactions_createdAt_index:890},recommendations:["为 exchange_transactions 表添加复合索引 (accountId, timestamp)","优化用户查询的分页逻辑，避免 OFFSET","考虑对历史数据进行分区","增加查询结果缓存"]};return o.NextResponse.json(e)}async function x(){let e=[{tableName:"users",indexName:"users_email_unique",columns:["email"],usage:2450,efficiency:95.2,recommendation:"keep"},{tableName:"exchange_transactions",indexName:"exchange_transactions_accountId_index",columns:["accountId"],usage:1230,efficiency:67.8,recommendation:"optimize"},{tableName:"payouts",indexName:"payouts_createdAt_index",columns:["createdAt"],usage:45,efficiency:12.3,recommendation:"drop"},{tableName:"exchange_transactions",indexName:"exchange_transactions_accountId_timestamp_index",columns:["accountId","timestamp"],usage:0,efficiency:0,recommendation:"create"}];return o.NextResponse.json({analysis:e,totalIndexes:e.length,efficientIndexes:e.filter(e=>e.efficiency>80).length,inefficientIndexes:e.filter(e=>e.efficiency<50).length})}async function y(){let e=[{id:"1",query:"SELECT * FROM exchange_transactions WHERE accountId = ? ORDER BY timestamp DESC LIMIT 100",executionTime:234.5,frequency:45,impact:"high",suggestion:"Add composite index on (accountId, timestamp)",lastSeen:new Date},{id:"2",query:"SELECT u.*, COUNT(p.id) as payout_count FROM users u LEFT JOIN payouts p ON u.id = p.userId GROUP BY u.id",executionTime:189.3,frequency:23,impact:"medium",suggestion:"Consider materialized view or denormalization",lastSeen:new Date},{id:"3",query:"SELECT * FROM users WHERE name LIKE ? ORDER BY createdAt DESC LIMIT 50 OFFSET 1000",executionTime:156.7,frequency:67,impact:"high",suggestion:"Replace OFFSET with cursor-based pagination",lastSeen:new Date}];return o.NextResponse.json({slowQueries:e,total:e.length,highImpact:e.filter(e=>"high"===e.impact).length})}async function g(){return o.NextResponse.json({queryCache:{hitRate:78.5,missRate:21.5,size:256,maxSize:512,evictions:1240},resultCache:{hitRate:65.2,missRate:34.8,size:128,maxSize:256,evictions:890},metadata:{totalCacheHits:45670,totalCacheMisses:12340,memoryUsage:384,memoryLimit:1024}})}async function h(){let e=[{category:"Indexing",priority:"high",title:"添加复合索引",description:"为 exchange_transactions 表添加 (accountId, timestamp) 复合索引",estimatedImprovement:"85%",implementation:"CREATE INDEX idx_account_timestamp ON exchange_transactions(accountId, timestamp);"},{category:"Query Optimization",priority:"high",title:"优化分页查询",description:"将 OFFSET 分页替换为基于游标的分页",estimatedImprovement:"60%",implementation:"使用 WHERE id > last_id ORDER BY id LIMIT 50 替代 OFFSET"},{category:"Caching",priority:"medium",title:"增加查询缓存",description:"为频繁执行的报表查询添加缓存",estimatedImprovement:"45%",implementation:"配置 Redis 缓存层，TTL 设置为 5 分钟"},{category:"Table Partitioning",priority:"medium",title:"分区历史数据",description:"按月份分区 exchange_transactions 表",estimatedImprovement:"30%",implementation:"使用 PARTITION BY RANGE (createdAt) 进行分区"},{category:"Schema Optimization",priority:"low",title:"删除无用索引",description:"删除使用率低于 10% 的索引",estimatedImprovement:"15%",implementation:"DROP INDEX payouts_createdAt_index;"}];return o.NextResponse.json({suggestions:e,total:e.length,highPriority:e.filter(e=>"high"===e.priority).length})}async function f(e){let t={tableName:e,status:"completed",duration:2.3,spaceSaved:156.7,fragmentationBefore:23.5,fragmentationAfter:2.1,completedAt:new Date};return o.NextResponse.json({success:!0,result:t,message:`Table ${e} optimized successfully`})}async function w(e){let{tableName:t,columns:s,indexName:a,unique:r=!1}=e,n={indexName:a||`idx_${t}_${s.join("_")}`,tableName:t,columns:s,unique:r,status:"created",duration:.8,size:12.5,createdAt:new Date};return o.NextResponse.json({success:!0,result:n,message:`Index ${n.indexName} created successfully`})}async function E(e){let t={indexName:e,status:"dropped",duration:.3,spaceSaved:8.7,droppedAt:new Date};return o.NextResponse.json({success:!0,result:t,message:`Index ${e} dropped successfully`})}async function I(e){return o.NextResponse.json({success:!0,analysis:{query:e,executionPlan:{cost:234.5,rows:1250,width:156,operations:[{type:"Index Scan",table:"users",cost:12.3},{type:"Hash Join",table:"payouts",cost:189.7},{type:"Sort",cost:32.5}]},suggestions:["Consider adding index on payouts.userId","Query can benefit from LIMIT clause","Consider using EXISTS instead of JOIN for existence check"],estimatedImprovement:"45%",alternativeQueries:["SELECT u.* FROM users u WHERE EXISTS (SELECT 1 FROM payouts p WHERE p.userId = u.id)","SELECT u.* FROM users u INNER JOIN payouts p ON u.id = p.userId WHERE p.status = ?"]},message:"Query analysis completed"})}async function R(){let e={cacheType:"query",entriesCleared:1250,memoryFreed:256,duration:.2,clearedAt:new Date};return o.NextResponse.json({success:!0,result:e,message:"Query cache cleared successfully"})}async function _(){let e={tablesUpdated:["users","payouts","exchange_transactions"],duration:3.7,statisticsGenerated:{users:{rowCount:5230,distinctValues:{email:5230,role:3}},payouts:{rowCount:15670,distinctValues:{status:3,broker:5}},exchange_transactions:{rowCount:892340,distinctValues:{symbol:125,accountId:890}}},updatedAt:new Date};return o.NextResponse.json({success:!0,result:e,message:"Table statistics updated successfully"})}let T=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/database-optimization/route",pathname:"/api/database-optimization",filename:"route",bundlePath:"app/api/database-optimization/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/database-optimization/route.ts",nextConfigOutput:"standalone",userland:a}),{workAsyncStorage:N,workUnitAsyncStorage:O,serverHooks:S}=T;function v(){return(0,i.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:O})}},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[7719,580,4999,8044,9854],()=>s(88309));module.exports=a})();