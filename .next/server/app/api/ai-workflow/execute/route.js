(()=>{var e={};e.id=1426,e.ids=[1426],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34863:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>j,routeModule:()=>k,serverHooks:()=>$,workAsyncStorage:()=>P,workUnitAsyncStorage:()=>M});var s={};r.r(s),r.d(s,{GET:()=>l,POST:()=>c});var n=r(96559),a=r(48088),o=r(37719),i=r(32190);let u=new Map;async function c(e){try{let t=await e.json();if(!t.name||!t.steps||!Array.isArray(t.steps))return i.NextResponse.json({error:"工作流数据无效"},{status:400});let r=`exec-${Date.now()}`,s={id:r,name:t.name,description:t.description||"",steps:t.steps,status:"pending",results:{},logs:[]};return u.set(r,s),d(r),i.NextResponse.json({success:!0,executionId:r,message:"工作流已开始执行",status:"pending"})}catch(e){return console.error("工作流执行API错误:",e),i.NextResponse.json({error:"服务器内部错误"},{status:500})}}async function l(e){try{let{searchParams:t}=new URL(e.url),r=t.get("executionId");if(!r)return i.NextResponse.json({error:"缺少执行ID"},{status:400});let s=u.get(r);if(!s)return i.NextResponse.json({error:"执行记录不存在"},{status:404});return i.NextResponse.json({success:!0,data:s})}catch(e){return console.error("获取执行状态API错误:",e),i.NextResponse.json({error:"服务器内部错误"},{status:500})}}async function d(e){let t=u.get(e);if(t)try{for(let r of(t.status="running",t.startTime=new Date,y(e,"info","工作流开始执行"),function(e){let t=[],r=new Set,s=new Set;for(let n of e)!function n(a){if(s.has(a))throw Error(`检测到循环依赖: ${a}`);if(r.has(a))return;s.add(a);let o=e.find(e=>e.id===a);if(o)for(let e of o.dependencies)n(e);s.delete(a),r.add(a),t.push(a)}(n.id);return t}(t.steps))){let s=t.steps.find(e=>e.id===r);if(s)try{await p(e,s)}catch(n){let r=n instanceof Error?n.message:String(n);y(e,"error",`步骤 ${s.name} 执行失败`,{error:r}),s.status="error",t.status="failed",t.endTime=new Date;return}}t.status="completed",t.endTime=new Date,y(e,"info","工作流执行完成")}catch(r){t.status="failed",t.endTime=new Date,y(e,"error","工作流执行失败",{error:r instanceof Error?r.message:String(r)})}}async function p(e,t){if(!u.get(e))throw Error("执行记录不存在");t.status="running",y(e,"info",`开始执行步骤: ${t.name}`);try{switch(t.type){case"api":await f(e,t);break;case"data":await m(e,t);break;case"notification":await w(e,t);break;case"calculation":await g(e,t);break;case"validation":await h(e,t);break;case"cleanup":await x(e,t);break;default:throw Error(`未知的步骤类型: ${t.type}`)}t.status="completed",y(e,"info",`步骤完成: ${t.name}`)}catch(e){throw t.status="error",e}}async function f(e,t){let{url:r,method:s="GET",headers:n={},body:a}=t.config;y(e,"info",`调用API: ${s} ${r}`),await new Promise(e=>setTimeout(e,1e3));let o={status:"success",data:{message:"API调用成功",timestamp:new Date().toISOString()}},i=u.get(e);i&&(i.results[t.id]=o),y(e,"info","API调用成功",o)}async function m(e,t){let{operation:r,source:s,target:n}=t.config;y(e,"info",`执行数据操作: ${r}`),await new Promise(e=>setTimeout(e,800));let a={processed:!0,records:Math.floor(1e3*Math.random())+100,operation:r},o=u.get(e);o&&(o.results[t.id]=a),y(e,"info","数据处理完成",a)}async function w(e,t){let{type:r,recipients:s,message:n,template:a}=t.config;y(e,"info",`发送${r}通知给 ${s?.length||0} 个接收者`),await new Promise(e=>setTimeout(e,500));let o={sent:!0,recipients:s?.length||0,type:r,messageId:`msg-${Date.now()}`},i=u.get(e);i&&(i.results[t.id]=o),y(e,"info","通知发送成功",o)}async function g(e,t){let{formula:r,variables:s}=t.config;y(e,"info",`执行计算: ${r}`),await new Promise(e=>setTimeout(e,300));let n={formula:r,result:Math.floor(1e4*Math.random())+1e3,variables:s,timestamp:new Date().toISOString()},a=u.get(e);a&&(a.results[t.id]=n),y(e,"info","计算完成",n)}async function h(e,t){let{rules:r,data:s}=t.config;y(e,"info",`执行验证: ${r?.length||0} 条规则`),await new Promise(e=>setTimeout(e,200));let n={valid:Math.random()>.2,rules:r?.length||0,passed:Math.floor(Math.random()*(r?.length||5))+1,failed:+(Math.random()>.8)},a=u.get(e);a&&(a.results[t.id]=n),y(e,"info","验证完成",n)}async function x(e,t){let{target:r,policy:s}=t.config;y(e,"info",`执行清理: ${r}`),await new Promise(e=>setTimeout(e,400));let n={cleaned:!0,target:r,policy:s,items:Math.floor(100*Math.random())+10,space:`${Math.floor(100*Math.random())+10}MB`},a=u.get(e);a&&(a.results[t.id]=n),y(e,"info","清理完成",n)}function y(e,t,r,s){let n=u.get(e);n&&n.logs.push({stepId:"system",timestamp:new Date,level:t,message:r,data:s})}let k=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/ai-workflow/execute/route",pathname:"/api/ai-workflow/execute",filename:"route",bundlePath:"app/api/ai-workflow/execute/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/ai-workflow/execute/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:P,workUnitAsyncStorage:M,serverHooks:$}=k;function j(){return(0,o.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:M})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[7719,580],()=>r(34863));module.exports=s})();