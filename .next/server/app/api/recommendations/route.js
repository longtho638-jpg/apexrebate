(()=>{var e={};e.id=2630,e.ids=[2630,5069],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,r)=>{"use strict";r.d(t,{db:()=>i,prisma:()=>n});var a=r(96330);let i=globalThis.prisma??new a.PrismaClient({log:["query"]}),n=i},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,t,r)=>{"use strict";r.d(t,{N:()=>c});var a=r(60890),i=r(13581),n=r(36344),s=r(5069),o=r(85663);let c={adapter:(0,a.y)(s.db),providers:[...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,n.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[],(0,i.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await s.db.users.findUnique({where:{email:e.email}});return t&&t.password&&await o.Ay.compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"}}},13581:(e,t)=>{"use strict";t.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},36344:(e,t)=>{"use strict";t.A=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},60890:(e,t)=>{"use strict";t.y=void 0,t.y=function(e){return{createUser:t=>e.user.create({data:t}),getUser:t=>e.user.findUnique({where:{id:t}}),getUserByEmail:t=>e.user.findUnique({where:{email:t}}),async getUserByAccount(t){var r;let a=await e.account.findUnique({where:{provider_providerAccountId:t},select:{user:!0}});return null!=(r=null==a?void 0:a.user)?r:null},updateUser:({id:t,...r})=>e.user.update({where:{id:t},data:r}),deleteUser:t=>e.user.delete({where:{id:t}}),linkAccount:t=>e.account.create({data:t}),unlinkAccount:t=>e.account.delete({where:{provider_providerAccountId:t}}),async getSessionAndUser(t){let r=await e.session.findUnique({where:{sessionToken:t},include:{user:!0}});if(!r)return null;let{user:a,...i}=r;return{user:a,session:i}},createSession:t=>e.session.create({data:t}),updateSession:t=>e.session.update({where:{sessionToken:t.sessionToken},data:t}),deleteSession:t=>e.session.delete({where:{sessionToken:t}}),async createVerificationToken(t){let r=await e.verificationToken.create({data:t});return r.id&&delete r.id,r},async useVerificationToken(t){try{let r=await e.verificationToken.delete({where:{identifier_token:t}});return r.id&&delete r.id,r}catch(e){if("P2025"===e.code)return null;throw e}}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},80130:(e,t,r)=>{"use strict";r.d(t,{vF:()=>c});var a=r(33873),i=r.n(a),n=r(29021),s=r.n(n);let o=i().join(process.cwd(),"logs");s().existsSync(o)||s().mkdirSync(o,{recursive:!0});let c=(()=>{let e=(e,t,r)=>{let a=JSON.stringify({timestamp:new Date().toISOString(),level:e,message:t,...r&&{meta:r}})+"\n",n=i().join(o,"combined.log");try{s().appendFileSync(n,a)}catch(e){console.error("Failed to write to log file:",e)}};return{error:(t,r)=>e("error",t,r),warn:(t,r)=>e("warn",t,r),info:(t,r)=>e("info",t,r),http:(t,r)=>e("http",t,r),debug:(t,r)=>e("debug",t,r)}})();setInterval(()=>{let e=Date.now();s().readdir(o,(t,r)=>{if(t)return void c.error("Failed to read logs directory",{error:t.message});r.forEach(t=>{let r=i().join(o,t);s().stat(r,(a,i)=>{if(a)return void c.error("Failed to get file stats",{file:t,error:a.message});e-i.mtime.getTime()>2592e6&&s().unlink(r,e=>{e?c.error("Failed to delete old log file",{file:t,error:e.message}):c.info("Deleted old log file",{file:t})})})})})},864e5)},81630:e=>{"use strict";e.exports=require("http")},85967:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>f,serverHooks:()=>v,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{GET:()=>g,POST:()=>h});var i=r(96559),n=r(48088),s=r(37719),o=r(32190),c=r(80130),d=r(5069);class l{constructor(e){this.userBehaviors=new Map,this.userPreferences=new Map,this.recommendations=new Map,this.config=e,this.initializeEngine()}async initializeEngine(){try{await this.loadHistoricalData(),this.startPeriodicUpdates(),c.vF.info("AI Recommendation Engine initialized",{enabled:this.config.enabled,maxRecommendations:this.config.maxRecommendations})}catch(e){c.vF.error("Failed to initialize AI Recommendation Engine",{error:e instanceof Error?e.message:String(e)})}}async loadHistoricalData(){try{let e=await d.db.userBehavior.findMany({orderBy:{timestamp:"desc"},take:1e4});e.forEach(e=>{let t=e.userId;this.userBehaviors.has(t)||this.userBehaviors.set(t,[]),this.userBehaviors.get(t).push({userId:e.userId,action:e.action,target:e.target,timestamp:e.timestamp,duration:e.duration||void 0,metadata:e.metadata||void 0})});let t=await d.db.userPreference.findMany();t.forEach(e=>{let t=e.userId;this.userPreferences.has(t)||this.userPreferences.set(t,[]),this.userPreferences.get(t).push({userId:e.userId,category:e.category,score:e.score,lastUpdated:e.lastUpdated})}),c.vF.info("Historical data loaded",{behaviorCount:e.length,preferenceCount:t.length,userCount:this.userBehaviors.size})}catch(e){c.vF.error("Failed to load historical data",{error:e instanceof Error?e.message:String(e)})}}async recordBehavior(e){let t={...e,timestamp:new Date},r=e.userId;this.userBehaviors.has(r)||this.userBehaviors.set(r,[]),this.userBehaviors.get(r).push(t);try{await d.db.userBehavior.create({data:{userId:t.userId,action:t.action,target:t.target,timestamp:t.timestamp,duration:t.duration,metadata:t.metadata||{}}})}catch(e){c.vF.error("Failed to save user behavior",{error:e instanceof Error?e.message:String(e)})}await this.updateUserPreferences(r,t)}async updateUserPreferences(e,t){try{let r=this.extractCategory(t);if(!r)return;let a=this.userPreferences.get(e)||[],i=a.find(e=>e.category===r);i||(i={userId:e,category:r,score:0,lastUpdated:new Date},a.push(i),this.userPreferences.set(e,a));let n=this.config.behaviorWeight[t.action]||1,s=this.calculateTimeDecay(t.timestamp);i.score=Math.min(1,i.score+n*s*.1),i.lastUpdated=new Date,await d.db.userPreference.upsert({where:{userId_category:{userId:e,category:r}},update:{score:i.score,lastUpdated:i.lastUpdated},create:{userId:e,category:r,score:i.score,lastUpdated:i.lastUpdated}})}catch(e){c.vF.error("Failed to update user preferences",{error:e instanceof Error?e.message:String(e)})}}extractCategory(e){let{action:t,target:r,metadata:a}=e;return r.includes("dashboard")?"dashboard":r.includes("calculator")?"trading_tools":r.includes("analytics")?"analytics":r.includes("referrals")?"social":r.includes("apex-pro")?"premium_features":r.includes("hang-soi")?"community":r.includes("faq")?"help":r.includes("profile")?"account":a?.tradingPair?"trading":a?.exchange?"exchange_integration":a?.strategy?"trading_strategy":null}calculateTimeDecay(e){return Math.exp(-((new Date().getTime()-e.getTime())/36e5)/(24*this.config.decayFactor))}async generateRecommendations(e){if(!this.config.enabled)return[];try{let t=this.userBehaviors.get(e)||[],r=this.userPreferences.get(e)||[];if(0===t.length)return this.generateDefaultRecommendations(e);let a=[],i=await this.generatePreferenceBasedRecommendations(e,r);a.push(...i);let n=await this.generateCollaborativeRecommendations(e,t);a.push(...n);let s=await this.generateContentBasedRecommendations(e,t);a.push(...s);let o=await this.generateTrendingRecommendations(e);a.push(...o);let d=this.deduplicateRecommendations(a).filter(e=>e.confidence>=this.config.minConfidence).sort((e,t)=>t.confidence-e.confidence).slice(0,this.config.maxRecommendations);return this.recommendations.set(e,d),await this.saveRecommendations(e,d),c.vF.info("Recommendations generated",{userId:e,count:d.length,topRecommendation:d[0]?.title}),d}catch(t){return c.vF.error("Failed to generate recommendations",{userId:e,error:t instanceof Error?t.message:String(t)}),[]}}generateDefaultRecommendations(e){let t=new Date,r=new Date(t.getTime()+864e5);return[{id:`default-${e}-1`,userId:e,type:"feature",title:"开始使用费用计算器",description:"计算您的交易费用，了解可以节省多少成本",url:"/calculator",confidence:.8,reason:"新用户推荐功能",metadata:{priority:"high"},createdAt:t,expiresAt:r},{id:`default-${e}-2`,userId:e,type:"content",title:"了解ApexRebate运作方式",description:"学习如何最大化您的返利收益",url:"/how-it-works",confidence:.7,reason:"教育性内容推荐",metadata:{priority:"medium"},createdAt:t,expiresAt:r},{id:`default-${e}-3`,userId:e,type:"feature",title:"加入Hang S\xf3i社区",description:"与专业交易者交流学习",url:"/hang-soi",confidence:.6,reason:"社区功能推荐",metadata:{priority:"medium"},createdAt:t,expiresAt:r}]}async generatePreferenceBasedRecommendations(e,t){let r=[],a=new Date,i=new Date(a.getTime()+864e5);for(let e of t.sort((e,t)=>t.score-e.score).slice(0,3)){let t=await this.createRecommendationFromPreference(e,a,i);t&&r.push(t)}return r}async createRecommendationFromPreference(e,t,r){let{category:a,score:i}=e,n={dashboard:{type:"feature",title:"查看高级仪表板",description:"深入了解您的交易表现和费用分析",url:"/dashboard",confidence:.9*i,reason:"您经常查看仪表板数据",metadata:{category:a,source:"preference"}},trading_tools:{type:"feature",title:"使用高级交易工具",description:"优化您的交易策略，提高收益",url:"/calculator",confidence:.85*i,reason:"您对交易工具感兴趣",metadata:{category:a,source:"preference"}},analytics:{type:"feature",title:"深度数据分析",description:"发现交易模式，优化决策",url:"/analytics",confidence:.8*i,reason:"您喜欢分析交易数据",metadata:{category:a,source:"preference"}},premium_features:{type:"feature",title:"升级到ApexPro",description:"解锁专业级功能和分析工具",url:"/apex-pro",confidence:.75*i,reason:"您可能对高级功能感兴趣",metadata:{category:a,source:"preference"}},community:{type:"feature",title:"参与社区讨论",description:"与其他交易者分享经验和策略",url:"/hang-soi",confidence:.7*i,reason:"您对社区活动感兴趣",metadata:{category:a,source:"preference"}}}[a];return n?{id:`pref-${e.userId}-${a}-${Date.now()}`,userId:e.userId,...n,createdAt:t,expiresAt:r}:null}async generateCollaborativeRecommendations(e,t){let r=await this.findSimilarUsers(e,t),a=[];for(let t of r.slice(0,5)){let r=this.userBehaviors.get(t.userId)||[],i=await this.extractRecommendationsFromBehaviors(e,r,t.similarity);a.push(...i)}return a}async findSimilarUsers(e,t){let r=[];for(let[a,i]of this.userBehaviors.entries()){if(a===e)continue;let n=this.calculateUserSimilarity(t,i);n>.3&&r.push({userId:a,similarity:n})}return r.sort((e,t)=>t.similarity-e.similarity)}calculateUserSimilarity(e,t){let r=new Set(e.map(e=>e.target)),a=new Set(t.map(e=>e.target)),i=new Set([...r].filter(e=>a.has(e))),n=new Set([...r,...a]);return i.size/n.size}async extractRecommendationsFromBehaviors(e,t,r){let a=[],i=new Date,n=new Date(i.getTime()+864e5);for(let s of t.filter(e=>"trade"===e.action||"save"===e.action||"share"===e.action).slice(0,5)){let t=await this.createRecommendationFromBehavior(e,s,r,i,n);t&&a.push(t)}return a}async createRecommendationFromBehavior(e,t,r,a,i){return{id:`collab-${e}-${t.target}-${Date.now()}`,userId:e,type:"content",title:`探索 ${t.target}`,description:`与您相似的用户也在使用此功能`,url:t.target.startsWith("/")?t.target:void 0,confidence:.7*r,reason:"基于相似用户的行为推荐",metadata:{source:"collaborative",originalBehavior:t,similarity:r},createdAt:a,expiresAt:i}}async generateContentBasedRecommendations(e,t){let r=this.analyzeContentPreferences(t),a=[];for(let t of r){let r=await this.createContentRecommendation(e,t);r&&a.push(r)}return a}analyzeContentPreferences(e){let t={};for(let r of e){let e=this.extractContentType(r);e&&(t[e]=(t[e]||0)+1)}return Object.entries(t).map(([t,r])=>({type:t,score:r/e.length})).sort((e,t)=>t.score-e.score)}extractContentType(e){return e.target.includes("trading")?"trading_content":e.target.includes("analysis")?"analysis_content":e.target.includes("tutorial")?"tutorial_content":e.target.includes("strategy")?"strategy_content":null}async createContentRecommendation(e,t){let r=new Date,a=new Date(r.getTime()+864e5),i={trading_content:{type:"content",title:"高级交易策略指南",description:"学习专业交易者的策略和技巧",url:"/blog/advanced-trading-strategies",confidence:.8*t.score,reason:"基于您对交易内容的兴趣",metadata:{contentType:t.type,source:"content_based"}},analysis_content:{type:"content",title:"市场分析报告",description:"深入了解当前市场趋势和机会",url:"/blog/market-analysis",confidence:.75*t.score,reason:"基于您对分析内容的兴趣",metadata:{contentType:t.type,source:"content_based"}},tutorial_content:{type:"content",title:"新手入门教程",description:"从零开始学习交易基础",url:"/blog/getting-started",confidence:.7*t.score,reason:"基于您对教程内容的兴趣",metadata:{contentType:t.type,source:"content_based"}}}[t.type];return i?{id:`content-${e}-${t.type}-${Date.now()}`,userId:e,...i,createdAt:r,expiresAt:a}:null}async generateTrendingRecommendations(e){let t=await this.getTrendingItems(),r=[],a=new Date,i=new Date(a.getTime()+432e5);for(let n of t.slice(0,3))r.push({id:`trending-${e}-${n.id}-${Date.now()}`,userId:e,type:"content",title:n.title,description:n.description,url:n.url,confidence:.6*n.popularity,reason:"当前热门内容",metadata:{source:"trending",popularity:n.popularity,category:n.category},createdAt:a,expiresAt:i});return r}async getTrendingItems(){return[{id:"trend-1",title:"DeFi交易策略详解",description:"深入了解去中心化金融交易策略",url:"/blog/defi-trading-strategies",popularity:.9,category:"trading"},{id:"trend-2",title:"费用优化技巧",description:"学习如何最小化交易费用",url:"/blog/fee-optimization",popularity:.8,category:"trading_tools"},{id:"trend-3",title:"风险管理指南",description:"保护您的投资组合",url:"/blog/risk-management",popularity:.7,category:"education"}]}deduplicateRecommendations(e){let t=new Set,r=[];for(let a of e){let e=`${a.type}-${a.title}`;t.has(e)||(t.add(e),r.push(a))}return r}async saveRecommendations(e,t){try{for(let r of(await d.db.recommendation.deleteMany({where:{userId:e}}),t))await d.db.recommendation.create({data:{id:r.id,userId:r.userId,type:r.type,title:r.title,description:r.description,url:r.url,confidence:r.confidence,reason:r.reason,metadata:r.metadata,createdAt:r.createdAt,expiresAt:r.expiresAt}})}catch(e){c.vF.error("Failed to save recommendations",{error:e instanceof Error?e.message:String(e)})}}async getUserRecommendations(e){let t=this.recommendations.get(e);if(t&&t.length>0){let e=new Date,r=t.filter(t=>t.expiresAt>e);if(r.length>0)return r}return await this.generateRecommendations(e)}startPeriodicUpdates(){setInterval(async()=>{try{let e=Array.from(this.userBehaviors.keys());for(let t of e)await this.generateRecommendations(t);c.vF.info("Periodic recommendation update completed",{userCount:e.length})}catch(e){c.vF.error("Periodic recommendation update failed",{error:e instanceof Error?e.message:String(e)})}},60*this.config.refreshInterval*6e4)}updateConfig(e){this.config={...this.config,...e},c.vF.info("AI Recommendation Engine configuration updated",{config:this.config})}getStatus(){return{enabled:this.config.enabled,userCount:this.userBehaviors.size,totalRecommendations:Array.from(this.recommendations.values()).reduce((e,t)=>e+t.length,0),config:this.config}}}let u=new l({enabled:!0,maxRecommendations:5,refreshInterval:6,minConfidence:.3,behaviorWeight:{view:1,click:2,trade:5,analyze:3,save:4,share:4},decayFactor:7});var m=r(19854),p=r(12909);async function g(e){try{let t=await (0,m.getServerSession)(p.N);if(!t?.user?.id)return o.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=t.user.id,{searchParams:a}=new URL(e.url),i=a.get("type"),n=await u.getUserRecommendations(r),s=i?n.filter(e=>e.type===i):n;return o.NextResponse.json({success:!0,data:{recommendations:s,total:n.length,filtered:s.length,userId:r}})}catch(e){return console.error("Recommendations API error:",e),o.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to get recommendations"},{status:500})}}async function h(e){try{let t=await (0,m.getServerSession)(p.N);if(!t?.user?.id)return o.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=t.user.id,{action:a,target:i,duration:n,metadata:s}=await e.json();return await u.recordBehavior({userId:r,action:a,target:i,duration:n,metadata:s}),o.NextResponse.json({success:!0,data:{message:"Behavior recorded successfully",userId:r,action:a,target:i}})}catch(e){return console.error("Behavior recording API error:",e),o.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to record behavior"},{status:500})}}let f=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/recommendations/route",pathname:"/api/recommendations",filename:"route",bundlePath:"app/api/recommendations/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/recommendations/route.ts",nextConfigOutput:"standalone",userland:a}),{workAsyncStorage:y,workUnitAsyncStorage:w,serverHooks:v}=f;function x(){return(0,s.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:w})}},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[7719,580,4999,8044,9854],()=>r(85967));module.exports=a})();