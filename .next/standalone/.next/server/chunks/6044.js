exports.id=6044,exports.ids=[5069,6044],exports.modules={5069:(e,t,a)=>{"use strict";a.d(t,{db:()=>i,prisma:()=>r});var n=a(96330);let i=globalThis.prisma??new n.PrismaClient({log:["query"]}),r=i},13581:(e,t)=>{"use strict";t.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},21111:(e,t,a)=>{"use strict";a.d(t,{Z$:()=>i,ZM:()=>s,gm:()=>o});var n=a(5069),i=function(e){return e.WELCOME="welcome",e.PAYOUT_RECEIVED="payout_received",e.ACHIEVEMENT_UNLOCKED="achievement_unlocked",e.TIER_UPGRADE="tier_upgrade",e.REFERRAL_SUCCESS="referral_success",e.WEEKLY_DIGEST="weekly_digest",e.MONTHLY_REPORT="monthly_report",e.INACTIVITY_WARNING="inactivity_warning",e.MILESTONE_REACHED="milestone_reached",e.CONCIERGE_UPDATE="concierge_update",e}({});class r{constructor(){this.zai=null}static getInstance(){return r.instance||(r.instance=new r),r.instance}async initializeZAI(){try{let e=await a.e(7838).then(a.bind(a,87838));this.zai=await e.create(),console.log("Email service initialized with ZAI SDK")}catch(e){console.error("Failed to initialize ZAI SDK for email service:",e)}}async generateEmailContent(e,t){this.zai||await this.initializeZAI();let a={welcome:{subject:"Ch\xe0o m·ª´ng ƒë·∫øn v·ªõi ApexRebate - D·ªãch v·ª• Ho\xe0n ph\xed Concierge",context:"Generate a welcome email for a new trader who just joined ApexRebate"},payout_received:{subject:"ApexRebate: B·∫°n ƒë\xe3 nh·∫≠n ƒë∆∞·ª£c ho\xe0n ph\xed m·ªõi!",context:"Generate an email notification for a trader who received a new payout"},achievement_unlocked:{subject:"\uD83C\uDF89 Ch\xfac m·ª´ng! B·∫°n ƒë\xe3 m·ªü kh\xf3a th\xe0nh t·ª±u m·ªõi",context:"Generate an email to congratulate a trader on unlocking a new achievement"},tier_upgrade:{subject:"\uD83C\uDFC6 N\xe2ng c·∫•p th\xe0nh c\xf4ng! H·∫°ng m·ªõi c·ªßa b·∫°n t·∫°i ApexRebate",context:"Generate an email to congratulate a trader on upgrading to a new tier"},referral_success:{subject:"Tuy·ªát v·ªùi! L·ªùi gi·ªõi thi·ªáu c·ªßa b·∫°n ƒë\xe3 tham gia ApexRebate",context:"Generate an email to notify a trader that their referral was successful"},weekly_digest:{subject:"ApexRebate Weekly Digest - T·ªïng quan hi·ªáu su·∫•t c·ªßa b·∫°n",context:"Generate a weekly digest email with trading performance summary"},monthly_report:{subject:"ApexRebate Monthly Report - B\xe1o c\xe1o chi ti·∫øt th\xe1ng {month}",context:"Generate a comprehensive monthly report email"},inactivity_warning:{subject:"B·∫°n c\xf3 ·ªïn kh\xf4ng? Ch\xfang t\xf4i nh·ªõ b·∫°n t·∫°i ApexRebate",context:"Generate a gentle re-engagement email for inactive traders"},milestone_reached:{subject:"\uD83C\uDFAF C·ªôt m·ªëc ·∫•n t∆∞·ª£ng! Th\xe0nh t·ª±u c·ªßa b·∫°n t·∫°i ApexRebate",context:"Generate an email to celebrate reaching a significant milestone"},concierge_update:{subject:"C·∫≠p nh·∫≠t t·ª´ Concierge ApexRebate",context:"Generate a personalized update from the concierge service"}}[e];if(!a)throw Error(`Email type ${e} not supported`);try{let e=await this.zai.chat.completions.create({messages:[{role:"system",content:`You are a professional email writer for ApexRebate, a premium trading rebate service. 
            Write emails in Vietnamese that are:
            - Professional yet friendly
            - Data-driven and personalized
            - Motivational and encouraging
            - Clear and concise
            - Include specific numbers and metrics when provided
            
            The email should be well-structured with:
            1. Compelling subject line
            2. Personalized greeting
            3. Main content with specific data
            4. Call to action
            5. Professional closing`},{role:"user",content:`${a.context}
            
            User data: ${JSON.stringify(t,null,2)}
            
            Generate a complete email with subject and HTML content. The email should be engaging and personalized.`}],temperature:.7,max_tokens:1e3}),n=e.choices[0]?.message?.content||"";n.split("\n");let i=a.subject,r=n,o=n.match(/Subject[:\s]*(.+?)(?:\n|$)/i);o&&(i=o[1].trim(),r=n.replace(/Subject[:\s]*(.+?)(?:\n|$)/i,"").trim());let s=this.convertToHTML(r,t);return{subject:i,html:s,text:r.replace(/<[^>]*>/g,"")}}catch(a){return console.error("Failed to generate email content:",a),this.getFallbackTemplate(e,t)}}convertToHTML(e,t){let a=e.replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>");return`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ApexRebate</title>
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
          .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }
          .footer { text-align: center; margin-top: 30px; color: #666; font-size: 14px; }
          .btn { display: inline-block; background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 10px 0; }
          .metric { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
          .highlight { color: #007bff; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>üöÄ ApexRebate</h1>
            <p>D·ªãch v·ª• Ho\xe0n ph\xed Concierge cho Trader chuy\xean nghi·ªáp</p>
          </div>
          <div class="content">
            <p>${a}</p>
            ${this.generatePersonalizedContent(t)}
          </div>
          <div class="footer">
            <p>\xa9 2024 ApexRebate. All rights reserved.</p>
            <p>ƒê\xe2y l\xe0 email t·ª± ƒë·ªông. Vui l\xf2ng kh\xf4ng tr·∫£ l·ªùi email n\xe0y.</p>
          </div>
        </div>
      </body>
      </html>
    `}generatePersonalizedContent(e){let t="";return e.userName&&(t+=`<div class="metric"><strong>Ch\xe0o ${e.userName},</strong></div>`),e.payoutAmount&&(t+=`<div class="metric">
        <strong>Ho\xe0n ph\xed nh·∫≠n ƒë∆∞·ª£c:</strong> <span class="highlight">$${e.payoutAmount.toLocaleString()}</span>
      </div>`),e.totalSaved&&(t+=`<div class="metric">
        <strong>T·ªïng ƒë\xe3 ti·∫øt ki·ªám:</strong> <span class="highlight">$${e.totalSaved.toLocaleString()}</span>
      </div>`),e.currentTier&&(t+=`<div class="metric">
        <strong>H·∫°ng hi·ªán t·∫°i:</strong> <span class="highlight">${e.currentTier}</span>
      </div>`),e.achievementTitle&&(t+=`<div class="metric">
        <strong>Th\xe0nh t·ª±h m·ªõi:</strong> <span class="highlight">${e.achievementTitle}</span>
      </div>`),e.referralName&&(t+=`<div class="metric">
        <strong>L·ªùi gi·ªõi thi·ªáu th\xe0nh c\xf4ng:</strong> <span class="highlight">${e.referralName}</span>
      </div>`),t+=`
      <div style="text-align: center; margin: 30px 0;">
        <a href="${process.env.NEXT_PUBLIC_APP_URL}/dashboard" class="btn">
          Xem Dashboard
        </a>
      </div>
    `}getFallbackTemplate(e,t){let a={welcome:{subject:"Ch\xe0o m·ª´ng ƒë·∫øn v·ªõi ApexRebate!",html:`<p>Ch\xe0o m·ª´ng ${t.userName||"b·∫°n"} ƒë\xe3 tham gia ApexRebate!</p>
               <p>Ch\xfang t\xf4i r·∫•t vui ƒë∆∞·ª£c ƒë·ªìng h\xe0nh c\xf9ng b·∫°n tr\xean h\xe0nh tr\xecnh t·ªëi ∆∞u h\xf3a l·ª£i nhu·∫≠n giao d·ªãch.</p>`},payout_received:{subject:"B·∫°n ƒë\xe3 nh·∫≠n ƒë∆∞·ª£c ho\xe0n ph\xed m·ªõi!",html:`<p>Ch\xfac m·ª´ng! B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c ho\xe0n ph\xed <strong>$${t.payoutAmount||0}</strong>.</p>`},achievement_unlocked:{subject:"Ch\xfac m·ª´ng th\xe0nh t·ª±u m·ªõi!",html:`<p>Tuy·ªát v·ªùi! B·∫°n ƒë\xe3 m·ªü kh\xf3a th\xe0nh t·ª±h <strong>${t.achievementTitle||"m·ªõi"}</strong>.</p>`}}[e]||{subject:"Th\xf4ng b\xe1o t·ª´ ApexRebate",html:"<p>B·∫°n c\xf3 m·ªôt th\xf4ng b\xe1o m·ªõi t·ª´ ApexRebate.</p>"};return{subject:a.subject,html:this.convertToHTML(a.html,t)}}async createNotification(e,t,a,i,r){let o={id:`email_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userId:e,type:t,recipient:a,subject:"",content:"",data:i,status:"pending",createdAt:new Date,scheduledFor:r};try{await n.db.emailNotification.create({data:{id:o.id,userId:e,type:t,recipient:a,subject:o.subject,content:o.content,data:i?JSON.stringify(i):null,status:o.status,scheduledFor:r}})}catch(e){console.error("Failed to save email notification to database:",e)}return o}async sendEmail(e){try{let t=await this.generateEmailContent(e.type,e.data||{});return e.subject=t.subject,e.content=t.html,console.log("\uD83D\uDCE7 Sending email:",{to:e.recipient,subject:e.subject,type:e.type}),await new Promise(e=>setTimeout(e,1e3)),e.status="sent",e.sentAt=new Date,await n.db.emailNotification.update({where:{id:e.id},data:{subject:e.subject,content:e.content,status:"sent",sentAt:e.sentAt}}),console.log("‚úÖ Email sent successfully"),!0}catch(t){return console.error("Failed to send email:",t),e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",await n.db.emailNotification.update({where:{id:e.id},data:{status:"failed",error:e.error}}),!1}}async scheduleEmail(e,t,a,n,i){return this.createNotification(e,t,a,i,n)}async sendImmediateEmail(e,t,a,n){let i=await this.createNotification(e,t,a,n);return this.sendEmail(i)}async processPendingEmails(){try{let e=await n.db.emailNotification.findMany({where:{status:"pending",OR:[{scheduledFor:null},{scheduledFor:{lte:new Date}}]},orderBy:{createdAt:"asc"},take:50});for(let t of(console.log(`üìß Processing ${e.length} pending emails`),e)){let e={id:t.id,userId:t.userId,type:t.type,recipient:t.recipient,subject:t.subject,content:t.content,data:t.data?JSON.parse(t.data):void 0,status:t.status,createdAt:t.createdAt,sentAt:t.sentAt||void 0,error:t.error||void 0,scheduledFor:t.scheduledFor||void 0};await this.sendEmail(e)}}catch(e){console.error("Failed to process pending emails:",e)}}async getUserEmailPreferences(e){try{let t=await n.db.users.findUnique({where:{id:e},select:{email:!0,emailVerified:!0}});return{enabled:!!t?.emailVerified,email:t?.email}}catch(e){return console.error("Failed to get user email preferences:",e),{enabled:!1,email:null}}}async unsubscribeUser(e,t){console.log(`User ${e} unsubscribed from ${t||"all"} emails`)}}let o=r.getInstance();async function s(e,t,a,n){try{return console.log("\uD83D\uDCE7 Sending email:",{to:e,subject:t}),await new Promise(e=>setTimeout(e,1e3)),console.log("‚úÖ Email sent successfully"),!0}catch(e){return console.error("Failed to send email:",e),!1}}},36344:(e,t)=>{"use strict";t.A=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},59232:(e,t,a)=>{"use strict";let n,i;a.d(t,{Ak:()=>s});var r=a(55511);let o=e=>{!n||n.length<e?(n=Buffer.allocUnsafe(128*e),r.randomFillSync(n),i=0):i+e>n.length&&(r.randomFillSync(n),i=0),i+=e},s=(e=21)=>{o(e|=0);let t="";for(let a=i-e;a<i;a++)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[a]];return t}},60890:(e,t)=>{"use strict";t.y=void 0,t.y=function(e){return{createUser:t=>e.user.create({data:t}),getUser:t=>e.user.findUnique({where:{id:t}}),getUserByEmail:t=>e.user.findUnique({where:{email:t}}),async getUserByAccount(t){var a;let n=await e.account.findUnique({where:{provider_providerAccountId:t},select:{user:!0}});return null!=(a=null==n?void 0:n.user)?a:null},updateUser:({id:t,...a})=>e.user.update({where:{id:t},data:a}),deleteUser:t=>e.user.delete({where:{id:t}}),linkAccount:t=>e.account.create({data:t}),unlinkAccount:t=>e.account.delete({where:{provider_providerAccountId:t}}),async getSessionAndUser(t){let a=await e.session.findUnique({where:{sessionToken:t},include:{user:!0}});if(!a)return null;let{user:n,...i}=a;return{user:n,session:i}},createSession:t=>e.session.create({data:t}),updateSession:t=>e.session.update({where:{sessionToken:t.sessionToken},data:t}),deleteSession:t=>e.session.delete({where:{sessionToken:t}}),async createVerificationToken(t){let a=await e.verificationToken.create({data:t});return a.id&&delete a.id,a},async useVerificationToken(t){try{let a=await e.verificationToken.delete({where:{identifier_token:t}});return a.id&&delete a.id,a}catch(e){if("P2025"===e.code)return null;throw e}}}}},78335:()=>{},96487:()=>{},98808:(e,t,a)=>{"use strict";a.d(t,{A$:()=>m,fG:()=>g,kH:()=>h});var n=a(60890),i=a(13581),r=a(36344),o=a(5069),s=a(85663),c=a(59232),l=a(21111),d=a(55511),u=a.n(d);async function h(e){let t=await o.db.users.findUnique({where:{email:e}});if(!t||t.emailVerified)return{success:!1,error:"User not found or already verified"};let a=(0,c.Ak)(32),n=new Date(Date.now()+864e5);await o.db.verificationToken.create({data:{identifier:e,token:a,expires:n}});let i=`${process.env.NEXTAUTH_URL}/auth/verify-email?token=${a}`;return await (0,l.ZM)(e,"Verify your ApexRebate account",`Click here to verify your email: ${i}`,{name:t.name||"Trader",verificationUrl:i,expirationHours:24}),{success:!0}}async function m(e){let t=await o.db.verificationToken.findUnique({where:{token:e}});return!t||t.expires<new Date?{success:!1,error:"Invalid or expired token"}:(await o.db.users.update({where:{email:t.identifier},data:{emailVerified:new Date}}),await o.db.verificationToken.delete({where:{token:e}}),{success:!0})}async function p(e,t){let a=await o.db.users.findUnique({where:{id:e}});if(!a||!a.twoFactorSecret)return!1;let n=Math.floor(Date.now()/3e4);return t===function(e,t){let a=u().createHmac("sha1",e);a.update(Buffer.from(t.toString()));let n=a.digest(),i=15&n[n.length-1];return(((127&n[i])<<24|(255&n[i+1])<<16|(255&n[i+2])<<8|255&n[i+3])%1e6).toString().padStart(6,"0")}(a.twoFactorSecret,n)}async function g(e){let t=[],a=0;return e.length>=8?a+=1:t.push("Password must be at least 8 characters long"),/[A-Z]/.test(e)?a+=1:t.push("Include at least one uppercase letter"),/[a-z]/.test(e)?a+=1:t.push("Include at least one lowercase letter"),/\d/.test(e)?a+=1:t.push("Include at least one number"),/[!@#$%^&*(),.?":{}|<>]/.test(e)?a+=1:t.push("Include at least one special character"),{isValid:a>=4,score:a,feedback:t}}(0,n.y)(o.db),[...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,r.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[],(0,i.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"},twoFactorCode:{label:"2FA Code",type:"text",required:!1}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await o.db.users.findUnique({where:{email:e.email},include:{emailNotifications:!0}});if(!t||!t.password)return null;if(!t.emailVerified)throw Error("Please verify your email before signing in");if(!await s.Ay.compare(e.password,t.password))return null;if(t.twoFactorEnabled&&e.twoFactorCode){if(!await p(t.id,e.twoFactorCode))throw Error("Invalid two-factor code")}else if(t.twoFactorEnabled&&!e.twoFactorCode)throw Error("Two-factor code required");return await o.db.users.update({where:{id:t.id},data:{lastActiveAt:new Date}}),{id:t.id,email:t.email,name:t.name,role:t.role,emailVerified:t.emailVerified,twoFactorEnabled:t.twoFactorEnabled}}})]}};