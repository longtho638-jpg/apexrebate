(()=>{var e={};e.id=5227,e.ids=[5227],e.modules={1887:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>b,routeModule:()=>p,serverHooks:()=>y,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>m});var a={};s.r(a),s.d(a,{GET:()=>g});var i=s(96559),r=s(48088),n=s(37719),o=s(32190);class c{constructor(e){this.regions=new Map,this.healthChecks=new Map,this.routingTable=new Map,this.config=e,this.initializeRegions(),this.buildRoutingTable()}initializeRegions(){this.config.regions.forEach(e=>{this.regions.set(e.id,e),this.healthChecks.set(e.id,{regionId:e.id,status:"healthy",responseTime:0,errorRate:0,lastCheck:new Date,metrics:{cpu:0,memory:0,disk:0,network:0}})})}buildRoutingTable(){this.routingTable.clear(),this.routingTable.set("CN",["ap-northeast-1","ap-east-1"]),this.routingTable.set("JP",["ap-northeast-1"]),this.routingTable.set("KR",["ap-northeast-1"]),this.routingTable.set("SG",["ap-southeast-1"]),this.routingTable.set("IN",["ap-south-1"]),this.routingTable.set("TH",["ap-southeast-1"]),this.routingTable.set("VN",["ap-southeast-1"]),this.routingTable.set("GB",["eu-west-2"]),this.routingTable.set("DE",["eu-central-1"]),this.routingTable.set("FR",["eu-west-3"]),this.routingTable.set("NL",["eu-west-1"]),this.routingTable.set("IT",["eu-south-1"]),this.routingTable.set("ES",["eu-south-1"]),this.routingTable.set("US",["us-east-1","us-west-2"]),this.routingTable.set("CA",["ca-central-1"]),this.routingTable.set("MX",["us-east-1"]),this.routingTable.set("BR",["sa-east-1"]),this.routingTable.set("AR",["sa-east-1"]),this.routingTable.set("CL",["sa-east-1"]),this.routingTable.set("AU",["ap-southeast-2"]),this.routingTable.set("NZ",["ap-southeast-2"]),this.routingTable.set("ZA",["af-south-1"]),this.routingTable.set("NG",["eu-west-1"])}async getOptimalRegion(e){let t=e.country.toUpperCase(),s=(this.routingTable.get(t)||this.getFallbackRegions()).map(e=>this.regions.get(e)).filter(e=>e&&"active"===e.status&&this.healthChecks.get(e.id)?.status==="healthy");return 0===s.length?this.getHealthyRegion():this.selectRegionByStrategy(s,e)}selectRegionByStrategy(e,t){switch(this.config.loadBalancing.strategy){case"geographic":return this.selectByGeography(e,t);case"weighted":return this.selectByWeight(e);case"least-connections":return this.selectByLeastConnections(e);default:return this.selectRoundRobin(e)}}selectByGeography(e,t){let s=e[0],a=this.calculateDistance(t.latitude,t.longitude,s.location.latitude,s.location.longitude);for(let i=1;i<e.length;i++){let r=this.calculateDistance(t.latitude,t.longitude,e[i].location.latitude,e[i].location.longitude);r<a&&(a=r,s=e[i])}return s}selectByWeight(e){let t=this.config.loadBalancing.weights,s=Math.random()*e.reduce((e,s)=>e+(t[s.id]||1),0);for(let a of e)if((s-=t[a.id]||1)<=0)return a;return e[0]}selectByLeastConnections(e){return e.reduce((e,t)=>t.capacity.currentUsers<e.capacity.currentUsers?t:e)}selectRoundRobin(e){let t=Math.floor(Date.now()/1e3)%e.length;return e[t]}calculateDistance(e,t,s,a){let i=this.toRadians(s-e),r=this.toRadians(a-t),n=Math.sin(i/2)*Math.sin(i/2)+Math.cos(this.toRadians(e))*Math.cos(this.toRadians(s))*Math.sin(r/2)*Math.sin(r/2);return 2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n))*6371}toRadians(e){return Math.PI/180*e}getFallbackRegions(){return["us-east-1","eu-west-1","ap-southeast-1"]}getHealthyRegion(){for(let e of this.regions.values())if("active"===e.status&&this.healthChecks.get(e.id)?.status==="healthy")return e;return null}getRegion(e){return this.regions.get(e)}getAllRegions(){return Array.from(this.regions.values())}getHealthyRegions(){return this.getAllRegions().filter(e=>"active"===e.status&&this.healthChecks.get(e.id)?.status==="healthy")}updateHealthCheck(e,t){let s=this.healthChecks.get(e);s&&this.healthChecks.set(e,{...s,...t,lastCheck:new Date})}getHealthChecks(){return Array.from(this.healthChecks.values())}getRegionStats(){let e=this.getAllRegions(),t=this.getHealthChecks();return{total:e.length,active:e.filter(e=>"active"===e.status).length,healthy:t.filter(e=>"healthy"===e.status).length,totalUsers:e.reduce((e,t)=>e+t.capacity.currentUsers,0),averageLatency:t.reduce((e,t)=>e+t.responseTime,0)/t.length||0}}getConfig(){return this.config}updateConfig(e){this.config={...this.config,...e}}}class l{constructor(e){this.config=e,this.metrics=this.initializeMetrics(),this.lastUpdate=new Date}initializeMetrics(){return{requests:0,bandwidth:0,cacheHitRate:0,averageResponseTime:0,errorRate:0,topCountries:[],topPaths:[]}}getConfig(){return this.config}updateConfig(e){this.config={...this.config,...e}}addCacheRule(e){this.config.cacheRules.push(e)}removeCacheRule(e){let t=this.config.cacheRules.findIndex(t=>t.id===e);return t>-1&&(this.config.cacheRules.splice(t,1),!0)}updateCacheRule(e,t){let s=this.config.cacheRules.find(t=>t.id===e);return!!s&&(Object.assign(s,t),!0)}getCacheRules(){return this.config.cacheRules}getCacheRuleForPath(e){return this.config.cacheRules.filter(t=>this.pathMatches(e,t.path)).sort((e,t)=>t.path.length-e.path.length)[0]||null}pathMatches(e,t){if("*"===t)return!0;if(t.endsWith("*")){let s=t.slice(0,-1);return e.startsWith(s)}return e===t}async purgeCache(e){try{if("cloudflare"===this.config.provider)return await this.purgeCloudflareCache(e);if("aws-cloudfront"===this.config.provider)return await this.purgeCloudFrontCache(e);if("fastly"===this.config.provider)return await this.purgeFastlyCache(e);else if("akamai"===this.config.provider)return await this.purgeAkamaiCache(e);return!1}catch(e){return console.error("CDN缓存清除失败:",e),!1}}async purgeCloudflareCache(e){let t=await fetch(`https://api.cloudflare.com/client/v4/zones/${this.config.distributionId}/purge_cache`,{method:"POST",headers:{Authorization:`Bearer ${process.env.CLOUDFLARE_API_TOKEN}`,"Content-Type":"application/json"},body:JSON.stringify({files:e.invalidateAll?[]:e.urls,purge_everything:e.invalidateAll,tags:e.tags||[]})});return(await t.json()).success}async purgeCloudFrontCache(e){return console.log("CloudFront cache purge requested:",e),!0}async purgeFastlyCache(e){return(await fetch("https://api.fastly.com/purge",{method:"POST",headers:{"Fastly-Key":process.env.FASTLY_API_KEY,"Fastly-Soft-Purge":"1","Content-Type":"application/json"},body:JSON.stringify({purge:e.invalidateAll?"all":e.urls,headers:e.tags?{"Fastly-Key":e.tags}:void 0})})).ok}async purgeAkamaiCache(e){return console.log("Akamai缓存清除:",e),!0}async getMetrics(){try{if("cloudflare"===this.config.provider)return await this.getCloudflareMetrics();if("aws-cloudfront"===this.config.provider)return await this.getCloudFrontMetrics();if("fastly"===this.config.provider)return await this.getFastlyMetrics();else if("akamai"===this.config.provider)return await this.getAkamaiMetrics();return this.metrics}catch(e){return console.error("获取CDN指标失败:",e),this.metrics}}async getCloudflareMetrics(){let e=await fetch(`https://api.cloudflare.com/client/v4/zones/${this.config.distributionId}/analytics/dashboard?since=-24`,{headers:{Authorization:`Bearer ${process.env.CLOUDFLARE_API_TOKEN}`}}),t=await e.json();return{requests:t.result?.totals?.requests?.all||0,bandwidth:t.result?.totals?.bandwidth?.all||0,cacheHitRate:t.result?.totals?.cache_status?.hit||0,averageResponseTime:t.result?.totals?.response_time?.avg||0,errorRate:t.result?.totals?.requests["5xx"]||0,topCountries:[],topPaths:[]}}async getCloudFrontMetrics(){return console.log("CloudFront metrics requested"),this.metrics}async getFastlyMetrics(){let e=await fetch(`https://api.fastly.com/stats/usage?from=${Math.floor(Date.now()/1e3)-86400}&to=${Math.floor(Date.now()/1e3)}`,{headers:{"Fastly-Key":process.env.FASTLY_API_KEY}}),t=await e.json();return{requests:t.data?.requests||0,bandwidth:t.data?.bandwidth||0,cacheHitRate:t.data?.hit_ratio||0,averageResponseTime:this.metrics.averageResponseTime,errorRate:this.metrics.errorRate,topCountries:[],topPaths:[]}}async getAkamaiMetrics(){return this.metrics}async warmupCache(e){try{let t=e.map(e=>this.warmupUrl(e));return(await Promise.allSettled(t)).every(e=>"fulfilled"===e.status)}catch(e){return console.error("CDN缓存预热失败:",e),!1}}async warmupUrl(e){let t=await fetch(e,{method:"GET",headers:{"Cache-Control":"no-cache","User-Agent":"ApexRebate-Cache-Warmer/1.0"}});if(!t.ok)throw Error(`预热失败: ${e} - ${t.status}`)}setGeoRestrictions(e,t){this.config.geoRestrictions={enabled:!0,allowedCountries:e,blockedCountries:t}}isGeoAllowed(e){if(!this.config.geoRestrictions.enabled)return!0;let{allowedCountries:t,blockedCountries:s}=this.config.geoRestrictions;return!s.includes(e)&&(!(t.length>0)||!!t.includes(e))}addEdgeFunction(e){let t=this.getCacheRuleForPath(e.path);t&&(t.edgeFunctions=t.edgeFunctions||[],t.edgeFunctions.push(e))}getEdgeFunctions(){let e=[];return this.config.cacheRules.forEach(t=>{t.edgeFunctions&&e.push(...t.edgeFunctions)}),e}optimizeConfig(){this.optimizeCacheRules(),this.optimizeCompression(),this.optimizeSecurity()}optimizeCacheRules(){this.config.cacheRules.forEach(e=>{e.path.includes("/api/")?e.ttl=Math.min(e.ttl,300):e.path.includes("/static/")&&(e.ttl=Math.max(e.ttl,86400))})}optimizeCompression(){this.config.compression.mimeTypes.length||(this.config.compression.mimeTypes=["text/html","text/css","text/javascript","application/javascript","application/json","image/svg+xml"])}optimizeSecurity(){[{name:"X-Content-Type-Options",value:"nosniff",enabled:!0},{name:"X-Frame-Options",value:"DENY",enabled:!0},{name:"X-XSS-Protection",value:"1; mode=block",enabled:!0}].forEach(e=>{this.config.security.securityHeaders.find(t=>t.name===e.name)||this.config.security.securityHeaders.push(e)})}getConfigSummary(){return{provider:this.config.provider,domain:this.config.domain,cacheRules:this.config.cacheRules.length,edgeFunctions:this.getEdgeFunctions().length,geoRestrictions:this.config.geoRestrictions.enabled,compressionEnabled:this.config.compression.enabled,httpsOnly:this.config.security.httpsOnly}}}let u={regions:[{id:"us-east-1",name:"US East (N. Virginia)",code:"US",location:{city:"Ashburn",country:"United States",continent:"North America",latitude:39.0437,longitude:-77.4875},infrastructure:{apiEndpoint:"https://api.us-east-1.apexrebate.com",cdnEndpoint:"https://cdn.us-east-1.apexrebate.com",databaseUrl:"postgresql://us-east-1.db.apexrebate.com",redisUrl:"redis://us-east-1.redis.apexrebate.com",storageBucket:"apexrebate-us-east-1"},capacity:{maxUsers:1e5,currentUsers:15e3,cpuThreshold:80,memoryThreshold:85},status:"active",latency:{average:45,p95:120,p99:200},features:["trading","analytics","api"],createdAt:new Date,updatedAt:new Date},{id:"eu-west-1",name:"EU West (Ireland)",code:"IE",location:{city:"Dublin",country:"Ireland",continent:"Europe",latitude:53.3498,longitude:-6.2603},infrastructure:{apiEndpoint:"https://api.eu-west-1.apexrebate.com",cdnEndpoint:"https://cdn.eu-west-1.apexrebate.com",databaseUrl:"postgresql://eu-west-1.db.apexrebate.com",redisUrl:"redis://eu-west-1.redis.apexrebate.com",storageBucket:"apexrebate-eu-west-1"},capacity:{maxUsers:8e4,currentUsers:12e3,cpuThreshold:80,memoryThreshold:85},status:"active",latency:{average:35,p95:100,p99:180},features:["trading","analytics","api"],createdAt:new Date,updatedAt:new Date},{id:"ap-southeast-1",name:"AP Southeast (Singapore)",code:"SG",location:{city:"Singapore",country:"Singapore",continent:"Asia",latitude:1.3521,longitude:103.8198},infrastructure:{apiEndpoint:"https://api.ap-southeast-1.apexrebate.com",cdnEndpoint:"https://cdn.ap-southeast-1.apexrebate.com",databaseUrl:"postgresql://ap-southeast-1.db.apexrebate.com",redisUrl:"redis://ap-southeast-1.redis.apexrebate.com",storageBucket:"apexrebate-ap-southeast-1"},capacity:{maxUsers:6e4,currentUsers:8e3,cpuThreshold:80,memoryThreshold:85},status:"active",latency:{average:55,p95:140,p99:220},features:["trading","analytics","api"],createdAt:new Date,updatedAt:new Date}],loadBalancing:{strategy:"geographic",weights:{"us-east-1":3,"eu-west-1":2,"ap-southeast-1":2},healthCheckInterval:30,failoverThreshold:3},cdn:{provider:"cloudflare",distributionId:"E1234567890ABC",domain:"cdn.apexrebate.com",cacheRules:[{id:"api-cache",path:"/api/*",ttl:300,cacheKey:"full-url",compress:!0,headers:["Authorization","Content-Type"],methods:["GET","POST"]},{id:"static-cache",path:"/static/*",ttl:86400,cacheKey:"path",compress:!0,headers:[],methods:["GET"]}],compression:{enabled:!0,level:"medium",mimeTypes:["text/html","application/json","text/css","application/javascript"]},security:{httpsOnly:!0,hsts:!0,securityHeaders:[]},geoRestrictions:{enabled:!1,allowedCountries:[],blockedCountries:[]},rateLimiting:{enabled:!0,requestsPerSecond:100,burstLimit:200}},security:{wafEnabled:!0,ddosProtection:!0,sslCertificate:"wildcard.apexrebate.com",firewallRules:[{name:"Block Malicious IPs",action:"deny",conditions:{ip:{in:["192.168.1.100"]}},priority:1}]},monitoring:{metricsEnabled:!0,loggingEnabled:!0,alertingEnabled:!0,retentionDays:30}},h=new c(u),d=new l(u.cdn);async function g(e){try{let{searchParams:t}=new URL(e.url),s=t.get("action");switch(t.get("region"),s){case"regions":let a=h.getAllRegions();return o.NextResponse.json({success:!0,data:a});case"health":let i=h.getHealthChecks();return o.NextResponse.json({success:!0,data:i});case"stats":let r=h.getRegionStats();return o.NextResponse.json({success:!0,data:r});case"cdn-metrics":let n=await d.getMetrics();return o.NextResponse.json({success:!0,data:n});default:return o.NextResponse.json({success:!1,error:"未知操作"},{status:400})}}catch(e){return console.error("基础设施API错误:",e),o.NextResponse.json({success:!1,error:e instanceof Error?e.message:"服务器内部错误"},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/infrastructure/route",pathname:"/api/infrastructure",filename:"route",bundlePath:"app/api/infrastructure/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/infrastructure/route.ts",nextConfigOutput:"standalone",userland:a}),{workAsyncStorage:f,workUnitAsyncStorage:m,serverHooks:y}=p;function b(){return(0,n.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:m})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[7719,580],()=>s(1887));module.exports=a})();