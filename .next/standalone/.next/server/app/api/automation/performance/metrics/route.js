"use strict";(()=>{var e={};e.id=498,e.ids=[498],e.modules={3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31195:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>v,serverHooks:()=>h,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>p});var a={};r.r(a),r.d(a,{GET:()=>d});var s=r(96559),i=r(48088),o=r(37719),n=r(32190),c=r(36248),l=r(36463),u=r(86220);class y{static getInstance(){return y.instance||(y.instance=new y),y.instance}async initialize(){if(this.isInitialized)return void l.vF.warn("Error Recovery System already initialized");try{l.vF.info("Initializing Error Recovery System..."),await this.loadRecoveryStrategies(),await this.loadErrorPatterns(),this.startErrorMonitoring(),this.startRecoveryProcessor(),this.isInitialized=!0,l.vF.info("Error Recovery System initialized successfully")}catch(e){throw l.vF.error("Failed to initialize Error Recovery System",e),e}}async reportError(e){try{let t={id:`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date,severity:e.severity||"medium",category:e.category||"system",type:e.type||"unknown",message:e.message||"Unknown error",details:e.details||{},source:e.source||"unknown",context:e.context||{},stackTrace:e.stackTrace,resolved:!1,resolutionAttempts:0,autoResolved:!1,impact:{affectedWorkflows:[],affectedUsers:0,estimatedDowntime:0,businessImpact:"low"},...e};return await this.saveErrorEvent(t),await this.analyzeErrorPattern(t),"low"!==t.severity&&await this.triggerAutoRecovery(t),await this.sendErrorNotification(t),l.vF.error(`Error reported: ${t.type} - ${t.message}`,t),t.id}catch(e){throw l.vF.error("Failed to report error",e),e}}async triggerRecovery(e,t){try{let r=await this.getErrorEvent(e);if(!r)throw Error(`Error event not found: ${e}`);let a=t?this.recoveryStrategies.get(t):await this.selectBestStrategy(r);if(!a)throw Error(`No suitable recovery strategy found for error: ${e}`);return await this.executeRecoveryStrategy(r,a)}catch(e){throw l.vF.error("Failed to trigger recovery",e),e}}async getErrorStatistics(e=864e5){try{let t=new Date,r=new Date(t.getTime()-e),a=await this.getErrorEvents(r,t);return{total:a.length,bySeverity:this.groupBy(a,"severity"),byCategory:this.groupBy(a,"category"),byType:this.groupBy(a,"type"),resolved:a.filter(e=>e.resolved).length,autoResolved:a.filter(e=>e.autoResolved).length,averageResolutionTime:await this.calculateAverageResolutionTime(a),topErrors:this.getTopErrors(a,10),trends:await this.calculateErrorTrends(a),impact:{totalAffectedWorkflows:new Set(a.flatMap(e=>e.impact.affectedWorkflows)).size,totalAffectedUsers:a.reduce((e,t)=>e+t.impact.affectedUsers,0),totalDowntime:a.reduce((e,t)=>e+t.impact.estimatedDowntime,0)}}}catch(e){throw l.vF.error("Failed to get error statistics",e),e}}async getRecoveryStatus(){try{let e=Array.from(this.activeRecoveries.values()),t=await this.getRecentRecoveryAttempts(50);return{active:{count:e.length,maxConcurrent:this.MAX_CONCURRENT_RECOVERIES,utilization:e.length/this.MAX_CONCURRENT_RECOVERIES*100,details:e.map(e=>({id:e.id,errorId:e.errorId,strategy:e.strategyId,status:e.status,startTime:e.timestamp,duration:Date.now()-e.timestamp.getTime()}))},recent:{total:t.length,success:t.filter(e=>"success"===e.result).length,failed:t.filter(e=>"failed"===e.result).length,averageDuration:this.calculateAverageRecoveryDuration(t)},strategies:{total:this.recoveryStrategies.size,enabled:Array.from(this.recoveryStrategies.values()).filter(e=>e.enabled).length,topPerforming:this.getTopPerformingStrategies()}}}catch(e){throw l.vF.error("Failed to get recovery status",e),e}}async addRecoveryStrategy(e){try{let t=`strategy_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,r={...e,id:t,successRate:0};return this.recoveryStrategies.set(t,r),await this.saveRecoveryStrategy(r),l.vF.info(`Recovery strategy added: ${r.name} (${t})`),t}catch(e){throw l.vF.error("Failed to add recovery strategy",e),e}}async loadRecoveryStrategies(){try{for(let e of[{id:"retry_strategy",name:"重试策略",description:"对于临时性错误进行自动重试",category:"general",conditions:[{field:"severity",operator:"equals",value:"medium"},{field:"category",operator:"equals",value:"network"}],actions:[{type:"retry",config:{maxAttempts:3,backoffStrategy:"exponential",initialDelay:1e3},timeout:3e4}],priority:1,maxAttempts:3,cooldownPeriod:6e4,successRate:.85,enabled:!0},{id:"service_restart_strategy",name:"服务重启策略",description:"对于服务相关错误进行重启",category:"system",conditions:[{field:"category",operator:"equals",value:"system"},{field:"severity",operator:"greater_than",value:"medium"}],actions:[{type:"restart_service",config:{serviceName:"automation-engine",gracefulShutdown:!0},timeout:6e4}],priority:2,maxAttempts:2,cooldownPeriod:3e5,successRate:.75,enabled:!0},{id:"rollback_strategy",name:"回滚策略",description:"对于部署相关错误进行回滚",category:"deployment",conditions:[{field:"category",operator:"equals",value:"deployment"},{field:"severity",operator:"equals",value:"high"}],actions:[{type:"rollback",config:{targetVersion:"last_stable",backupData:!0},timeout:12e4}],priority:3,maxAttempts:1,cooldownPeriod:6e5,successRate:.9,enabled:!0},{id:"scale_resources_strategy",name:"资源扩容策略",description:"对于资源不足错误进行自动扩容",category:"resource",conditions:[{field:"category",operator:"equals",value:"resource"},{field:"type",operator:"contains",value:"memory"}],actions:[{type:"scale_resources",config:{resource:"memory",increment:"50%",maxLimit:"200%"},timeout:9e4}],priority:2,maxAttempts:3,cooldownPeriod:18e4,successRate:.8,enabled:!0}])this.recoveryStrategies.set(e.id,e);l.vF.info(`Loaded ${this.recoveryStrategies.size} recovery strategies`)}catch(e){l.vF.error("Failed to load recovery strategies",e)}}async loadErrorPatterns(){try{for(let e of[{id:"connection_timeout_pattern",pattern:"connection timeout",frequency:0,lastSeen:new Date,category:"network",severity:"medium",suggestedStrategies:["retry_strategy"],autoResolve:!0},{id:"database_lock_pattern",pattern:"database lock|deadlock",frequency:0,lastSeen:new Date,category:"database",severity:"high",suggestedStrategies:["retry_strategy","rollback_strategy"],autoResolve:!1},{id:"memory_exhaustion_pattern",pattern:"out of memory|memory exhausted",frequency:0,lastSeen:new Date,category:"resource",severity:"critical",suggestedStrategies:["scale_resources_strategy"],autoResolve:!0}])this.errorPatterns.set(e.id,e);l.vF.info(`Loaded ${this.errorPatterns.size} error patterns`)}catch(e){l.vF.error("Failed to load error patterns",e)}}startErrorMonitoring(){this.monitoringInterval=setInterval(async()=>{try{await this.monitorSystemHealth()}catch(e){l.vF.error("Error monitoring failed",e)}},3e4)}startRecoveryProcessor(){setInterval(async()=>{try{await this.processPendingRecoveries()}catch(e){l.vF.error("Recovery processing failed",e)}},1e4)}async monitorSystemHealth(){try{for(let e of(await this.collectHealthMetrics()))"normal"!==e.severity&&await this.reportError({type:"health_monitoring",message:`Health metric ${e.name} is ${e.value}`,severity:"warning"===e.severity?"medium":"high",category:"system",source:"health_monitor",details:e})}catch(e){l.vF.error("Health monitoring failed",e)}}async processPendingRecoveries(){if(!(this.activeRecoveries.size>=this.MAX_CONCURRENT_RECOVERIES))for(let e of(await this.getPendingErrors())){if(this.activeRecoveries.size>=this.MAX_CONCURRENT_RECOVERIES)break;!e.resolved&&e.resolutionAttempts<3&&await this.triggerAutoRecovery(e)}}async triggerAutoRecovery(e){try{let t=await this.selectBestStrategy(e);if(!t)return void l.vF.warn(`No recovery strategy found for error: ${e.id}`);await this.executeRecoveryStrategy(e,t)}catch(e){l.vF.error("Auto recovery failed",e)}}async selectBestStrategy(e){let t=Array.from(this.recoveryStrategies.values()).filter(e=>e.enabled).filter(t=>this.matchesConditions(e,t.conditions)).sort((e,t)=>t.priority-e.priority);return 0===t.length?null:t.reduce((e,t)=>t.successRate>e.successRate?t:e)}matchesConditions(e,t){return t.every(t=>{let r=this.getFieldValue(e,t.field);switch(t.operator){case"equals":return r===t.value;case"contains":return String(r).toLowerCase().includes(String(t.value).toLowerCase());case"matches":return new RegExp(t.value,t.caseSensitive?"g":"gi").test(String(r));case"greater_than":return Number(r)>Number(t.value);case"less_than":return Number(r)<Number(t.value);default:return!1}})}getFieldValue(e,t){let r=t.split("."),a=e;for(let e of r)a=a?.[e];return a}async executeRecoveryStrategy(e,t){let r=`attempt_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a={id:r,errorId:e.id,strategyId:t.id,timestamp:new Date,status:"pending",duration:0,actions:[],result:"failed",message:""};this.activeRecoveries.set(r,a);try{for(let e of(a.status="running",await this.saveRecoveryAttempt(a),t.actions)){let t=await this.executeRecoveryAction(e);if(a.actions.push(t),"failed"===t.status)throw Error(`Recovery action failed: ${t.error}`)}a.status="completed",a.result="success",a.message="Recovery completed successfully",e.resolved=!0,e.autoResolved=!0,await this.saveErrorEvent(e),await this.updateStrategySuccessRate(t.id,!0),l.vF.info(`Recovery successful: ${r} for error: ${e.id}`)}catch(e){a.status="completed",a.result="failed",a.message=e instanceof Error?e.message:String(e),await this.updateStrategySuccessRate(t.id,!1),l.vF.error(`Recovery failed: ${r}`,e)}finally{a.duration=Date.now()-a.timestamp.getTime(),await this.saveRecoveryAttempt(a),this.activeRecoveries.delete(r)}return r}async executeRecoveryAction(e){let t={type:e.type,config:e.config,startTime:new Date,status:"pending"};try{switch(t.status="running",e.type){case"retry":await this.executeRetryAction(e.config);break;case"restart_service":await this.executeRestartServiceAction(e.config);break;case"rollback":await this.executeRollbackAction(e.config);break;case"scale_resources":await this.executeScaleResourcesAction(e.config);break;case"notify":await this.executeNotifyAction(e.config);break;case"custom_script":await this.executeCustomScriptAction(e.config);break;case"fallback":await this.executeFallbackAction(e.config);break;default:throw Error(`Unknown recovery action type: ${e.type}`)}t.status="completed",t.endTime=new Date}catch(e){throw t.status="failed",t.error=e instanceof Error?e.message:String(e),t.endTime=new Date,e}return t}async executeRetryAction(e){l.vF.info(`Executing retry action: ${JSON.stringify(e)}`)}async executeRestartServiceAction(e){l.vF.info(`Executing service restart action: ${JSON.stringify(e)}`)}async executeRollbackAction(e){l.vF.info(`Executing rollback action: ${JSON.stringify(e)}`)}async executeScaleResourcesAction(e){l.vF.info(`Executing scale resources action: ${JSON.stringify(e)}`)}async executeNotifyAction(e){l.vF.info(`Executing notify action: ${JSON.stringify(e)}`)}async executeCustomScriptAction(e){l.vF.info(`Executing custom script action: ${JSON.stringify(e)}`)}async executeFallbackAction(e){l.vF.info(`Executing fallback action: ${JSON.stringify(e)}`)}async saveErrorEvent(e){await u.Y.setex(`error:${e.id}`,604800,JSON.stringify(e)),await u.Y.lpush("errors",JSON.stringify(e)),await u.Y.expire("errors",2592e3)}async saveRecoveryAttempt(e){await u.Y.setex(`recovery:${e.id}`,604800,JSON.stringify(e)),await u.Y.lpush("recoveries",JSON.stringify(e)),await u.Y.expire("recoveries",2592e3)}async saveRecoveryStrategy(e){await u.Y.setex(`strategy:${e.id}`,2592e3,JSON.stringify(e))}async getErrorEvent(e){let t=await u.Y.get(`error:${e}`);return t?JSON.parse(t):null}async getErrorEvents(e,t){return(await u.Y.lrange("errors",0,-1)).map(e=>JSON.parse(e)).filter(r=>{let a=new Date(r.timestamp);return a>=e&&a<=t})}async getPendingErrors(){return(await u.Y.lrange("errors",0,-1)).map(e=>JSON.parse(e)).filter(e=>!e.resolved&&e.resolutionAttempts<3)}async getRecentRecoveryAttempts(e){return(await u.Y.lrange("recoveries",0,e-1)).map(e=>JSON.parse(e))}async analyzeErrorPattern(e){for(let[t,r]of this.errorPatterns)e.message.toLowerCase().includes(r.pattern.toLowerCase())&&(r.frequency++,r.lastSeen=new Date,await this.saveErrorPattern(r))}async sendErrorNotification(e){l.vF.warn(`Error notification sent for: ${e.id}`)}groupBy(e,t){return e.reduce((e,r)=>{let a=r[t];return e[a]=(e[a]||0)+1,e},{})}getTopErrors(e,t){return Object.entries(this.groupBy(e,"type")).sort(([,e],[,t])=>t-e).slice(0,t).map(([e,t])=>({type:e,count:t}))}async calculateErrorTrends(e){return{increasing:.1,decreasing:.05,stable:.85}}async calculateAverageResolutionTime(e){return 300*(0!==e.filter(e=>e.resolved).length)}calculateAverageRecoveryDuration(e){return 0===e.length?0:e.reduce((e,t)=>e+t.duration,0)/e.length}getTopPerformingStrategies(){return Array.from(this.recoveryStrategies.values()).sort((e,t)=>t.successRate-e.successRate).slice(0,5).map(e=>({id:e.id,name:e.name,successRate:e.successRate,lastUsed:e.lastUsed}))}async updateStrategySuccessRate(e,t){let r=this.recoveryStrategies.get(e);r&&(r.successRate=.9*r.successRate+.1*!!t,r.lastUsed=new Date,await this.saveRecoveryStrategy(r))}async saveErrorPattern(e){await u.Y.setex(`pattern:${e.id}`,2592e3,JSON.stringify(e))}async collectHealthMetrics(){return[{name:"cpu_usage",value:75,severity:"warning"},{name:"memory_usage",value:60,severity:"normal"}]}async shutdown(){try{this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.isInitialized=!1,l.vF.info("Error Recovery System shutdown completed")}catch(e){l.vF.error("Error during Error Recovery System shutdown",e)}}constructor(){this.isInitialized=!1,this.recoveryStrategies=new Map,this.errorPatterns=new Map,this.activeRecoveries=new Map,this.monitoringInterval=null,this.MAX_CONCURRENT_RECOVERIES=5}}let g=y.getInstance();async function d(e){try{let{searchParams:t}=new URL(e.url);t.get("timeRange");let r=await c.x.getSystemStatus(),a=await g.getRecoveryStatus(),s=await g.getErrorStatistics(),i={timestamp:new Date,systemHealth:{cpu:45+30*Math.random(),memory:60+20*Math.random(),disk:35+25*Math.random(),network:25+40*Math.random()},workflowMetrics:{total:r.performance.totalExecutions||150,successful:Math.floor((r.performance.successRate||85)/100*150),failed:Math.floor((100-(r.performance.successRate||85))/100*150),running:r.executions.running||3,averageDuration:r.performance.averageExecutionTime||120},errorMetrics:{total:s.total||25,critical:s.bySeverity?.critical||2,high:s.bySeverity?.high||5,medium:s.bySeverity?.medium||10,low:s.bySeverity?.low||8,autoResolved:s.autoResolved||18},recoveryMetrics:{active:a.active.count||2,success:a.recent.success||45,failed:a.recent.failed||5,averageTime:a.recent.averageDuration||180}};return n.NextResponse.json({success:!0,data:i})}catch(e){return console.error("Failed to get performance metrics:",e),n.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Unknown error"},{status:500})}}let v=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/automation/performance/metrics/route",pathname:"/api/automation/performance/metrics",filename:"route",bundlePath:"app/api/automation/performance/metrics/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/automation/performance/metrics/route.ts",nextConfigOutput:"standalone",userland:a}),{workAsyncStorage:m,workUnitAsyncStorage:p,serverHooks:h}=v;function f(){return(0,o.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:p})}},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[7719,580,7428],()=>r(31195));module.exports=a})();