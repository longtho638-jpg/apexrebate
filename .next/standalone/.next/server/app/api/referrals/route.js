(()=>{var e={};e.id=6396,e.ids=[5069,6396],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,r)=>{"use strict";r.d(t,{db:()=>s,prisma:()=>a});var i=r(96330);let s=globalThis.prisma??new i.PrismaClient({log:["query"]}),a=s},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,t,r)=>{"use strict";r.d(t,{N:()=>c});var i=r(60890),s=r(13581),a=r(36344),n=r(5069),o=r(85663);let c={adapter:(0,i.y)(n.db),providers:[...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,a.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[],(0,s.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await n.db.users.findUnique({where:{email:e.email}});return t&&t.password&&await o.Ay.compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"}}},13581:(e,t)=>{"use strict";t.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},19089:(e,t,r)=>{"use strict";r.d(t,{h:()=>a});var i=r(5069);class s{static async triggerWelcomeEmail(e){let t=await i.db.users.findUnique({where:{id:e}});t&&console.log(`Welcome email sent to ${t.email}`)}static async triggerCashbackEmail(e,t,r){let s=await i.db.users.findUnique({where:{id:e}});s&&console.log(`Cashback email sent to ${s.email}: $${t} for ${r}`)}static async triggerMilestoneEmail(e,t){let r=await i.db.users.findUnique({where:{id:e}});r&&console.log(`Milestone email sent to ${r.email}: ${t}`)}static async triggerReferralEmail(e,t){let r=await i.db.users.findUnique({where:{id:e}});r&&console.log(`Referral email sent to ${r.email}`)}static async triggerMonthlyReport(e,t){let r=await i.db.users.findUnique({where:{id:e}});r&&console.log(`Monthly report sent to ${r.email}`)}}let a=s},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},36344:(e,t)=>{"use strict";t.A=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48198:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>y,routeModule:()=>g,serverHooks:()=>w,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>f});var i={};r.r(i),r.d(i,{GET:()=>p,POST:()=>h});var s=r(96559),a=r(48088),n=r(37719),o=r(32190),c=r(19854),l=r(12909),d=r(5069),u=r(71810);async function p(){try{let e=await (0,c.getServerSession)(l.N);if(!e?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let t=await d.db.users.findUnique({where:{id:e.user.id},select:{referralCode:!0,referralCount:!0,referredUsers:{select:{id:!0,name:!0,email:!0,createdAt:!0,totalSaved:!0},orderBy:{createdAt:"desc"}}}});if(!t)return o.NextResponse.json({error:"User not found"},{status:404});let r=t.referralCode;return r||(r=function(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",r="";for(let e=0;e<8;e++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}(e.user.id),await d.db.users.update({where:{id:e.user.id},data:{referralCode:r}})),o.NextResponse.json({referralCode:r,referralCount:t.referralCount,referredUsers:t.referredUsers,referralLink:`${process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000"}?ref=${r}`})}catch(e){return console.error("Error fetching referrals:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function h(e){try{let t=await (0,c.getServerSession)(l.N);if(!t?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{referralCode:r}=await e.json();if(!r)return o.NextResponse.json({error:"Referral code is required"},{status:400});let i=await d.db.users.findUnique({where:{referralCode:r}});if(!i)return o.NextResponse.json({error:"Invalid referral code"},{status:404});if(i.id===t.user.id)return o.NextResponse.json({error:"Cannot refer yourself"},{status:400});let s=await d.db.users.findUnique({where:{id:t.user.id},select:{referredBy:!0}});if(s?.referredBy)return o.NextResponse.json({error:"User already has a referrer"},{status:400});return await d.db.users.update({where:{id:t.user.id},data:{referredBy:i.id}}),await u.b.processReferral(i.id,t.user.id),o.NextResponse.json({message:"Referral applied successfully",referrer:{name:i.name,email:i.email}})}catch(e){return console.error("Error applying referral:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/referrals/route",pathname:"/api/referrals",filename:"route",bundlePath:"app/api/referrals/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/referrals/route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:m,workUnitAsyncStorage:f,serverHooks:w}=g;function y(){return(0,n.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:f})}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},60890:(e,t)=>{"use strict";t.y=void 0,t.y=function(e){return{createUser:t=>e.user.create({data:t}),getUser:t=>e.user.findUnique({where:{id:t}}),getUserByEmail:t=>e.user.findUnique({where:{email:t}}),async getUserByAccount(t){var r;let i=await e.account.findUnique({where:{provider_providerAccountId:t},select:{user:!0}});return null!=(r=null==i?void 0:i.user)?r:null},updateUser:({id:t,...r})=>e.user.update({where:{id:t},data:r}),deleteUser:t=>e.user.delete({where:{id:t}}),linkAccount:t=>e.account.create({data:t}),unlinkAccount:t=>e.account.delete({where:{provider_providerAccountId:t}}),async getSessionAndUser(t){let r=await e.session.findUnique({where:{sessionToken:t},include:{user:!0}});if(!r)return null;let{user:i,...s}=r;return{user:i,session:s}},createSession:t=>e.session.create({data:t}),updateSession:t=>e.session.update({where:{sessionToken:t.sessionToken},data:t}),deleteSession:t=>e.session.delete({where:{sessionToken:t}}),async createVerificationToken(t){let r=await e.verificationToken.create({data:t});return r.id&&delete r.id,r},async useVerificationToken(t){try{let r=await e.verificationToken.delete({where:{identifier_token:t}});return r.id&&delete r.id,r}catch(e){if("P2025"===e.code)return null;throw e}}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},71810:(e,t,r)=>{"use strict";r.d(t,{b:()=>o});var i=r(5069),s=r(19089);let a=[{id:"first_savings",name:"first_savings",title:"Bắt đầu tiết kiệm",description:"Tiết kiệm được khoản đầu ti\xean của bạn",icon:"\uD83C\uDFAF",category:"SAVINGS",points:10,condition:{type:"savings",target:1,operator:">="}},{id:"savings_100",name:"savings_100",title:"Nh\xe0 tiết kiệm",description:"Tiết kiệm được 100 USD",icon:"\uD83D\uDCB0",category:"SAVINGS",points:50,condition:{type:"savings",target:100,operator:">="}},{id:"savings_500",name:"savings_500",title:"Chuy\xean gia tiết kiệm",description:"Tiết kiệm được 500 USD",icon:"\uD83D\uDC8E",category:"SAVINGS",points:200,condition:{type:"savings",target:500,operator:">="}},{id:"savings_1000",name:"savings_1000",title:"Bậc thầy tiết kiệm",description:"Tiết kiệm được 1,000 USD",icon:"\uD83D\uDC51",category:"SAVINGS",points:500,tier:"SILVER",condition:{type:"savings",target:1e3,operator:">="}},{id:"first_referral",name:"first_referral",title:"Người giới thiệu",description:"Giới thiệu th\xe0nh c\xf4ng người d\xf9ng đầu ti\xean",icon:"\uD83E\uDD1D",category:"REFERRALS",points:25,condition:{type:"referrals",target:1,operator:">="}},{id:"referrals_5",name:"referrals_5",title:"Người kết nối",description:"Giới thiệu th\xe0nh c\xf4ng 5 người d\xf9ng",icon:"\uD83C\uDF1F",category:"REFERRALS",points:100,condition:{type:"referrals",target:5,operator:">="}},{id:"referrals_10",name:"referrals_10",title:"Người dẫn dắt",description:"Giới thiệu th\xe0nh c\xf4ng 10 người d\xf9ng",icon:"\uD83D\uDE80",category:"REFERRALS",points:250,tier:"GOLD",condition:{type:"referrals",target:10,operator:">="}},{id:"streak_7",name:"streak_7",title:"Tuần lễ t\xedch cực",description:"Đăng nhập 7 ng\xe0y li\xean tiếp",icon:"\uD83D\uDD25",category:"ACTIVITY",points:30,condition:{type:"streak",target:7,operator:">="}},{id:"streak_30",name:"streak_30",title:"Th\xe1ng trung th\xe0nh",description:"Đăng nhập 30 ng\xe0y li\xean tiếp",icon:"\uD83D\uDCAA",category:"ACTIVITY",points:150,tier:"SILVER",condition:{type:"streak",target:30,operator:">="}},{id:"volume_100k",name:"volume_100k",title:"Nh\xe0 giao dịch t\xedch cực",description:"Khối lượng giao dịch 100,000 USD",icon:"\uD83D\uDCC8",category:"TRADING",points:40,condition:{type:"trading_volume",target:1e5,operator:">="}},{id:"volume_1m",name:"volume_1m",title:"Nh\xe0 giao dịch chuy\xean nghiệp",description:"Khối lượng giao dịch 1,000,000 USD",icon:"\uD83D\uDCCA",category:"TRADING",points:200,tier:"GOLD",condition:{type:"trading_volume",target:1e6,operator:">="}}],n={BRONZE:0,SILVER:500,GOLD:1500,PLATINUM:3e3,DIAMOND:5e3};class o{static async initializeAchievements(){for(let e of a)await i.db.achievement.upsert({where:{name:e.name},update:{title:e.title,description:e.description,icon:e.icon,category:e.category,points:e.points,tier:e.tier,condition:JSON.stringify(e.condition)},create:{name:e.name,title:e.title,description:e.description,icon:e.icon,category:e.category,points:e.points,tier:e.tier,condition:JSON.stringify(e.condition)}})}static async checkAchievements(e){let t=await i.db.users.findUnique({where:{id:e},include:{achievements:{include:{achievement:!0}}}});if(!t)return;let r=t.achievements.map(e=>e.achievementId);for(let s of(await i.db.achievement.findMany({where:{isActive:!0,id:{notIn:r}}}))){let r=JSON.parse(s.condition);await this.checkCondition(t,r)&&await this.unlockAchievement(e,s.id)}}static async checkCondition(e,t){let{type:r,target:i,operator:s=">="}=t,a=0;switch(r){case"savings":a=e.totalSaved||0;break;case"referrals":a=e.referralCount||0;break;case"streak":a=e.streak||0;break;case"trading_volume":a=e.tradingVolume||0;break;default:return!1}switch(s){case">":return a>i;case">=":default:return a>=i;case"=":return a===i;case"<=":return a<=i}}static async unlockAchievement(e,t){let r=await i.db.achievement.findUnique({where:{id:t}});if(r){await i.db.userAchievement.create({data:{userId:e,achievementId:t,unlockedAt:new Date,progress:100,pointsAwarded:r.points}}),await i.db.users.update({where:{id:e},data:{points:{increment:r.points},badgeCount:{increment:1}}}),await this.logActivity(e,"ACHIEVEMENT_UNLOCKED",`Mở th\xe0nh tựu: ${r.title}`,{achievementId:t,points:r.points},r.points);try{await s.h.onAchievementUnlocked(e,r.title,r.points)}catch(e){console.error("Failed to send achievement email:",e)}await this.checkTierUpgrade(e)}}static async checkTierUpgrade(e){let t=await i.db.users.findUnique({where:{id:e}});if(!t)return;let r=t.tier;if(t.points>=n.DIAMOND?r="DIAMOND":t.points>=n.PLATINUM?r="PLATINUM":t.points>=n.GOLD?r="GOLD":t.points>=n.SILVER&&(r="SILVER"),r!==t.tier){await i.db.users.update({where:{id:e},data:{tier:r}}),await this.logActivity(e,"TIER_UPGRADE",`N\xe2ng cấp l\xean hạng: ${r}`,{oldTier:t.tier,newTier:r},100);try{await s.h.onTierUpgrade(e,r)}catch(e){console.error("Failed to send tier upgrade email:",e)}}}static async logActivity(e,t,r,s,a){await i.db.userActivity.create({data:{userId:e,type:t,description:r,metadata:s?JSON.stringify(s):null,points:a||0}}),a&&a>0&&await i.db.users.update({where:{id:e},data:{points:{increment:a},lastActiveAt:new Date}})}static async updateActivityStreak(e){let t=await i.db.users.findUnique({where:{id:e}});if(!t)return;let r=new Date,s=t.lastActiveAt?new Date(t.lastActiveAt):null,a=s&&r.getDate()===s.getDate()+1&&r.getMonth()===s.getMonth()&&r.getFullYear()===s.getFullYear(),n=1;if(a)n=(t.streak||0)+1;else if(s&&r.toDateString()===s.toDateString())return;await i.db.users.update({where:{id:e},data:{streak:n,lastActiveAt:r}}),await this.logActivity(e,"LOGIN","Đăng nhập h\xe0ng ng\xe0y",{streak:n},5),await this.checkAchievements(e)}static async getUserGamification(e){let t=await i.db.users.findUnique({where:{id:e},include:{achievements:{include:{achievement:!0},orderBy:{unlockedAt:"desc"}},activities:{orderBy:{createdAt:"desc"},take:10},referredUsers:{select:{id:!0,createdAt:!0}}}});if(!t)return null;let r=n[t.tier],s=Object.entries(n).sort(([,e],[,t])=>e-t),a=s.findIndex(([e])=>e===t.tier),o=s[a+1],c=o?o[1]:null,l=c?(t.points-r)/(c-r)*100:100;return{user:{id:t.id,name:t.name,email:t.email,image:t.image,tier:t.tier,points:t.points,totalSaved:t.totalSaved,referralCount:t.referralCount,streak:t.streak,badgeCount:t.badgeCount,lastActiveAt:t.lastActiveAt},achievements:t.achievements,recentActivities:t.activities,referrals:t.referredUsers,tierProgress:{currentTier:t.tier,nextTier:o?o[0]:null,currentPoints:t.points,currentThreshold:r,nextThreshold:c,progressPercentage:Math.min(l,100)}}}static async processReferral(e,t){let r=await i.db.users.findUnique({where:{id:t},select:{name:!0,email:!0}});if(await i.db.users.update({where:{id:e},data:{referralCount:{increment:1}}}),await this.logActivity(e,"REFERRAL","Giới thiệu th\xe0nh c\xf4ng người d\xf9ng mới",{referredUserId:t},50),r)try{await s.h.onReferralSuccess(e,r.name||r.email?.split("@")[0]||"Anonymous")}catch(e){console.error("Failed to send referral success email:",e)}await this.checkAchievements(e)}static async updateSavings(e,t){await i.db.users.update({where:{id:e},data:{totalSaved:{increment:t}}}),await this.logActivity(e,"SAVINGS_MILESTONE",`Tiết kiệm th\xeam $${t.toFixed(2)}`,{amount:t},Math.floor(t/10)),await this.checkAchievements(e)}}},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[7719,580,4999,8044,9854],()=>r(48198));module.exports=i})();