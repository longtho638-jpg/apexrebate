name: Codex FullChain Runner

on:
  repository_dispatch:
    types: [run-agent]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run pipeline on'
        required: false
        default: 'main'
      pr_number:
        description: 'PR number to comment on'
        required: false

jobs:
  codex-fullchain:
    if: github.event.client_payload.agent == 'codex-fullchain' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch || github.event.inputs.branch || github.ref }}

      - name: Initialize Chain
        run: echo "üöÄ Starting Codex FullChain pipeline..."

      - name: Extract PR number
        id: pr
        run: |
          if [ -n "${{ github.event.client_payload.pr_number }}" ]; then
            echo "pr_number=${{ github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.inputs.pr_number }}" ]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
          fi

      - name: Post pipeline start comment
        if: steps.pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.pr_number }},
              body: `## ü™∑ Codex FullChain Pipeline Started
              
              Running automated CI/CD chain:
              - üß© Merge Fix (lint/build validation)
              - ‚úÖ Auto Approve
              - üîÄ Auto Merge
              - ‚òÅÔ∏è Deploy (Firebase + Cloud Run)
              
              [View run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });

      - name: Run Merge Fix
        id: merge-fix
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üß© Running Merge Fix..."
          gh api repos/${{ github.repository }}/dispatches \
            -f event_type='run-agent' \
            -f client_payload='{"agent":"codex-merge-fix","branch":"${{ github.event.client_payload.branch || github.event.inputs.branch || github.ref }}","pr_number":"${{ steps.pr.outputs.pr_number }}"}' || {
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          }
          echo "status=success" >> $GITHUB_OUTPUT
          sleep 30

      - name: Run Auto Approve
        if: steps.merge-fix.outputs.status == 'success'
        id: auto-approve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚úÖ Running Auto Approve..."
          gh api repos/${{ github.repository }}/dispatches \
            -f event_type='run-agent' \
            -f client_payload='{"agent":"codex-auto-approve","branch":"${{ github.event.client_payload.branch || github.event.inputs.branch || github.ref }}","pr_number":"${{ steps.pr.outputs.pr_number }}"}' || {
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          }
          echo "status=success" >> $GITHUB_OUTPUT
          sleep 30

      - name: Run Auto Merge
        if: steps.auto-approve.outputs.status == 'success'
        id: auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîÄ Running Auto Merge..."
          gh api repos/${{ github.repository }}/dispatches \
            -f event_type='run-agent' \
            -f client_payload='{"agent":"codex-auto-merge","branch":"${{ github.event.client_payload.branch || github.event.inputs.branch || github.ref }}","pr_number":"${{ steps.pr.outputs.pr_number }}"}' || {
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          }
          echo "status=success" >> $GITHUB_OUTPUT
          sleep 30

      - name: Run Deploy
        if: steps.auto-merge.outputs.status == 'success'
        id: deploy
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚òÅÔ∏è Running Deploy..."
          gh api repos/${{ github.repository }}/dispatches \
            -f event_type='run-agent' \
            -f client_payload='{"agent":"codex-deploy","branch":"main","pr_number":""}' || {
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          }
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Post completion comment
        if: always() && steps.pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        env:
          MERGE_FIX_STATUS: ${{ steps.merge-fix.outputs.status }}
          AUTO_APPROVE_STATUS: ${{ steps.auto-approve.outputs.status }}
          AUTO_MERGE_STATUS: ${{ steps.auto-merge.outputs.status }}
          DEPLOY_STATUS: ${{ steps.deploy.outputs.status }}
        with:
          script: |
            const statuses = {
              mergeFix: process.env.MERGE_FIX_STATUS === 'success' ? '‚úÖ' : '‚ùå',
              autoApprove: process.env.AUTO_APPROVE_STATUS === 'success' ? '‚úÖ' : '‚ùå',
              autoMerge: process.env.AUTO_MERGE_STATUS === 'success' ? '‚úÖ' : '‚ùå',
              deploy: process.env.DEPLOY_STATUS === 'success' ? '‚úÖ' : process.env.DEPLOY_STATUS === 'failed' ? '‚ùå' : '‚è≠Ô∏è'
            };
            
            const allSuccess = Object.values(statuses).every(s => s === '‚úÖ');
            const title = allSuccess ? 'üéâ Codex FullChain Pipeline Completed' : '‚ö†Ô∏è Codex FullChain Pipeline Partial Success';
            
            const body = `## ${title}
            
            | Stage | Status |
            |-------|--------|
            | Merge Fix | ${statuses.mergeFix} ${process.env.MERGE_FIX_STATUS || 'pending'} |
            | Auto Approve | ${statuses.autoApprove} ${process.env.AUTO_APPROVE_STATUS || 'pending'} |
            | Auto Merge | ${statuses.autoMerge} ${process.env.AUTO_MERGE_STATUS || 'pending'} |
            | Deploy | ${statuses.deploy} ${process.env.DEPLOY_STATUS || 'pending'} |
            
            ${allSuccess ? '‚úÖ All stages completed successfully. Deployment is live!' : '‚ö†Ô∏è Some stages did not complete. Check individual workflow runs for details.'}
            
            [View full run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.pr_number }},
              body: body
            });

      - name: Done
        run: |
          if [ "${{ steps.merge-fix.outputs.status }}" == "success" ] && \
             [ "${{ steps.auto-approve.outputs.status }}" == "success" ] && \
             [ "${{ steps.auto-merge.outputs.status }}" == "success" ] && \
             [ "${{ steps.deploy.outputs.status }}" == "success" ]; then
            echo "üéâ Codex FullChain completed successfully."
          else
            echo "‚ö†Ô∏è Codex FullChain completed with some failures."
            exit 1
          fi
