name: Vercel Optimize Runner

on:
  repository_dispatch:
    types: [run-agent]

jobs:
  vercel-optimize:
    if: github.event.client_payload.agent == 'vercel-optimize'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch || github.ref }}

      - name: Clean Next.js cache and traces
        run: |
          echo "ðŸ§¹ Cleaning up .next/cache and .next/trace..."
          rm -rf .next/cache || true
          rm -rf .next/trace || true

      - name: Ensure vercel.json exists with excludeFiles
        run: |
          if [ ! -f vercel.json ]; then
            echo "Creating vercel.json..."
            printf '%s\n' \
              '{' \
              '  "buildCommand": "prisma generate || true && next build",' \
              '  "framework": "nextjs",' \
              '  "installCommand": "npm install --legacy-peer-deps"' \
              '}' > vercel.json
          else
            echo "vercel.json already exists, keeping current configuration..."
          fi
          echo "Current vercel.json:"
          cat vercel.json

      - name: Commit optimization fix
        run: |
          git config user.name "codex-vercel-bot"
          git config user.email "codex@github.local"
          git add vercel.json || true
          git commit -m "fix(vercel): auto-cleanup cache and exclude from build" \
            || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Trigger redeploy to Vercel
        run: |
          echo "ðŸš€ Triggering redeploy..."
          BRANCH="${GITHUB_REF##*/}"
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          curl -X POST "https://api.vercel.com/v13/deployments" \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"name\": \"${REPO}\", \"gitSource\": \
            {\"type\": \"github\",\"org\": \"${OWNER}\",\
            \"repo\": \"${REPO}\",\"ref\": \"${BRANCH}\"}}"
