name: Deploy ApexRebate SSR + Lighthouse Audit + Gmail Notify

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: apexrebate-prod
  REGION: asia-southeast1
  SITE_URL: https://apexrebate.com

jobs:
  build-deploy-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy Functions + Hosting
        id: deploy
        run: firebase deploy --only functions,hosting --project $PROJECT_ID --force
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      - name: Run Lighthouse CI audit
        id: lighthouse
        run: |
          npx @lhci/cli autorun --collect.url=$SITE_URL/vi --collect.numberOfRuns=1 --upload.target=filesystem --upload.outputDir=./lhci-report
          echo "Lighthouse completed"
        continue-on-error: true

      - name: Install jq (for parsing JSON)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Parse Lighthouse metrics
        id: parse
        run: |
          MANIFEST=./lhci-report/manifest.json
          if [ -f "$MANIFEST" ]; then
            PERF=$(jq -r '.[0].summary.performance // empty' "$MANIFEST")
            ACC=$(jq -r '.[0].summary.accessibility // empty' "$MANIFEST")
            SEO=$(jq -r '.[0].summary.seo // empty' "$MANIFEST")
            BEST=$(jq -r '.[0].summary.bestPractices // empty' "$MANIFEST")
            : ${PERF:=N/A}
            : ${ACC:=N/A}
            : ${SEO:=N/A}
            : ${BEST:=N/A}
          else
            echo "manifest.json not found; setting scores to N/A"
            PERF=N/A
            ACC=N/A
            SEO=N/A
            BEST=N/A
          fi
          echo "perf=$PERF" >> $GITHUB_OUTPUT
          echo "acc=$ACC" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT
          echo "best=$BEST" >> $GITHUB_OUTPUT

      - name: Upload Lighthouse report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lhci-report

      - name: Send deployment report to Gmail webhook
        env:
          GMAIL_WEBHOOK: ${{ secrets.GMAIL_WEBHOOK }}
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{
              "project": "'"$PROJECT_ID"'",
              "site": "'"$SITE_URL"'",
              "performance": "'"${{ steps.parse.outputs.perf }}"'",
              "accessibility": "'"${{ steps.parse.outputs.acc }}"'",
              "seo": "'"${{ steps.parse.outputs.seo }}"'",
              "bestPractices": "'"${{ steps.parse.outputs.best }}"'",
              "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'",
              "status": "âœ… Deploy & Lighthouse Audit Completed",
              "repo": "'"${{ github.repository }}"'",
              "run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' \
            $GMAIL_WEBHOOK
