generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model accounts {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model achievements {
  id                String              @id
  name              String              @unique
  title             String
  description       String
  icon              String
  category          AchievementCategory
  points            Int                 @default(0)
  tier              UserTier?
  condition         String
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  user_achievements user_achievements[]
}

model data_syncs {
  id                                                               String             @id
  sourceRegionId                                                   String
  targetRegionId                                                   String
  syncType                                                         SyncType           @default(INCREMENTAL)
  status                                                           SyncStatus         @default(PENDING)
  recordsTotal                                                     Int                @default(0)
  recordsProcessed                                                 Int                @default(0)
  recordsFailed                                                    Int                @default(0)
  initiatedAt                                                      DateTime           @default(now())
  startedAt                                                        DateTime?
  completedAt                                                      DateTime?
  errorMessage                                                     String?
  progress                                                         Float              @default(0)
  metadata                                                         String?
  deployment_regions_data_syncs_sourceRegionIdTodeployment_regions deployment_regions @relation("data_syncs_sourceRegionIdTodeployment_regions", fields: [sourceRegionId], references: [id])
  deployment_regions_data_syncs_targetRegionIdTodeployment_regions deployment_regions @relation("data_syncs_targetRegionIdTodeployment_regions", fields: [targetRegionId], references: [id])
}

model deployment_configs {
  id                  String               @id
  name                String
  regions             String
  strategy            DeploymentStrategy   @default(ROUND_ROBIN)
  failoverEnabled     Boolean              @default(true)
  healthCheckInterval Int                  @default(30)
  isActive            Boolean              @default(true)
  weights             String?
  routingRules        String?
  metadata            String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  failover_events     failover_events[]
  deployment_regions  deployment_regions[] @relation("DeploymentConfigToDeploymentRegion")
}

model deployment_regions {
  id                                                               String               @id
  name                                                             String
  code                                                             String               @unique
  endpoint                                                         String
  status                                                           RegionStatus         @default(INACTIVE)
  latency                                                          Int                  @default(0)
  load                                                             Int                  @default(0)
  capabilities                                                     String
  priority                                                         Int                  @default(1)
  isActive                                                         Boolean              @default(true)
  lastHealthCheck                                                  DateTime?
  metadata                                                         String?
  createdAt                                                        DateTime             @default(now())
  updatedAt                                                        DateTime
  data_syncs_data_syncs_sourceRegionIdTodeployment_regions         data_syncs[]         @relation("data_syncs_sourceRegionIdTodeployment_regions")
  data_syncs_data_syncs_targetRegionIdTodeployment_regions         data_syncs[]         @relation("data_syncs_targetRegionIdTodeployment_regions")
  failover_events_failover_events_sourceRegionTodeployment_regions failover_events[]    @relation("failover_events_sourceRegionTodeployment_regions")
  failover_events_failover_events_targetRegionTodeployment_regions failover_events[]    @relation("failover_events_targetRegionTodeployment_regions")
  deployment_configs                                               deployment_configs[] @relation("DeploymentConfigToDeploymentRegion")
}

model email_notifications {
  id           String    @id
  userId       String
  type         String
  recipient    String
  subject      String
  content      String
  data         String?
  status       String    @default("pending")
  sentAt       DateTime?
  error        String?
  scheduledFor DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  users        users     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model exchange_accounts {
  id                    String                  @id
  userId                String
  exchangeId            String
  apiKey                String
  secret                String
  passphrase            String?
  isActive              Boolean                 @default(true)
  isSandbox             Boolean                 @default(false)
  lastSyncAt            DateTime?
  syncError             String?
  tradingVolume         Float                   @default(0)
  totalSaved            Float                   @default(0)
  preferences           String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  exchanges             exchanges               @relation(fields: [exchangeId], references: [id], onDelete: Cascade)
  users                 users                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  exchange_transactions exchange_transactions[]

  @@unique([userId, exchangeId])
}

model exchange_sync_logs {
  id               String     @id
  exchangeId       String
  accountId        String?
  type             SyncType
  status           SyncStatus @default(PENDING)
  startTime        DateTime   @default(now())
  endTime          DateTime?
  recordsProcessed Int        @default(0)
  recordsAdded     Int        @default(0)
  recordsUpdated   Int        @default(0)
  errorMessage     String?
  metadata         String?
}

model exchange_tickers {
  id         String    @id
  exchangeId String
  symbol     String
  price      Float
  change24h  Float     @default(0)
  volume24h  Float     @default(0)
  high24h    Float     @default(0)
  low24h     Float     @default(0)
  timestamp  DateTime  @default(now())
  exchanges  exchanges @relation(fields: [exchangeId], references: [id], onDelete: Cascade)

  @@unique([exchangeId, symbol])
}

model exchange_transactions {
  id                String            @id
  accountId         String
  exchangeId        String
  transactionId     String
  symbol            String
  side              String
  amount            Float
  price             Float
  fee               Float
  feeCurrency       String
  rebate            Float             @default(0)
  rebateRate        Float             @default(0)
  orderId           String?
  timestamp         DateTime
  syncedAt          DateTime          @default(now())
  exchange_accounts exchange_accounts @relation(fields: [accountId], references: [id], onDelete: Cascade)
  exchanges         exchanges         @relation(fields: [exchangeId], references: [id], onDelete: Cascade)

  @@unique([accountId, transactionId])
}

model exchanges {
  id                    String                  @id
  name                  String                  @unique
  displayName           String
  baseUrl               String
  sandboxUrl            String?
  isActive              Boolean                 @default(true)
  supportedPairs        String
  feeStructure          String
  affiliateInfo         String
  logoUrl               String?
  websiteUrl            String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  exchange_accounts     exchange_accounts[]
  exchange_tickers      exchange_tickers[]
  exchange_transactions exchange_transactions[]
}

model failover_events {
  id                                                                  String             @id
  deploymentId                                                        String
  sourceRegion                                                        String
  targetRegion                                                        String
  reason                                                              String
  status                                                              FailoverStatus     @default(INITIATED)
  initiatedAt                                                         DateTime           @default(now())
  completedAt                                                         DateTime?
  errorMessage                                                        String?
  metadata                                                            String?
  deployment_configs                                                  deployment_configs @relation(fields: [deploymentId], references: [id])
  deployment_regions_failover_events_sourceRegionTodeployment_regions deployment_regions @relation("failover_events_sourceRegionTodeployment_regions", fields: [sourceRegion], references: [id])
  deployment_regions_failover_events_targetRegionTodeployment_regions deployment_regions @relation("failover_events_targetRegionTodeployment_regions", fields: [targetRegion], references: [id])
}

model mobile_app_configs {
  id                  String   @id
  platform            Platform
  version             String
  buildNumber         Int
  minSupportedVersion String?
  features            String
  config              String
  isActive            Boolean  @default(true)
  releasedAt          DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime

  @@unique([platform, version])
}

model mobile_events {
  id           String        @id
  userId       String
  mobileUserId String?
  eventType    String
  eventName    String
  properties   String?
  sessionId    String?
  timestamp    DateTime      @default(now())
  mobile_users mobile_users? @relation(fields: [mobileUserId], references: [id])
}

model mobile_feedbacks {
  id           String         @id
  userId       String
  mobileUserId String?
  rating       Int
  comment      String?
  category     String
  deviceInfo   String?
  status       FeedbackStatus @default(NEW)
  respondedAt  DateTime?
  response     String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  mobile_users mobile_users?  @relation(fields: [mobileUserId], references: [id])
}

model mobile_users {
  id                 String               @id
  userId             String
  deviceToken        String
  platform           Platform
  appVersion         String
  deviceInfo         String
  preferences        String
  isActive           Boolean              @default(true)
  lastActiveAt       DateTime             @default(now())
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  mobile_events      mobile_events[]
  mobile_feedbacks   mobile_feedbacks[]
  push_notifications push_notifications[]

  @@unique([userId, deviceToken])
}

model notifications {
  id        String   @id
  userId    String
  type      String
  title     String
  message   String
  data      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  users     users    @relation(fields: [userId], references: [id])
}

model payouts {
  id            String       @id
  userId        String
  amount        Float
  currency      String       @default("USD")
  period        String
  broker        String
  tradingVolume Float
  feeRate       Float
  status        PayoutStatus @default(PENDING)
  processedAt   DateTime?
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime
  users         users        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model push_notifications {
  id           String             @id
  userId       String
  mobileUserId String?
  title        String
  body         String
  data         String?
  type         NotificationType   @default(TRANSACTIONAL)
  status       NotificationStatus @default(PENDING)
  scheduledFor DateTime?
  sentAt       DateTime?
  errorMessage String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime
  mobile_users mobile_users?      @relation(fields: [mobileUserId], references: [id])
}

model regional_metrics {
  id         String   @id
  regionId   String
  metricType String
  metricName String
  value      Float
  unit       String?
  timestamp  DateTime @default(now())
  metadata   String?

  @@index([regionId, metricType, timestamp])
}

model sessions {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model tool_affiliate_links {
  id          String        @id
  toolId      String
  affiliateId String
  linkCode    String        @unique
  commission  Float         @default(10.0)
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  users       users         @relation(fields: [affiliateId], references: [id])
  tools       tools         @relation(fields: [toolId], references: [id])
  tool_orders tool_orders[]

  @@unique([toolId, affiliateId])
}

model tool_categories {
  id          String   @id
  name        String   @unique
  description String?
  icon        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  tools       tools[]
}

model tool_favorites {
  id        String   @id
  toolId    String
  userId    String
  createdAt DateTime @default(now())
  tools     tools    @relation(fields: [toolId], references: [id])
  users     users    @relation(fields: [userId], references: [id])

  @@unique([toolId, userId])
}

model tool_orders {
  id                   String                @id
  toolId               String
  buyerId              String
  sellerId             String
  affiliateLinkId      String?
  amount               Float
  commissionAmount     Float?
  currency             String                @default("USD")
  status               OrderStatus           @default(PENDING)
  paymentMethod        String?
  paymentId            String?
  downloadUrl          String?
  licenseKey           String?
  notes                String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime
  tool_affiliate_links tool_affiliate_links? @relation(fields: [affiliateLinkId], references: [id])
  users                users                 @relation(fields: [buyerId], references: [id])
  tools                tools                 @relation(fields: [toolId], references: [id])
}

model tool_reviews {
  id        String   @id
  toolId    String
  userId    String
  rating    Int
  title     String?
  content   String?
  pros      String?
  cons      String?
  verified  Boolean  @default(false)
  helpful   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime
  tools     tools    @relation(fields: [toolId], references: [id])
  users     users    @relation(fields: [userId], references: [id])

  @@unique([toolId, userId])
}

model tools {
  id                   String                 @id
  name                 String
  description          String
  price                Float
  category             String
  type                 ToolType
  image                String?
  features             String?
  requirements         String?
  documentation        String?
  status               ToolStatus             @default(DRAFT)
  featured             Boolean                @default(false)
  sellerId             String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  tool_affiliate_links tool_affiliate_links[]
  tool_favorites       tool_favorites[]
  tool_orders          tool_orders[]
  tool_reviews         tool_reviews[]
  tool_categories      tool_categories        @relation(fields: [category], references: [id])
  users                users                  @relation(fields: [sellerId], references: [id])

  @@unique([name, sellerId])
}

model user_achievements {
  id            String       @id
  userId        String
  achievementId String
  unlockedAt    DateTime     @default(now())
  progress      Int          @default(0)
  pointsAwarded Int          @default(0)
  achievements  achievements @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  users         users        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
}

model user_activities {
  id          String       @id
  userId      String
  type        ActivityType
  description String
  metadata    String?
  points      Int          @default(0)
  createdAt   DateTime     @default(now())
  users       users        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model users {
id                   String                 @id
email                String                 @unique
name                 String?
image                String?
password             String?
role                 UserRole               @default(USER)
emailVerified        DateTime?
twoFactorEnabled     Boolean                @default(false)
twoFactorSecret      String?
createdAt            DateTime               @default(now())
updatedAt            DateTime
tradingVolume        Float?
preferredBroker      String?
experience           String?
referralSource       String?
referralCode         String?
referredBy           String?
totalSaved           Float                  @default(0)
referralCount        Int                    @default(0)
tier                 UserTier               @default(BRONZE)
points               Int                    @default(0)
lastActiveAt         DateTime               @default(now())
streak               Int                    @default(0)
badgeCount           Int                    @default(0)
hangSoiMember        Boolean                @default(false)
hangSoiJoinedAt      DateTime?
isSuspicious         Boolean                @default(false)
kyc                  Boolean                @default(false)
status               String                 @default("ACTIVE")
accounts             accounts[]
email_notifications  email_notifications[]
exchange_accounts    exchange_accounts[]
hangSoiMemberships   hangSoiMembership[]
notifications        notifications[]
payouts              payouts[]
sessions             sessions[]
tool_affiliate_links tool_affiliate_links[]
tool_favorites       tool_favorites[]
tool_orders          tool_orders[]
tool_reviews         tool_reviews[]
tools                tools[]
user_achievements    user_achievements[]
user_activities      user_activities[]
referrer             users?                 @relation("referrer", fields: [referredBy], references: [id])
referredUsers        users[]                @relation("referrer")
}

model hangSoiMembership {
  id           String   @id @default(cuid())
  userId       String
  status       String   @default("PENDING") // PENDING, APPROVED, REJECTED
  appliedAt    DateTime @default(now())
  approvedAt   DateTime?
  rejectedAt   DateTime?
  reason       String?
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId])
  @@index([status])
}

model hangSoiJoinRequest {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  experience    String
  monthlyVolume Int
  reason        String
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED
  appliedAt     DateTime @default(now())
  approvedAt    DateTime?
  reviewedAt    DateTime?
  notes         String?
  
  @@index([status])
  @@index([email])
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PolicyBundle {
  id         String   @id @default(cuid())
  version    String
  algo       String   // e.g., HMAC-SHA256
  sigHex     String   // signature hex
  entries    Json     // { "file.rego": "package ...", ... }
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([active])
}

enum AchievementCategory {
  SAVINGS
  REFERRALS
  ACTIVITY
  TRADING
  LOYALTY
  SPECIAL
}

enum ActivityType {
  LOGIN
  REFERRAL
  SAVINGS_MILESTONE
  TIER_UPGRADE
  ACHIEVEMENT_UNLOCKED
  TRADING_VOLUME
  PAYOUT_RECEIVED
  STREAK_MILESTONE
}

enum DeploymentStrategy {
  ROUND_ROBIN
  WEIGHTED
  GEOGRAPHIC
  PERFORMANCE
  PRIORITY
}

enum FailoverStatus {
  INITIATED
  IN_PROGRESS
  COMPLETED
  FAILED
  ROLLED_BACK
}

enum FeedbackStatus {
  NEW
  REVIEWED
  RESPONDED
  RESOLVED
  CLOSED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

enum NotificationType {
  TRANSACTIONAL
  MARKETING
  ALERT
  SYSTEM
}

enum OrderStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSED
  FAILED
}

enum Platform {
  IOS
  ANDROID
}

enum RegionStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  DEGRADED
  ERROR
}

enum SyncStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  PARTIAL
}

enum SyncType {
  FULL
  INCREMENTAL
  TICKERS
  TRANSACTIONS
  BALANCES
}

enum ToolStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ToolType {
  INDICATOR
  BOT
  SCANNER
  STRATEGY
  EDUCATION
}

enum UserRole {
  USER
  ADMIN
  CONCIERGE
}

enum UserTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}
