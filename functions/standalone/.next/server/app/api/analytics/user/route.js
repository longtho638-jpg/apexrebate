(()=>{var e={};e.id=6328,e.ids=[5069,6328],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,r)=>{"use strict";r.d(t,{db:()=>n,prisma:()=>a});var s=r(96330);let n=globalThis.prisma??new s.PrismaClient({log:["query"]}),a=n},8173:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>y,routeModule:()=>p,serverHooks:()=>g,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>d});var n=r(96559),a=r(48088),o=r(37719),i=r(32190),u=r(19854),c=r(12909),l=r(5069);async function d(e){try{let t=await (0,u.getServerSession)(c.N);if(!t?.user?.id)return i.NextResponse.json({success:!1,error:{code:"UNAUTHORIZED",message:"Bạn cần đăng nhập để xem ph\xe2n t\xedch"}},{status:401});let{searchParams:r}=new URL(e.url),s=r.get("period")||"6m";r.get("type");let n=await l.db.users.findUnique({where:{id:t.user.id},include:{payouts:{where:{status:"PROCESSED"},orderBy:{createdAt:"asc"}},referredUsers:{include:{payouts:{where:{status:"PROCESSED"}}}},achievements:{include:{achievement:!0}},activities:{orderBy:{createdAt:"desc"},take:100}}});if(!n)return i.NextResponse.json({success:!1,error:{code:"USER_NOT_FOUND",message:"Kh\xf4ng t\xecm thấy người d\xf9ng"}},{status:404});let a=new Date,o=new Date;switch(s){case"1m":o.setMonth(a.getMonth()-1);break;case"3m":o.setMonth(a.getMonth()-3);break;case"6m":o.setMonth(a.getMonth()-6);break;case"1y":o.setFullYear(a.getFullYear()-1);break;default:o=new Date(0)}let d=n.payouts.filter(e=>new Date(e.createdAt)>=o),p=new Map,m=0;d.forEach(e=>{let t=new Date(e.createdAt).toLocaleDateString("vi-VN",{month:"short",year:"2-digit"});m+=e.amount,p.set(t,(p.get(t)||0)+e.amount)});let h=Array.from(p.entries()).map(([e,t],r)=>(m=Array.from(p.entries()).slice(0,r+1).reduce((e,[,t])=>e+t,0),{date:e,amount:t,cumulative:m})),g=d.reduce((e,t)=>{let r=t.broker||"unknown";return e[r]||(e[r]={count:0,amount:0,volume:0}),e[r].count+=1,e[r].amount+=t.amount,e[r].volume+=t.tradingVolume||0,e},{}),y=Object.values(g).reduce((e,t)=>e+t.amount,0),w=Object.entries(g).map(([e,t])=>({broker:e.charAt(0).toUpperCase()+e.slice(1),amount:Math.round(100*t.amount)/100,percentage:Math.round(t.amount/y*100),volume:Math.round(t.volume),avgPayout:Math.round(t.amount/t.count*100)/100,color:"binance"===e?"#0088FE":"bybit"===e?"#00C49F":"okx"===e?"#FFBB28":"#8884D8"})),f=new Map,v=0;n.referredUsers.forEach(e=>{let t=new Date(e.createdAt).toLocaleDateString("vi-VN",{month:"short",year:"2-digit"});v+=1,f.set(t,(f.get(t)||0)+1)});let x=Array.from(f.entries()).map(([e,t],r)=>(v=Array.from(f.entries()).slice(0,r+1).reduce((e,[,t])=>e+t,0),{date:e,count:t,total:v})),M=[];for(let e=5;e>=0;e--){let t=new Date;t.setMonth(t.getMonth()-e);let r=t.toLocaleDateString("vi-VN",{month:"long"}),s=d.filter(e=>{let r=new Date(e.createdAt);return r.getMonth()===t.getMonth()&&r.getFullYear()===t.getFullYear()}),n=new Date(t);n.setMonth(n.getMonth()-1);let a=d.filter(e=>{let t=new Date(e.createdAt);return t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear()});M.push({month:r,current:s.reduce((e,t)=>e+t.amount,0),previous:a.reduce((e,t)=>e+t.amount,0)})}let A=d.reduce((e,t)=>e+t.amount,0),k=h.length||1,b=Math.round(A/k*100)/100,U=h.reduce((e,t)=>t.amount>e.amount?t:e,{amount:0,date:""}),E=M.length>=2?Math.round((M[M.length-1].current-M[0].current)/Math.max(M[0].current,1)*100):0,q=n.referredUsers.filter(e=>e.payouts.length>0).length,D=n.referredUsers.length>0?Math.round(q/n.referredUsers.length*100):0,S=d.reduce((e,t)=>e+(t.tradingVolume||0),0),T=S>0?Math.round(A/S*1e4)/100:0,N=n.achievements.reduce((e,t)=>{let r=t.achievement.category;return e[r]||(e[r]=0),e[r]+=1,e},{}),R=n.activities.slice(0,30).reduce((e,t)=>(e[t.type]||(e[t.type]=0),e[t.type]+=1,e),{}),O=b*(1+E/100),j={totalPayouts:Math.round(100*A)/100,averageMonthly:Math.round(100*b)/100,bestMonth:U.date||"N/A",growthRate:E,totalReferrals:n.referredUsers.length,conversionRate:D,efficiencyRate:T,totalTradingVolume:Math.round(S),predictedNextMonth:Math.round(100*O)/100,predictedYearEnd:Math.round(100*(A+12*O))/100,currentTier:n.tier,totalPoints:n.points,streak:n.streak},C=n.referredUsers.filter(e=>e.payouts.length>0).map(e=>({name:e.name||e.email?.split("@")[0]||"Anonymous",amount:e.payouts.reduce((e,t)=>e+t.amount,0),referrals:1,joinedAt:e.createdAt})).sort((e,t)=>t.amount-e.amount).slice(0,5),L={payoutsOverTime:h,brokerDistribution:w,referralGrowth:x,monthlyComparison:M,topReferrers:C,performanceMetrics:j,achievementsByCategory:N,activityByType:R,period:s,generatedAt:new Date().toISOString()};return i.NextResponse.json({success:!0,data:L})}catch(e){return console.error("Analytics API error:",e),i.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Lỗi server nội bộ"}},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/analytics/user/route",pathname:"/api/analytics/user",filename:"route",bundlePath:"app/api/analytics/user/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/analytics/user/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:h,serverHooks:g}=p;function y(){return(0,o.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:h})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,t,r)=>{"use strict";r.d(t,{N:()=>u});var s=r(60890),n=r(13581),a=r(36344),o=r(5069),i=r(85663);let u={adapter:(0,s.y)(o.db),providers:[...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,a.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[],(0,n.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await o.db.users.findUnique({where:{email:e.email}});return t&&t.password&&await i.Ay.compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"}}},13581:(e,t)=>{"use strict";t.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},36344:(e,t)=>{"use strict";t.A=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},60890:(e,t)=>{"use strict";t.y=void 0,t.y=function(e){return{createUser:t=>e.user.create({data:t}),getUser:t=>e.user.findUnique({where:{id:t}}),getUserByEmail:t=>e.user.findUnique({where:{email:t}}),async getUserByAccount(t){var r;let s=await e.account.findUnique({where:{provider_providerAccountId:t},select:{user:!0}});return null!=(r=null==s?void 0:s.user)?r:null},updateUser:({id:t,...r})=>e.user.update({where:{id:t},data:r}),deleteUser:t=>e.user.delete({where:{id:t}}),linkAccount:t=>e.account.create({data:t}),unlinkAccount:t=>e.account.delete({where:{provider_providerAccountId:t}}),async getSessionAndUser(t){let r=await e.session.findUnique({where:{sessionToken:t},include:{user:!0}});if(!r)return null;let{user:s,...n}=r;return{user:s,session:n}},createSession:t=>e.session.create({data:t}),updateSession:t=>e.session.update({where:{sessionToken:t.sessionToken},data:t}),deleteSession:t=>e.session.delete({where:{sessionToken:t}}),async createVerificationToken(t){let r=await e.verificationToken.create({data:t});return r.id&&delete r.id,r},async useVerificationToken(t){try{let r=await e.verificationToken.delete({where:{identifier_token:t}});return r.id&&delete r.id,r}catch(e){if("P2025"===e.code)return null;throw e}}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[7719,4999,580,8044,9854],()=>r(8173));module.exports=s})();