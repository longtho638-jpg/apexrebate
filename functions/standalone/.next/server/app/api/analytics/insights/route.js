(()=>{var e={};e.id=1030,e.ids=[1030,5069],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,n)=>{"use strict";n.d(t,{db:()=>i,prisma:()=>a});var r=n(96330);let i=globalThis.prisma??new r.PrismaClient({log:["query"]}),a=i},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,t,n)=>{"use strict";n.d(t,{N:()=>u});var r=n(60890),i=n(13581),a=n(36344),s=n(5069),o=n(85663);let u={adapter:(0,r.y)(s.db),providers:[...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,a.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[],(0,i.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await s.db.users.findUnique({where:{email:e.email}});return t&&t.password&&await o.Ay.compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"}}},13581:(e,t)=>{"use strict";t.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},36344:(e,t)=>{"use strict";t.A=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},60890:(e,t)=>{"use strict";t.y=void 0,t.y=function(e){return{createUser:t=>e.user.create({data:t}),getUser:t=>e.user.findUnique({where:{id:t}}),getUserByEmail:t=>e.user.findUnique({where:{email:t}}),async getUserByAccount(t){var n;let r=await e.account.findUnique({where:{provider_providerAccountId:t},select:{user:!0}});return null!=(n=null==r?void 0:r.user)?n:null},updateUser:({id:t,...n})=>e.user.update({where:{id:t},data:n}),deleteUser:t=>e.user.delete({where:{id:t}}),linkAccount:t=>e.account.create({data:t}),unlinkAccount:t=>e.account.delete({where:{provider_providerAccountId:t}}),async getSessionAndUser(t){let n=await e.session.findUnique({where:{sessionToken:t},include:{user:!0}});if(!n)return null;let{user:r,...i}=n;return{user:r,session:i}},createSession:t=>e.session.create({data:t}),updateSession:t=>e.session.update({where:{sessionToken:t.sessionToken},data:t}),deleteSession:t=>e.session.delete({where:{sessionToken:t}}),async createVerificationToken(t){let n=await e.verificationToken.create({data:t});return n.id&&delete n.id,n},async useVerificationToken(t){try{let n=await e.verificationToken.delete({where:{identifier_token:t}});return n.id&&delete n.id,n}catch(e){if("P2025"===e.code)return null;throw e}}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},78529:(e,t,n)=>{"use strict";n.r(t),n.d(t,{patchFetch:()=>v,routeModule:()=>m,serverHooks:()=>y,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>f});var r={};n.r(r),n.d(r,{GET:()=>h});var i=n(96559),a=n(48088),s=n(37719),o=n(32190),u=n(19854),l=n(12909),c=n(5069);async function h(e){try{let e=await (0,u.getServerSession)(l.N);if(!e?.user?.id)return o.NextResponse.json({success:!1,error:{code:"UNAUTHORIZED",message:"Bạn cần đăng nhập để xem insights"}},{status:401});let t=await c.db.users.findUnique({where:{id:e.user.id},include:{payouts:{where:{status:"PROCESSED"},orderBy:{createdAt:"asc"}},referredUsers:{include:{payouts:{where:{status:"PROCESSED"}}}},achievements:{include:{achievement:!0}},activities:{orderBy:{createdAt:"desc"},take:100}}});if(!t)return o.NextResponse.json({success:!1,error:{code:"USER_NOT_FOUND",message:"Kh\xf4ng t\xecm thấy người d\xf9ng"}},{status:404});let n=await d(t);return o.NextResponse.json({success:!0,data:n})}catch(e){return console.error("Insights API error:",e),o.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"Lỗi server nội bộ"}},{status:500})}}async function d(e){var t,n,r;let i,a=e.payouts,s=e.referredUsers,o=e.achievements;e.activities;let u=function(e,t){var n,r,i,a,s;let o,u=e.reduce((e,t)=>e+t.amount,0),l=e.reduce((e,t)=>e+(t.tradingVolume||0),0),c=l>0?u/l*1e4:0,h=g(e),d=h.reduce((e,t)=>e+t.total,0)/h.length,m=Math.max(0,100-Math.sqrt(h.reduce((e,t)=>e+Math.pow(t.total-d,2),0)/h.length)/d*100),p=function(e){if(e.length<2)return 0;let t=e.slice(-3),n=e.slice(-6,-3),r=t.reduce((e,t)=>e+t.total,0)/t.length,i=n.length>0?n.reduce((e,t)=>e+t.total,0)/n.length:r;return i>0?(r-i)/i*100:0}(h);return{totalEarnings:u,efficiencyRate:Math.round(100*c)/100,consistencyScore:Math.round(m),growthTrend:p,performanceGrade:(n=u,r=m,i=p,o=0,(n>1e3?o+=40:n>500?o+=30:n>100?o+=20:o+=10,o+=r/100*35,i>20?o+=25:i>10?o+=20:i>0?o+=15:i>-10?o+=10:o+=5,o>=85)?"A+":o>=75?"A":o>=65?"B+":o>=55?"B":o>=45?"C+":o>=35?"C":"D"),comparisonToAverage:(a=0,{percentile:Math.min(95,Math.max(5,(s=u)/10*100)),betterThan:Math.min(95,Math.max(5,s/10*100)),totalUsers:1e3})}}(a,e),l=function(e){let t=e.reduce((e,t)=>(e[t.broker]||(e[t.broker]={count:0,volume:0,earnings:0}),e[t.broker].count+=1,e[t.broker].volume+=t.tradingVolume||0,e[t.broker].earnings+=t.amount,e),{}),n=Object.entries(t).reduce((e,[t,n])=>{let r=n.volume>0?n.earnings/n.volume*1e4:0;return r>(e.stats.volume>0?e.stats.earnings/e.stats.volume*1e4:0)?{broker:t,efficiency:r,stats:n}:e},{broker:"",efficiency:0,stats:{count:0,volume:0,earnings:0}});return{brokerPerformance:t,bestBroker:n,tradingFrequency:function(e){if(0===e.length)return{frequency:"none",pattern:"none"};let t=e.slice(1).map((t,n)=>{let r=new Date(e[n].createdAt);return(new Date(t.createdAt).getTime()-r.getTime())/864e5}),n=t.reduce((e,t)=>e+t,0)/t.length;return n<7?{frequency:"high",pattern:"weekly"}:n<30?{frequency:"medium",pattern:"monthly"}:{frequency:"low",pattern:"irregular"}}(e),volumePatterns:function(e){let t=e.map(e=>e.tradingVolume||0),n=t.reduce((e,t)=>e+t,0)/t.length,r=Math.max(...t),i=Math.min(...t);return{average:n,maximum:r,minimum:i,volatility:r>0?(r-i)/r*100:0}}(e),diversificationScore:function(e){let t=Object.keys(e);return 0===t.length?0:1===t.length?20:2===t.length?60:3===t.length?90:100}(t)}}(a),c=function(e,t){let n=e.filter(e=>e.payouts.length>0),r=e.reduce((e,t)=>e+t.payouts.reduce((e,t)=>e+t.amount,0),0),i=n.map(e=>({name:e.name||e.email?.split("@")[0]||"Anonymous",earnings:e.payouts.reduce((e,t)=>e+t.amount,0),activity:e.payouts.length,joinedAt:e.createdAt,qualityScore:function(e){let t=e.payouts.reduce((e,t)=>e+t.amount,0),n=e.payouts.length,r=0;return t>100?r+=40:t>50?r+=30:t>0&&(r+=20),n>5?r+=30:n>2?r+=20:n>0&&(r+=10),Math.min(100,r+=Math.min(30,10*e.payouts.filter(e=>new Date(e.createdAt)>new Date(Date.now()-2592e6)).length))}(e)})),a=function(e){let t=e.reduce((e,t)=>{let n=new Date(t.createdAt).toISOString().slice(0,7);return e[n]=(e[n]||0)+1,e},{}),n=Object.keys(t).length,r=n>0?Object.values(t).reduce((e,t)=>e+t,0)/n:0;return{monthlyBreakdown:t,peakMonth:Object.entries(t).reduce((e,[t,n])=>n>e.count?{month:t,count:n}:e,{month:"",count:0}),averagePerMonth:r}}(e);return{totalReferrals:e.length,activeReferrals:n.length,totalReferralEarnings:r,averageReferralEarnings:n.length>0?r/n.length:0,referralQuality:i,timelinePatterns:a,referralEfficiency:e.length>0?n.length/e.length*100:0}}(s,0),h=function(e,t){let n=Object.entries(e.reduce((e,t)=>{let n=t.achievement.category;return e[n]||(e[n]=[]),e[n].push(t),e},{})).map(([e,t])=>{var n;return{category:e,count:t.length,totalPoints:t.reduce((e,t)=>e+t.achievement.points,0),completionRate:(n=e,Math.round(t.length/(({SAVINGS:10,REFERRALS:8,ACTIVITY:12,TRADING:15,LOYALTY:6,SPECIAL:5})[n]||10)*100))}}),r=e.filter(e=>new Date(e.unlockedAt)>new Date(Date.now()-2592e6)).length;return{totalAchievements:e.length,totalPoints:e.reduce((e,t)=>e+t.achievement.points,0),categoryProgress:n,recentAchievements:r,achievementMomentum:r>0?"high":e.length>5?"medium":"low",nextMilestone:null}}(o,0),d=function(e,t,n){var r,i;let a,s=g(e),o=function(e){if(e.length<2)return{amount:0,confidence:"low"};let t=e.slice(-6),n=t.length,r=0,i=0,a=0,s=0;t.forEach((e,t)=>{r+=t,i+=e.total,a+=t*e.total,s+=t*t});let o=(n*a-r*i)/(n*s-r*r),u=(i-o*r)/n;return{amount:Math.max(0,o*n+u),confidence:e.length>=6?"high":e.length>=3?"medium":"low"}}(s),u=function(e,t){let n=e.tier,r=t.length>0?t.reduce((e,t)=>e+t.total,0)/t.length:0,i={BRONZE:{minEarnings:0,nextTier:"SILVER",requiredEarnings:500},SILVER:{minEarnings:500,nextTier:"GOLD",requiredEarnings:1500},GOLD:{minEarnings:1500,nextTier:"PLATINUM",requiredEarnings:3e3},PLATINUM:{minEarnings:3e3,nextTier:"DIAMOND",requiredEarnings:5e3},DIAMOND:{minEarnings:5e3,nextTier:null,requiredEarnings:null}}[n];if(!i?.nextTier)return{currentTier:n,nextTier:null,monthsToNext:null,progress:100};let a=e.totalSaved||0,s=i.requiredEarnings||0,o=Math.max(0,s-a),u=r>0?Math.ceil(o/r):null;return{currentTier:n,nextTier:i.nextTier,monthsToNext:u,progress:Math.round(a/s*100)}}(n,s);return{nextMonthPrediction:o,tierProgression:u,referralGrowth:function(e){let t=e.filter(e=>new Date(e.createdAt)>new Date(Date.now()-7776e6)).length/3,n=Math.round(1.1*t);return{currentRate:t,predictedNextMonth:n,confidence:e.length>10?"high":e.length>5?"medium":"low"}}(t),achievementTimeline:function(e,t){let n=e.filter(e=>new Date(e.unlockedAt)>new Date(Date.now()-2592e6)).length,r=n>0?Math.ceil(30/n):90;return{currentRate:n,predictedNextAchievement:r,confidence:n>0?"medium":"low"}}(n.achievements,0),confidenceLevel:(r=e.length,i=t.length,a=0,r>20?a+=40:r>10?a+=25:r>5&&(a+=15),i>10?a+=30:i>5?a+=20:i>2&&(a+=10),Math.min(100,a+=30))}}(a,s,e);return{performanceInsights:u,tradingInsights:l,referralInsights:c,achievementInsights:h,predictiveInsights:d,recommendations:function(e,t,n,r){var i;let a=[];if(t.length>0){let e=function(e){let t=Object.entries(e.reduce((e,t)=>(e[t.broker]||(e[t.broker]=[]),e[t.broker].push(t),e),{})).map(([e,t])=>({broker:e,efficiency:t.reduce((e,t)=>e+t.amount/(t.tradingVolume||1),0)/t.length,totalEarnings:t.reduce((e,t)=>e+t.amount,0)})).sort((e,t)=>t.efficiency-e.efficiency),n=t.slice(1).map(e=>e.broker);return{best:t[0]?.broker,underutilized:n}}(t);e.underutilized.length>0&&a.push({type:"trading",priority:"medium",title:"Tối ưu h\xf3a S\xe0n giao dịch",description:`H\xe3y xem x\xe9t sử dụng ${e.underutilized[0]} để tăng hiệu suất ho\xe0n ph\xed`,action:"Xem ph\xe2n t\xedch s\xe0n giao dịch"})}n.length<5&&a.push({type:"referral",priority:"high",title:"Tăng cường Giới thiệu",description:"Mời th\xeam bạn b\xe8 để tăng thu nhập thụ động",action:"Chia sẻ m\xe3 giới thiệu"});let s=(i=0,[]);return s.length>0&&a.push({type:"achievement",priority:"low",title:"Mở kh\xf3a Th\xe0nh tựu mới",description:`Bạn c\xf2n ${s.length} th\xe0nh tựh c\xf3 thể mở kh\xf3a`,action:"Xem c\xe1c th\xe0nh tựh khả dụng"}),e.streak<7&&a.push({type:"activity",priority:"medium",title:"Duy tr\xec Hoạt động",description:"Đăng nhập thường xuy\xean để duy tr\xec chuỗi hoạt động",action:"Đăng nhập h\xe0ng ng\xe0y"}),a}(e,a,s,0),riskAnalysis:function(e,t){let n,r=[];return function(e){if(0===e.length)return 0;let t=e.reduce((e,t)=>(e[t.broker]=(e[t.broker]||0)+t.amount,e),{}),n=Object.values(t).reduce((e,t)=>e+t,0);return Math.max(...Object.values(t))/n*100}(e)>80&&r.push({type:"concentration",level:"high",description:"Rủi ro tập trung cao v\xe0o một s\xe0n giao dịch",mitigation:"C\xe2n đối lại danh mục s\xe0n giao dịch"}),0===e.filter(e=>new Date(e.createdAt)>new Date(Date.now()-2592e6)).length&&r.push({type:"activity",level:"medium",description:"Kh\xf4ng c\xf3 hoạt động gần đ\xe2y",mitigation:"Tăng cường hoạt động giao dịch"}),-20>function(e){let t=e.slice(-10),n=e.slice(-20,-10),r=t.reduce((e,t)=>e+t.amount,0),i=n.reduce((e,t)=>e+t.amount,0);return i>0?(r-i)/i*100:0}(e)&&r.push({type:"performance",level:"high",description:"Hiệu suất đang giảm",mitigation:"Xem x\xe9t lại chiến lược giao dịch"}),{risks:r,overallRiskLevel:function(e){if(0===e.length)return"low";let t=e.filter(e=>"high"===e.level).length,n=e.filter(e=>"medium"===e.level).length;return t>0?"high":n>1?"medium":"low"}(r),riskScore:(n=100,r.forEach(e=>{"high"===e.level?n-=30:"medium"===e.level?n-=15:n-=5}),Math.max(0,n))}}(a,0),generatedAt:new Date().toISOString(),dataQuality:(t=a,n=s,r=o,i=100,0===t.length&&(i-=30),t.length<5&&(i-=15),0===n.length&&(i-=10),0===r.length&&(i-=10),0===t.filter(e=>new Date(e.createdAt)>new Date(Date.now()-2592e6)).length&&(i-=20),Math.max(0,i))}}function g(e){return Object.entries(e.reduce((e,t)=>{let n=new Date(t.createdAt).toISOString().slice(0,7);return e[n]||(e[n]=[]),e[n].push(t),e},{})).map(([e,t])=>({month:e,total:t.reduce((e,t)=>e+t.amount,0),count:t.length,volume:t.reduce((e,t)=>e+(t.tradingVolume||0),0)}))}let m=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/analytics/insights/route",pathname:"/api/analytics/insights",filename:"route",bundlePath:"app/api/analytics/insights/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/analytics/insights/route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:p,workUnitAsyncStorage:f,serverHooks:y}=m;function v(){return(0,s.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:f})}},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[7719,4999,580,8044,9854],()=>n(78529));module.exports=r})();