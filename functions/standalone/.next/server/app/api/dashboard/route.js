(()=>{var e={};e.id=4618,e.ids=[4618,5069],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,r,t)=>{"use strict";t.d(r,{db:()=>s,prisma:()=>i});var a=t(96330);let s=globalThis.prisma??new a.PrismaClient({log:["query"]}),i=s},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,r,t)=>{"use strict";t.d(r,{N:()=>c});var a=t(60890),s=t(13581),i=t(36344),n=t(5069),o=t(85663);let c={adapter:(0,a.y)(n.db),providers:[...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,i.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[],(0,s.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let r=await n.db.users.findUnique({where:{email:e.email}});return r&&r.password&&await o.Ay.compare(e.password,r.password)?{id:r.id,email:r.email,name:r.name,role:r.role}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.role=r.role),e),session:async({session:e,token:r})=>(r&&(e.user.id=r.sub,e.user.role=r.role),e)},pages:{signIn:"/auth/signin"}}},13581:(e,r)=>{"use strict";r.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30847:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>y,routeModule:()=>m,serverHooks:()=>h,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>v});var a={};t.r(a),t.d(a,{GET:()=>p});var s=t(96559),i=t(48088),n=t(37719),o=t(32190),c=t(19854),l=t(12909),u=t(5069),d=t(47228);async function p(e){try{try{let e=await (0,c.getServerSession)(l.N),r=e?.user?.id;if(r){let[e,t,a,s]=await Promise.all([u.db.users.findUnique({where:{id:r},select:{id:!0,createdAt:!0,tier:!0,totalSaved:!0,tradingVolume:!0}}),u.db.payouts.findMany({where:{userId:r,status:"PROCESSED"},orderBy:{createdAt:"asc"}}),u.db.users.findMany({where:{referredBy:r},select:{id:!0,createdAt:!0}}),u.db.user_achievements.findMany({where:{userId:r},include:{achievements:!0}})]);if(e){let r=e.totalSaved||t.reduce((e,r)=>e+r.amount,0),i=e.tradingVolume||t.reduce((e,r)=>e+r.tradingVolume,0),n=new Date,c=t.filter(e=>e.createdAt.getMonth()===n.getMonth()&&e.createdAt.getFullYear()===n.getFullYear()).reduce((e,r)=>e+r.amount,0),l=new Map;t.forEach(e=>{let r=`${e.createdAt.getFullYear()}-${String(e.createdAt.getMonth()+1).padStart(2,"0")}`,t=l.get(r)||{savings:0,volume:0};t.savings+=e.amount,t.volume+=e.tradingVolume,l.set(r,t)});let u=Array.from(l.entries()).sort((e,r)=>e[0].localeCompare(r[0])).slice(-6).map(([e,r])=>({month:e,savings:Math.round(100*r.savings)/100,volume:r.volume})),d=new Map;t.forEach(e=>{let r=(e.broker||"binance").toLowerCase(),t=d.get(r)||{volume:0,savings:0,count:0};t.volume+=e.tradingVolume,t.savings+=e.amount,t.count+=1,d.set(r,t)});let p=Array.from(d.values()).reduce((e,r)=>e+r.savings,0)||1,m=Array.from(d.entries()).map(([e,r])=>({broker:e.charAt(0).toUpperCase()+e.slice(1),volume:Math.round(r.volume),savings:Math.round(100*r.savings)/100,percentage:Math.round(r.savings/p*100)})),g=s.map(e=>({id:e.achievementId,title:e.achievements.title,description:e.achievements.description,icon:e.achievements.icon,unlocked:!0,date:e.unlockedAt.toISOString().slice(0,10)})),v={userData:{totalSavings:Math.round(100*r)/100,monthlySavings:Math.round(100*c)/100,totalVolume:Math.round(i),memberSince:e.createdAt.toISOString().slice(0,10),rank:e.tier,nextRankProgress:65,referrals:a.length,referralEarnings:0},savingsHistory:u,brokerStats:m,achievements:g};return o.NextResponse.json({success:!0,data:v})}}}catch(e){console.error("Dashboard DB error, using mock data:",e)}try{let e=await d.D.getDashboardAnalytics("demo-user-id");return o.NextResponse.json({success:!0,data:e})}catch(e){return console.error("Database error, using mock data:",e),o.NextResponse.json({success:!0,data:{userData:{totalSavings:2847.5,monthlySavings:237.29,totalVolume:25e5,memberSince:"2024-01-15",rank:"Silver",nextRankProgress:65,referrals:3,referralEarnings:142.5},savingsHistory:[{month:"2024-01",savings:145.2,volume:12e5},{month:"2024-02",savings:189.45,volume:15e5},{month:"2024-03",savings:234.8,volume:18e5},{month:"2024-04",savings:278.9,volume:21e5},{month:"2024-05",savings:237.29,volume:25e5}],brokerStats:[{broker:"Binance",volume:15e5,savings:142.5,percentage:60},{broker:"Bybit",volume:75e4,savings:71.25,percentage:30},{broker:"OKX",volume:25e4,savings:23.54,percentage:10}],achievements:[{id:"first_savings",title:"Tiết kiệm đầu ti\xean",description:"Ho\xe0n th\xe0nh lần ho\xe0n ph\xed đầu ti\xean",icon:"Star",unlocked:!0,date:"2024-01-15"},{id:"monthly_100",title:"Th\xe0nh vi\xean th\xe1ng",description:"Tiết kiệm hơn $100 trong th\xe1ng",icon:"Award",unlocked:!0,date:"2024-02-01"},{id:"referral_1",title:"Người giới thiệu",description:"Giới thiệu th\xe0nh c\xf4ng 1 th\xe0nh vi\xean",icon:"Users",unlocked:!0,date:"2024-03-10"},{id:"savings_1000",title:"Nh\xe0 tiết kiệm",description:"Tổng tiết kiệm đạt $1,000",icon:"Crown",unlocked:!0,date:"2024-04-15"},{id:"savings_5000",title:"Bậc thầy tiết kiệm",description:"Tổng tiết kiệm đạt $5,000",icon:"Gem",unlocked:!1,progress:57},{id:"apex_pro",title:"ApexPro Member",description:"N\xe2ng cấp l\xean ApexPro SaaS",icon:"Shield",unlocked:!1,progress:80}]}})}}catch(e){return console.error("Dashboard API error:",e),o.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/dashboard/route",pathname:"/api/dashboard",filename:"route",bundlePath:"app/api/dashboard/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/dashboard/route.ts",nextConfigOutput:"standalone",userland:a}),{workAsyncStorage:g,workUnitAsyncStorage:v,serverHooks:h}=m;function y(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:v})}},36344:(e,r)=>{"use strict";r.A=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47228:(e,r,t)=>{"use strict";t.d(r,{D:()=>n});var a=t(5069),s=t(96330),i=t(59232);class n{static async createOrUpdateUser(e){try{let r=await a.db.users.findUnique({where:{email:e.email}}),t=null;if(e.referralCode&&!r){let r=await a.db.users.findUnique({where:{referralCode:e.referralCode}});r&&(t=r.id)}if(r)return await a.db.users.update({where:{email:e.email},data:{tradingVolume:e.tradingVolume?parseFloat(e.tradingVolume):void 0,preferredBroker:e.preferredBroker,experience:e.experience,referralSource:e.referralSource,lastActiveAt:new Date,updatedAt:new Date}});{let r=(0,i.Ak)(8).toUpperCase();return await a.db.users.create({data:{email:e.email,name:e.name,tradingVolume:e.tradingVolume?parseFloat(e.tradingVolume):0,preferredBroker:e.preferredBroker,experience:e.experience,referralSource:e.referralSource,referralCode:r,referredBy:t,tier:s.UserTier.BRONZE,totalSaved:0,referralCount:0,points:0,streak:1,badgeCount:0,updatedAt:new Date}})}}catch(e){throw console.error("Error creating/updating user:",e),e}}static async getUserByEmail(e){try{return await a.db.users.findUnique({where:{email:e},include:{payouts:{orderBy:{createdAt:"desc"},take:10},achievements:{include:{achievement:!0}},activities:{orderBy:{createdAt:"desc"},take:20}}})}catch(e){throw console.error("Error fetching user:",e),e}}static async updateUserSavings(e,r){try{let t=await a.db.users.findUnique({where:{id:e}});if(!t)throw Error("User not found");let i=t.totalSaved+r,n=this.calculateUserTier(i),o=await a.db.users.update({where:{id:e},data:{totalSaved:i,tier:n,lastActiveAt:new Date}});return await this.recordActivity(e,s.ActivityType.SAVINGS_MILESTONE,`Saved $${r.toFixed(2)} in rebates`,{amount:r,newTotal:i}),n!==t.tier&&await this.recordActivity(e,s.ActivityType.TIER_UPGRADE,`Upgraded to ${n} tier`,{oldTier:t.tier,newTier:n}),o}catch(e){throw console.error("Error updating user savings:",e),e}}static calculateUserTier(e){return e>=1e4?s.UserTier.DIAMOND:e>=5e3?s.UserTier.PLATINUM:e>=2e3?s.UserTier.GOLD:e>=500?s.UserTier.SILVER:s.UserTier.BRONZE}static async recordActivity(e,r,t,s){try{return await a.db.userActivity.create({data:{userId:e,type:r,description:t,metadata:s?JSON.stringify(s):null,points:this.getActivityPoints(r)}})}catch(e){throw console.error("Error recording activity:",e),e}}static getActivityPoints(e){switch(e){case s.ActivityType.LOGIN:return 1;case s.ActivityType.REFERRAL:return 50;case s.ActivityType.SAVINGS_MILESTONE:return 10;case s.ActivityType.TIER_UPGRADE:return 100;case s.ActivityType.ACHIEVEMENT_UNLOCKED:return 25;case s.ActivityType.TRADING_VOLUME:return 5;case s.ActivityType.PAYOUT_RECEIVED:return 15;case s.ActivityType.STREAK_MILESTONE:return 20;default:return 0}}static async getWallOfFame(e=50){try{return(await a.db.users.findMany({where:{totalSaved:{gt:0}},orderBy:{totalSaved:"desc"},take:e,select:{id:!0,name:!0,totalSaved:!0,tier:!0,createdAt:!0,payouts:{select:{broker:!0,amount:!0,createdAt:!0},orderBy:{createdAt:"desc"},take:1}}})).map((e,r)=>({id:e.id,anonymousName:`Trader ${String.fromCharCode(65+r)}`,totalSavings:e.totalSaved,broker:e.payouts[0]?.broker||"Unknown",memberSince:e.createdAt.toISOString().split("T")[0],tier:e.tier,rank:r+1}))}catch(e){throw console.error("Error fetching Wall of Fame:",e),e}}static async getDashboardAnalytics(e){try{let r=await a.db.users.findUnique({where:{id:e},include:{payouts:{orderBy:{createdAt:"desc"},take:100},activities:{orderBy:{createdAt:"desc"},take:50},achievements:{include:{achievement:!0}}}});if(!r)throw Error("User not found");let t=r.payouts,s=t.reduce((e,r)=>e+r.tradingVolume,0),i=this.calculateMonthlySavings(t),n=this.calculateBrokerStats(t),o=this.calculateSavingsHistory(t);return{userData:{totalSavings:r.totalSaved,monthlySavings:i,totalVolume:s,memberSince:r.createdAt.toISOString().split("T")[0],rank:r.tier,nextRankProgress:this.calculateNextRankProgress(r.totalSaved,r.tier),referrals:r.referralCount,referralEarnings:47.5*r.referralCount},savingsHistory:o,brokerStats:n,achievements:r.achievements.map(e=>({id:e.achievement.id,title:e.achievement.title,description:e.achievement.description,icon:e.achievement.icon,unlocked:100===e.progress,date:e.unlockedAt.toISOString().split("T")[0],progress:e.progress}))}}catch(e){throw console.error("Error fetching dashboard analytics:",e),e}}static calculateMonthlySavings(e){let r=new Date().getMonth(),t=new Date().getFullYear();return e.filter(e=>{let a=new Date(e.createdAt);return a.getMonth()===r&&a.getFullYear()===t}).reduce((e,r)=>e+r.amount,0)}static calculateBrokerStats(e){let r=new Map;e.forEach(e=>{let t=r.get(e.broker)||{volume:0,savings:0};r.set(e.broker,{volume:t.volume+e.tradingVolume,savings:t.savings+e.amount})});let t=Array.from(r.values()).reduce((e,r)=>e+r.volume,0);return Array.from(r.entries()).map(([e,r])=>({broker:e,volume:r.volume,savings:r.savings,percentage:t>0?r.volume/t*100:0}))}static calculateSavingsHistory(e){let r=new Map;return e.forEach(e=>{let t=e.createdAt.toISOString().substring(0,7),a=r.get(t)||{savings:0,volume:0};r.set(t,{savings:a.savings+e.amount,volume:a.volume+e.tradingVolume})}),Array.from(r.entries()).sort((e,r)=>e[0].localeCompare(r[0])).slice(-12).map(([e,r])=>({month:e,savings:r.savings,volume:r.volume}))}static calculateNextRankProgress(e,r){let t={[s.UserTier.BRONZE]:500,[s.UserTier.SILVER]:2e3,[s.UserTier.GOLD]:5e3,[s.UserTier.PLATINUM]:1e4,[s.UserTier.DIAMOND]:1e4},a=t[r],i=t[this.getNextTier(r)];return r===s.UserTier.DIAMOND?100:Math.min(100,Math.max(0,(e-a)/(i-a)*100))}static getNextTier(e){switch(e){case s.UserTier.BRONZE:return s.UserTier.SILVER;case s.UserTier.SILVER:return s.UserTier.GOLD;case s.UserTier.GOLD:return s.UserTier.PLATINUM;case s.UserTier.PLATINUM:default:return s.UserTier.DIAMOND}}}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},59232:(e,r,t)=>{"use strict";let a,s;t.d(r,{Ak:()=>o});var i=t(55511);let n=e=>{!a||a.length<e?(a=Buffer.allocUnsafe(128*e),i.randomFillSync(a),s=0):s+e>a.length&&(i.randomFillSync(a),s=0),s+=e},o=(e=21)=>{n(e|=0);let r="";for(let t=s-e;t<s;t++)r+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&a[t]];return r}},60890:(e,r)=>{"use strict";r.y=void 0,r.y=function(e){return{createUser:r=>e.user.create({data:r}),getUser:r=>e.user.findUnique({where:{id:r}}),getUserByEmail:r=>e.user.findUnique({where:{email:r}}),async getUserByAccount(r){var t;let a=await e.account.findUnique({where:{provider_providerAccountId:r},select:{user:!0}});return null!=(t=null==a?void 0:a.user)?t:null},updateUser:({id:r,...t})=>e.user.update({where:{id:r},data:t}),deleteUser:r=>e.user.delete({where:{id:r}}),linkAccount:r=>e.account.create({data:r}),unlinkAccount:r=>e.account.delete({where:{provider_providerAccountId:r}}),async getSessionAndUser(r){let t=await e.session.findUnique({where:{sessionToken:r},include:{user:!0}});if(!t)return null;let{user:a,...s}=t;return{user:a,session:s}},createSession:r=>e.session.create({data:r}),updateSession:r=>e.session.update({where:{sessionToken:r.sessionToken},data:r}),deleteSession:r=>e.session.delete({where:{sessionToken:r}}),async createVerificationToken(r){let t=await e.verificationToken.create({data:r});return t.id&&delete t.id,t},async useVerificationToken(r){try{let t=await e.verificationToken.delete({where:{identifier_token:r}});return t.id&&delete t.id,t}catch(e){if("P2025"===e.code)return null;throw e}}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[7719,4999,580,8044,9854],()=>t(30847));module.exports=a})();