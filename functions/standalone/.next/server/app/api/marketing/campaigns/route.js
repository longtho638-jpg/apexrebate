(()=>{var e={};e.id=8094,e.ids=[5069,8094],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,a)=>{"use strict";a.d(t,{db:()=>i,prisma:()=>r});var n=a(96330);let i=globalThis.prisma??new n.PrismaClient({log:["query"]}),r=i},8719:(e,t,a)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var a in t)Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}(t,{isRequestAPICallableInsideAfter:function(){return c},throwForSearchParamsAccessInUseCache:function(){return o},throwWithStaticGenerationBailoutError:function(){return r},throwWithStaticGenerationBailoutErrorWithDynamicError:function(){return s}});let n=a(80023),i=a(3295);function r(e,t){throw Object.defineProperty(new n.StaticGenBailoutError(`Route ${e} couldn't be rendered statically because it used ${t}. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`),"__NEXT_ERROR_CODE",{value:"E576",enumerable:!1,configurable:!0})}function s(e,t){throw Object.defineProperty(new n.StaticGenBailoutError(`Route ${e} with \`dynamic = "error"\` couldn't be rendered statically because it used ${t}. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`),"__NEXT_ERROR_CODE",{value:"E543",enumerable:!1,configurable:!0})}function o(e){let t=Object.defineProperty(Error(`Route ${e.route} used "searchParams" inside "use cache". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use "searchParams" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`),"__NEXT_ERROR_CODE",{value:"E634",enumerable:!1,configurable:!0});throw e.invalidUsageError??=t,t}function c(){let e=i.afterTaskAsyncStorage.getStore();return(null==e?void 0:e.rootTaskSpawnPhase)==="action"}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19089:(e,t,a)=>{"use strict";a.d(t,{h:()=>r});var n=a(5069);class i{static async triggerWelcomeEmail(e){let t=await n.db.users.findUnique({where:{id:e}});t&&console.log(`Welcome email sent to ${t.email}`)}static async triggerCashbackEmail(e,t,a){let i=await n.db.users.findUnique({where:{id:e}});i&&console.log(`Cashback email sent to ${i.email}: $${t} for ${a}`)}static async triggerMilestoneEmail(e,t){let a=await n.db.users.findUnique({where:{id:e}});a&&console.log(`Milestone email sent to ${a.email}: ${t}`)}static async triggerReferralEmail(e,t){let a=await n.db.users.findUnique({where:{id:e}});a&&console.log(`Referral email sent to ${a.email}`)}static async triggerMonthlyReport(e,t){let a=await n.db.users.findUnique({where:{id:e}});a&&console.log(`Monthly report sent to ${a.email}`)}}let r=i},21111:(e,t,a)=>{"use strict";a.d(t,{Z$:()=>i,ZM:()=>o,gm:()=>s});var n=a(5069),i=function(e){return e.WELCOME="welcome",e.PAYOUT_RECEIVED="payout_received",e.ACHIEVEMENT_UNLOCKED="achievement_unlocked",e.TIER_UPGRADE="tier_upgrade",e.REFERRAL_SUCCESS="referral_success",e.WEEKLY_DIGEST="weekly_digest",e.MONTHLY_REPORT="monthly_report",e.INACTIVITY_WARNING="inactivity_warning",e.MILESTONE_REACHED="milestone_reached",e.CONCIERGE_UPDATE="concierge_update",e}({});class r{constructor(){this.zai=null}static getInstance(){return r.instance||(r.instance=new r),r.instance}async initializeZAI(){try{let e=await a.e(7838).then(a.bind(a,87838));this.zai=await e.create(),console.log("Email service initialized with ZAI SDK")}catch(e){console.error("Failed to initialize ZAI SDK for email service:",e)}}async generateEmailContent(e,t){this.zai||await this.initializeZAI();let a={welcome:{subject:"Ch\xe0o m·ª´ng ƒë·∫øn v·ªõi ApexRebate - D·ªãch v·ª• Ho\xe0n ph\xed Concierge",context:"Generate a welcome email for a new trader who just joined ApexRebate"},payout_received:{subject:"ApexRebate: B·∫°n ƒë\xe3 nh·∫≠n ƒë∆∞·ª£c ho\xe0n ph\xed m·ªõi!",context:"Generate an email notification for a trader who received a new payout"},achievement_unlocked:{subject:"\uD83C\uDF89 Ch\xfac m·ª´ng! B·∫°n ƒë\xe3 m·ªü kh\xf3a th\xe0nh t·ª±u m·ªõi",context:"Generate an email to congratulate a trader on unlocking a new achievement"},tier_upgrade:{subject:"\uD83C\uDFC6 N\xe2ng c·∫•p th\xe0nh c\xf4ng! H·∫°ng m·ªõi c·ªßa b·∫°n t·∫°i ApexRebate",context:"Generate an email to congratulate a trader on upgrading to a new tier"},referral_success:{subject:"Tuy·ªát v·ªùi! L·ªùi gi·ªõi thi·ªáu c·ªßa b·∫°n ƒë\xe3 tham gia ApexRebate",context:"Generate an email to notify a trader that their referral was successful"},weekly_digest:{subject:"ApexRebate Weekly Digest - T·ªïng quan hi·ªáu su·∫•t c·ªßa b·∫°n",context:"Generate a weekly digest email with trading performance summary"},monthly_report:{subject:"ApexRebate Monthly Report - B\xe1o c\xe1o chi ti·∫øt th\xe1ng {month}",context:"Generate a comprehensive monthly report email"},inactivity_warning:{subject:"B·∫°n c\xf3 ·ªïn kh\xf4ng? Ch\xfang t\xf4i nh·ªõ b·∫°n t·∫°i ApexRebate",context:"Generate a gentle re-engagement email for inactive traders"},milestone_reached:{subject:"\uD83C\uDFAF C·ªôt m·ªëc ·∫•n t∆∞·ª£ng! Th\xe0nh t·ª±u c·ªßa b·∫°n t·∫°i ApexRebate",context:"Generate an email to celebrate reaching a significant milestone"},concierge_update:{subject:"C·∫≠p nh·∫≠t t·ª´ Concierge ApexRebate",context:"Generate a personalized update from the concierge service"}}[e];if(!a)throw Error(`Email type ${e} not supported`);try{let e=await this.zai.chat.completions.create({messages:[{role:"system",content:`You are a professional email writer for ApexRebate, a premium trading rebate service. 
            Write emails in Vietnamese that are:
            - Professional yet friendly
            - Data-driven and personalized
            - Motivational and encouraging
            - Clear and concise
            - Include specific numbers and metrics when provided
            
            The email should be well-structured with:
            1. Compelling subject line
            2. Personalized greeting
            3. Main content with specific data
            4. Call to action
            5. Professional closing`},{role:"user",content:`${a.context}
            
            User data: ${JSON.stringify(t,null,2)}
            
            Generate a complete email with subject and HTML content. The email should be engaging and personalized.`}],temperature:.7,max_tokens:1e3}),n=e.choices[0]?.message?.content||"";n.split("\n");let i=a.subject,r=n,s=n.match(/Subject[:\s]*(.+?)(?:\n|$)/i);s&&(i=s[1].trim(),r=n.replace(/Subject[:\s]*(.+?)(?:\n|$)/i,"").trim());let o=this.convertToHTML(r,t);return{subject:i,html:o,text:r.replace(/<[^>]*>/g,"")}}catch(a){return console.error("Failed to generate email content:",a),this.getFallbackTemplate(e,t)}}convertToHTML(e,t){let a=e.replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>");return`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ApexRebate</title>
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
          .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }
          .footer { text-align: center; margin-top: 30px; color: #666; font-size: 14px; }
          .btn { display: inline-block; background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 10px 0; }
          .metric { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
          .highlight { color: #007bff; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>üöÄ ApexRebate</h1>
            <p>D·ªãch v·ª• Ho\xe0n ph\xed Concierge cho Trader chuy\xean nghi·ªáp</p>
          </div>
          <div class="content">
            <p>${a}</p>
            ${this.generatePersonalizedContent(t)}
          </div>
          <div class="footer">
            <p>\xa9 2024 ApexRebate. All rights reserved.</p>
            <p>ƒê\xe2y l\xe0 email t·ª± ƒë·ªông. Vui l\xf2ng kh\xf4ng tr·∫£ l·ªùi email n\xe0y.</p>
          </div>
        </div>
      </body>
      </html>
    `}generatePersonalizedContent(e){let t="";return e.userName&&(t+=`<div class="metric"><strong>Ch\xe0o ${e.userName},</strong></div>`),e.payoutAmount&&(t+=`<div class="metric">
        <strong>Ho\xe0n ph\xed nh·∫≠n ƒë∆∞·ª£c:</strong> <span class="highlight">$${e.payoutAmount.toLocaleString()}</span>
      </div>`),e.totalSaved&&(t+=`<div class="metric">
        <strong>T·ªïng ƒë\xe3 ti·∫øt ki·ªám:</strong> <span class="highlight">$${e.totalSaved.toLocaleString()}</span>
      </div>`),e.currentTier&&(t+=`<div class="metric">
        <strong>H·∫°ng hi·ªán t·∫°i:</strong> <span class="highlight">${e.currentTier}</span>
      </div>`),e.achievementTitle&&(t+=`<div class="metric">
        <strong>Th\xe0nh t·ª±h m·ªõi:</strong> <span class="highlight">${e.achievementTitle}</span>
      </div>`),e.referralName&&(t+=`<div class="metric">
        <strong>L·ªùi gi·ªõi thi·ªáu th\xe0nh c\xf4ng:</strong> <span class="highlight">${e.referralName}</span>
      </div>`),t+=`
      <div style="text-align: center; margin: 30px 0;">
        <a href="${process.env.NEXT_PUBLIC_APP_URL}/dashboard" class="btn">
          Xem Dashboard
        </a>
      </div>
    `}getFallbackTemplate(e,t){let a={welcome:{subject:"Ch\xe0o m·ª´ng ƒë·∫øn v·ªõi ApexRebate!",html:`<p>Ch\xe0o m·ª´ng ${t.userName||"b·∫°n"} ƒë\xe3 tham gia ApexRebate!</p>
               <p>Ch\xfang t\xf4i r·∫•t vui ƒë∆∞·ª£c ƒë·ªìng h\xe0nh c\xf9ng b·∫°n tr\xean h\xe0nh tr\xecnh t·ªëi ∆∞u h\xf3a l·ª£i nhu·∫≠n giao d·ªãch.</p>`},payout_received:{subject:"B·∫°n ƒë\xe3 nh·∫≠n ƒë∆∞·ª£c ho\xe0n ph\xed m·ªõi!",html:`<p>Ch\xfac m·ª´ng! B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c ho\xe0n ph\xed <strong>$${t.payoutAmount||0}</strong>.</p>`},achievement_unlocked:{subject:"Ch\xfac m·ª´ng th\xe0nh t·ª±u m·ªõi!",html:`<p>Tuy·ªát v·ªùi! B·∫°n ƒë\xe3 m·ªü kh\xf3a th\xe0nh t·ª±h <strong>${t.achievementTitle||"m·ªõi"}</strong>.</p>`}}[e]||{subject:"Th\xf4ng b\xe1o t·ª´ ApexRebate",html:"<p>B·∫°n c\xf3 m·ªôt th\xf4ng b\xe1o m·ªõi t·ª´ ApexRebate.</p>"};return{subject:a.subject,html:this.convertToHTML(a.html,t)}}async createNotification(e,t,a,i,r){let s={id:`email_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userId:e,type:t,recipient:a,subject:"",content:"",data:i,status:"pending",createdAt:new Date,scheduledFor:r};try{await n.db.emailNotification.create({data:{id:s.id,userId:e,type:t,recipient:a,subject:s.subject,content:s.content,data:i?JSON.stringify(i):null,status:s.status,scheduledFor:r}})}catch(e){console.error("Failed to save email notification to database:",e)}return s}async sendEmail(e){try{let t=await this.generateEmailContent(e.type,e.data||{});return e.subject=t.subject,e.content=t.html,console.log("\uD83D\uDCE7 Sending email:",{to:e.recipient,subject:e.subject,type:e.type}),await new Promise(e=>setTimeout(e,1e3)),e.status="sent",e.sentAt=new Date,await n.db.emailNotification.update({where:{id:e.id},data:{subject:e.subject,content:e.content,status:"sent",sentAt:e.sentAt}}),console.log("‚úÖ Email sent successfully"),!0}catch(t){return console.error("Failed to send email:",t),e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",await n.db.emailNotification.update({where:{id:e.id},data:{status:"failed",error:e.error}}),!1}}async scheduleEmail(e,t,a,n,i){return this.createNotification(e,t,a,i,n)}async sendImmediateEmail(e,t,a,n){let i=await this.createNotification(e,t,a,n);return this.sendEmail(i)}async processPendingEmails(){try{let e=await n.db.emailNotification.findMany({where:{status:"pending",OR:[{scheduledFor:null},{scheduledFor:{lte:new Date}}]},orderBy:{createdAt:"asc"},take:50});for(let t of(console.log(`üìß Processing ${e.length} pending emails`),e)){let e={id:t.id,userId:t.userId,type:t.type,recipient:t.recipient,subject:t.subject,content:t.content,data:t.data?JSON.parse(t.data):void 0,status:t.status,createdAt:t.createdAt,sentAt:t.sentAt||void 0,error:t.error||void 0,scheduledFor:t.scheduledFor||void 0};await this.sendEmail(e)}}catch(e){console.error("Failed to process pending emails:",e)}}async getUserEmailPreferences(e){try{let t=await n.db.users.findUnique({where:{id:e},select:{email:!0,emailVerified:!0}});return{enabled:!!t?.emailVerified,email:t?.email}}catch(e){return console.error("Failed to get user email preferences:",e),{enabled:!1,email:null}}}async unsubscribeUser(e,t){console.log(`User ${e} unsubscribed from ${t||"all"} emails`)}}let s=r.getInstance();async function o(e,t,a,n){try{return console.log("\uD83D\uDCE7 Sending email:",{to:e,subject:t}),await new Promise(e=>setTimeout(e,1e3)),console.log("‚úÖ Email sent successfully"),!0}catch(e){return console.error("Failed to send email:",e),!1}}},21820:e=>{"use strict";e.exports=require("os")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},43763:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"ReflectAdapter",{enumerable:!0,get:function(){return a}});class a{static get(e,t,a){let n=Reflect.get(e,t,a);return"function"==typeof n?n.bind(e):n}static set(e,t,a,n){return Reflect.set(e,t,a,n)}static has(e,t){return Reflect.has(e,t)}static deleteProperty(e,t){return Reflect.deleteProperty(e,t)}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},57760:(e,t,a)=>{"use strict";a.r(t),a.d(t,{patchFetch:()=>x,routeModule:()=>f,serverHooks:()=>w,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>b});var n={};a.r(n),a.d(n,{GET:()=>h,POST:()=>p});var i=a(96559),r=a(48088),s=a(37719),o=a(32190),c=a(5069),l=a(21111);class d{constructor(){this.zai=null}static getInstance(){return d.instance||(d.instance=new d),d.instance}async initializeZAI(){try{if(this.zai)return;let e=await a.e(7838).then(a.bind(a,87838)),t=e?.default??e?.ZAI??e;t?.create?(this.zai=await t.create(),console.log("Marketing automation initialized with ZAI SDK")):console.warn("ZAI SDK module loaded but no create method was found")}catch(e){console.error("Failed to initialize ZAI SDK for marketing:",e)}}async createWelcomeSeries(e,t,a){for(let n of[{type:l.Z$.WELCOME,delay:0,data:{userName:a,isFirstEmail:!0}},{type:l.Z$.WEEKLY_DIGEST,delay:1440,data:{userName:a,isWelcome:!0,day:1}},{type:l.Z$.CONCIERGE_UPDATE,delay:4320,data:{userName:a,personalTip:!0}},{type:l.Z$.WEEKLY_DIGEST,delay:10080,data:{userName:a,isWelcome:!0,day:7}}]){let a=new Date(Date.now()+60*n.delay*1e3);await l.gm.scheduleEmail(e,n.type,t,a,n.data)}console.log(`‚úÖ Welcome series created for user ${e}`)}async createReEngagementCampaign(){try{let e=new Date(Date.now()-2592e6),t=await c.db.users.findMany({where:{emailVerified:!0,lastActiveAt:{lt:e},totalSaved:{gt:0}},take:100});for(let e of(console.log(`üìä Found ${t.length} inactive users for re-engagement`),t)){let t=Math.floor((Date.now()-e.lastActiveAt.getTime())/864e5);await l.gm.sendImmediateEmail(e.id,l.Z$.INACTIVITY_WARNING,e.email,{userName:e.name,daysInactive:t,totalSaved:e.totalSaved,lastActiveDate:e.lastActiveAt.toLocaleDateString("vi-VN")})}}catch(e){console.error("Failed to create re-engagement campaign:",e)}}async createEducationalSeries(){let e=[{type:l.Z$.WEEKLY_DIGEST,topic:"Trading Fee Optimization",data:{educationalTopic:"fee_optimization",isEducational:!0}},{type:l.Z$.WEEKLY_DIGEST,topic:"Risk Management",data:{educationalTopic:"risk_management",isEducational:!0}},{type:l.Z$.WEEKLY_DIGEST,topic:"Advanced Trading Strategies",data:{educationalTopic:"advanced_strategies",isEducational:!0}}];for(let t of(await c.db.users.findMany({where:{emailVerified:!0,lastActiveAt:{gte:new Date(Date.now()-6048e5)}},take:200}))){let a=e[Math.floor(Math.random()*e.length)];await l.gm.sendImmediateEmail(t.id,a.type,t.email,{...a.data,userName:t.name,currentTier:t.tier,totalSaved:t.totalSaved})}}async createReferralCampaign(){try{for(let e of(await c.db.users.findMany({where:{emailVerified:!0,totalSaved:{gt:100},referralCount:{lt:5}},take:50})))await l.gm.sendImmediateEmail(e.id,l.Z$.REFERRAL_SUCCESS,e.email,{userName:e.name,currentReferrals:e.referralCount,totalSaved:e.totalSaved,referralCode:e.referralCode,potentialEarnings:50*e.referralCount})}catch(e){console.error("Failed to create referral campaign:",e)}}async generatePersonalizedContent(e,t){this.zai||await this.initializeZAI();try{let a=await this.zai.chat.completions.create({messages:[{role:"system",content:`You are a marketing copywriter for ApexRebate, a premium trading rebate service.
            Generate personalized marketing content based on user data and campaign type.
            The content should be:
            - Highly personalized with specific user data
            - Motivational and action-oriented
            - Professional yet friendly tone
            - Include relevant metrics and achievements
            - Focus on value proposition`},{role:"user",content:`Generate personalized marketing content for:
            
            Campaign Type: ${t}
            User Data:
            - Name: ${e.name}
            - Current Tier: ${e.tier}
            - Total Saved: $${e.totalSaved}
            - Referral Count: ${e.referralCount}
            - Preferred Broker: ${e.preferredBroker}
            - Trading Volume: $${e.tradingVolume}
            - Member Since: ${e.createdAt}
            
            Create content that references their specific achievements and encourages the desired action.`}],temperature:.8,max_tokens:500});return a.choices[0]?.message?.content||""}catch(a){return console.error("Failed to generate personalized content:",a),this.getFallbackContent(e,t)}}getFallbackContent(e,t){return({re_engagement:`Ch\xe0o ${e.name}, ch\xfang t\xf4i nh·ªõ b·∫°n! B·∫°n ƒë\xe3 ti·∫øt ki·ªám ƒë∆∞·ª£c $${e.totalSaved} k·ªÉ t·ª´ khi tham gia. H\xe3y quay l·∫°i v\xe0 ti·∫øp t·ª•c h\xe0nh tr\xecnh t·ªëi ∆∞u h\xf3a l·ª£i nhu·∫≠n nh\xe9!`,referral:`Ch\xe0o ${e.name}, v·ªõi ${e.referralCount} l·ªùi gi·ªõi thi·ªáu, b·∫°n ƒëang l\xe0m r·∫•t t·ªët! M·ªùi th\xeam b·∫°n b\xe8 ƒë·ªÉ nh·∫≠n th\xeam ∆∞u ƒë\xe3i t·ª´ ApexRebate.`,educational:`Ch\xe0o ${e.name}, v·ªõi t∆∞ c\xe1ch l\xe0 th\xe0nh vi\xean ${e.tier}, ch\xfang t\xf4i c\xf3‰∫Ü‰∏Ä‰∫õ chi·∫øn l∆∞·ª£c giao d·ªãch n\xe2ng cao d\xe0nh ri\xeang cho b·∫°n.`,milestone:`Ch\xfac m·ª´ng ${e.name}! B·∫°n ƒë\xe3 ƒë·∫°t ƒë∆∞·ª£c c·ªôt m·ªëc ti·∫øt ki·ªám $${e.totalSaved} t·∫°i ApexRebate.`})[t]||`Ch\xe0o ${e.name}, c·∫£m ∆°n b·∫°n ƒë\xe3 l\xe0 th\xe0nh vi\xean ApexRebate!`}async createMilestoneCampaigns(){try{for(let e of(await c.db.users.findMany({where:{emailVerified:!0,totalSaved:{gt:0}},take:100})))for(let t of[{threshold:1e3,message:"s·∫Øp ƒë·∫°t $1,000 ti·∫øt ki·ªám"},{threshold:5e3,message:"s·∫Øp ƒë·∫°t $5,000 ti·∫øt ki·ªám"},{threshold:1e4,message:"s·∫Øp ƒë·∫°t $10,000 ti·∫øt ki·ªám"},{threshold:25e3,message:"s·∫Øp ƒë·∫°t $25,000 ti·∫øt ki·ªám"}]){let a=e.totalSaved/t.threshold;if(a>=.8&&a<1){await l.gm.sendImmediateEmail(e.id,l.Z$.MILESTONE_REACHED,e.email,{userName:e.name,currentSaved:e.totalSaved,milestoneThreshold:t.threshold,progress:Math.round(100*a),remaining:t.threshold-e.totalSaved,message:t.message});break}}}catch(e){console.error("Failed to create milestone campaigns:",e)}}async trackEmailMetrics(e,t,a){try{console.log(`üìä Email event tracked: ${e} - ${t}`,a)}catch(e){console.error("Failed to track email metrics:",e)}}async getSegmentUsers(e){try{let t={};return e.tradingVolume&&(t.tradingVolume={},e.tradingVolume.min&&(t.tradingVolume.gte=e.tradingVolume.min),e.tradingVolume.max&&(t.tradingVolume.lte=e.tradingVolume.max)),e.registrationDate&&(t.createdAt={},e.registrationDate.from&&(t.createdAt.gte=e.registrationDate.from),e.registrationDate.to&&(t.createdAt.lte=e.registrationDate.to)),e.lastActive&&(t.lastActiveAt={},e.lastActive.before&&(t.lastActiveAt.lte=e.lastActive.before),e.lastActive.after&&(t.lastActiveAt.gte=e.lastActive.after)),e.tier&&e.tier.length>0&&(t.tier={in:e.tier}),e.broker&&e.broker.length>0&&(t.preferredBroker={in:e.broker}),e.referralCount&&(t.referralCount={},e.referralCount.min&&(t.referralCount.gte=e.referralCount.min),e.referralCount.max&&(t.referralCount.lte=e.referralCount.max)),void 0!==e.hasPayouts&&(e.hasPayouts?t.payouts={some:{}}:t.payouts={none:{}}),void 0!==e.emailVerified&&(t.emailVerified=e.emailVerified),await c.db.users.findMany({where:t,take:1e3})}catch(e){return console.error("Failed to get segment users:",e),[]}}async runAutomatedCampaigns(){console.log("\uD83D\uDE80 Starting automated marketing campaigns...");try{await this.createReEngagementCampaign(),await this.createEducationalSeries(),await this.createReferralCampaign(),await this.createMilestoneCampaigns(),console.log("‚úÖ Automated campaigns completed")}catch(e){console.error("Failed to run automated campaigns:",e)}}async generateCampaignReport(e){try{return{campaignId:e,generatedAt:new Date,summary:"Campaign performance report",metrics:{sent:0,delivered:0,opened:0,clicked:0,converted:0,revenue:0},insights:[],recommendations:[]}}catch(e){return console.error("Failed to generate campaign report:",e),null}}}let u=d.getInstance();var m=a(19089);class g{static async processEmailQueue(){console.log("\uD83D\uDD04 Processing email queue..."),await l.gm.processPendingEmails(),console.log("‚úÖ Email queue processed")}static async sendWeeklyDigests(){console.log("\uD83D\uDCE7 Sending weekly digests...");try{await l.gm.processPendingEmails(),console.log("‚úÖ Weekly digests sent")}catch(e){console.error("Failed to send weekly digests:",e)}}static async sendMonthlyReports(){console.log("\uD83D\uDCCA Sending monthly reports...");try{await l.gm.processPendingEmails(),console.log("‚úÖ Monthly reports sent")}catch(e){console.error("Failed to send monthly reports:",e)}}static async checkUserInactivity(){console.log("\uD83D\uDD0D Checking user inactivity..."),await m.h.checkInactivityWarnings(),console.log("‚úÖ Inactivity check completed")}static async sendConciergeUpdates(){console.log("\uD83C\uDFAF Sending concierge updates..."),await m.h.sendConciergeUpdates(),console.log("‚úÖ Concierge updates sent")}static async runMarketingCampaigns(){console.log("\uD83D\uDCC8 Running automated marketing campaigns..."),await u.runAutomatedCampaigns(),console.log("‚úÖ Marketing campaigns completed")}static async cleanupOldNotifications(){console.log("\uD83E\uDDF9 Cleaning up old notifications...");try{let e=new Date;e.setDate(e.getDate()-90),console.log("‚úÖ Old notifications cleaned up")}catch(e){console.error("Failed to cleanup old notifications:",e)}}static async runAllJobs(){console.log("\uD83D\uDE80 Starting all cron jobs..."),await this.processEmailQueue(),await this.checkUserInactivity(),await this.sendConciergeUpdates(),await this.runMarketingCampaigns(),await this.cleanupOldNotifications(),console.log("‚úÖ All cron jobs completed")}static async runMorningJobs(){console.log("\uD83C\uDF05 Running morning jobs..."),await this.processEmailQueue(),await this.runMarketingCampaigns(),console.log("‚úÖ Morning jobs completed")}static async runEveningJobs(){console.log("\uD83C\uDF06 Running evening jobs..."),await this.checkUserInactivity(),await this.sendConciergeUpdates(),console.log("‚úÖ Evening jobs completed")}static async runWeeklyJobs(){console.log("\uD83D\uDCC5 Running weekly jobs..."),await this.sendWeeklyDigests(),await this.cleanupOldNotifications(),console.log("‚úÖ Weekly jobs completed")}static async runMonthlyJobs(){console.log("\uD83D\uDDD3Ô∏è Running monthly jobs..."),await this.sendMonthlyReports(),console.log("‚úÖ Monthly jobs completed")}}async function p(e){try{let t,{campaignType:a,userId:n,immediate:i}=await e.json();switch(console.log(`üìà Marketing campaign requested: ${a}`),a){case"welcome_series":if(!n)return o.NextResponse.json({error:"User ID is required for welcome series"},{status:400});let r=await c.db.users.findUnique({where:{id:n},select:{email:!0,name:!0}});r&&(await u.createWelcomeSeries(n,r.email,r.name||"Trader"),t={message:"Welcome series created successfully"});break;case"re_engagement":await u.createReEngagementCampaign(),t={message:"Re-engagement campaign created successfully"};break;case"educational":await u.createEducationalSeries(),t={message:"Educational series created successfully"};break;case"referral":await u.createReferralCampaign(),t={message:"Referral campaign created successfully"};break;case"milestone":await u.createMilestoneCampaigns(),t={message:"Milestone campaigns created successfully"};break;case"all":i?await u.runAutomatedCampaigns():await g.runMarketingCampaigns(),t={message:"All marketing campaigns executed successfully"};break;default:return o.NextResponse.json({error:"Invalid campaign type"},{status:400})}return o.NextResponse.json({success:!0,data:t,timestamp:new Date().toISOString()})}catch(e){return console.error("Marketing campaign error:",e),o.NextResponse.json({error:"Failed to execute marketing campaign"},{status:500})}}async function h(e){try{let{searchParams:t}=new URL(e.url);t.get("type");let a={availableCampaigns:[{type:"welcome_series",name:"Welcome Series",description:"Send welcome emails to new users"},{type:"re_engagement",name:"Re-engagement",description:"Re-engage inactive users"},{type:"educational",name:"Educational Series",description:"Send educational content"},{type:"referral",name:"Referral Campaign",description:"Encourage referrals"},{type:"milestone",name:"Milestone Campaigns",description:"Celebrate user milestones"}],status:"active",lastRun:new Date().toISOString()};return o.NextResponse.json({success:!0,data:a})}catch(e){return console.error("Marketing status error:",e),o.NextResponse.json({error:"Failed to get marketing status"},{status:500})}}let f=new i.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/marketing/campaigns/route",pathname:"/api/marketing/campaigns",filename:"route",bundlePath:"app/api/marketing/campaigns/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/marketing/campaigns/route.ts",nextConfigOutput:"standalone",userland:n}),{workAsyncStorage:y,workUnitAsyncStorage:b,serverHooks:w}=f;function x(){return(0,s.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:b})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},79748:e=>{"use strict";e.exports=require("fs/promises")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[7719,580],()=>a(57760));module.exports=n})();