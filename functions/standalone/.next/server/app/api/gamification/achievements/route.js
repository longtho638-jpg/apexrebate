(()=>{var e={};e.id=4296,e.ids=[4296,5069],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,i)=>{"use strict";i.d(t,{db:()=>a,prisma:()=>n});var r=i(96330);let a=globalThis.prisma??new r.PrismaClient({log:["query"]}),n=a},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,t,i)=>{"use strict";i.d(t,{N:()=>c});var r=i(60890),a=i(13581),n=i(36344),s=i(5069),o=i(85663);let c={adapter:(0,r.y)(s.db),providers:[...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,n.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[],(0,a.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await s.db.users.findUnique({where:{email:e.email}});return t&&t.password&&await o.Ay.compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"}}},13581:(e,t)=>{"use strict";t.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},19089:(e,t,i)=>{"use strict";i.d(t,{h:()=>n});var r=i(5069);class a{static async triggerWelcomeEmail(e){let t=await r.db.users.findUnique({where:{id:e}});t&&console.log(`Welcome email sent to ${t.email}`)}static async triggerCashbackEmail(e,t,i){let a=await r.db.users.findUnique({where:{id:e}});a&&console.log(`Cashback email sent to ${a.email}: $${t} for ${i}`)}static async triggerMilestoneEmail(e,t){let i=await r.db.users.findUnique({where:{id:e}});i&&console.log(`Milestone email sent to ${i.email}: ${t}`)}static async triggerReferralEmail(e,t){let i=await r.db.users.findUnique({where:{id:e}});i&&console.log(`Referral email sent to ${i.email}`)}static async triggerMonthlyReport(e,t){let i=await r.db.users.findUnique({where:{id:e}});i&&console.log(`Monthly report sent to ${i.email}`)}}let n=a},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},36344:(e,t)=>{"use strict";t.A=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56962:(e,t,i)=>{"use strict";i.r(t),i.d(t,{patchFetch:()=>v,routeModule:()=>g,serverHooks:()=>w,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>m});var r={};i.r(r),i.d(r,{GET:()=>u,POST:()=>p});var a=i(96559),n=i(48088),s=i(37719),o=i(32190),c=i(19854),l=i(12909),d=i(71810);async function u(){try{let e=await (0,c.getServerSession)(l.N);if(!e?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let t=await d.b.getUserGamification(e.user.id);if(!t)return o.NextResponse.json({error:"User not found"},{status:404});return o.NextResponse.json(t)}catch(e){return console.error("Error fetching gamification data:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function p(){try{let e=await (0,c.getServerSession)(l.N);if(!e?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});await d.b.initializeAchievements(),await d.b.checkAchievements(e.user.id);let t=await d.b.getUserGamification(e.user.id);return o.NextResponse.json({message:"Achievements checked successfully",data:t})}catch(e){return console.error("Error checking achievements:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/gamification/achievements/route",pathname:"/api/gamification/achievements",filename:"route",bundlePath:"app/api/gamification/achievements/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/gamification/achievements/route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:h,workUnitAsyncStorage:m,serverHooks:w}=g;function v(){return(0,s.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:m})}},60890:(e,t)=>{"use strict";t.y=void 0,t.y=function(e){return{createUser:t=>e.user.create({data:t}),getUser:t=>e.user.findUnique({where:{id:t}}),getUserByEmail:t=>e.user.findUnique({where:{email:t}}),async getUserByAccount(t){var i;let r=await e.account.findUnique({where:{provider_providerAccountId:t},select:{user:!0}});return null!=(i=null==r?void 0:r.user)?i:null},updateUser:({id:t,...i})=>e.user.update({where:{id:t},data:i}),deleteUser:t=>e.user.delete({where:{id:t}}),linkAccount:t=>e.account.create({data:t}),unlinkAccount:t=>e.account.delete({where:{provider_providerAccountId:t}}),async getSessionAndUser(t){let i=await e.session.findUnique({where:{sessionToken:t},include:{user:!0}});if(!i)return null;let{user:r,...a}=i;return{user:r,session:a}},createSession:t=>e.session.create({data:t}),updateSession:t=>e.session.update({where:{sessionToken:t.sessionToken},data:t}),deleteSession:t=>e.session.delete({where:{sessionToken:t}}),async createVerificationToken(t){let i=await e.verificationToken.create({data:t});return i.id&&delete i.id,i},async useVerificationToken(t){try{let i=await e.verificationToken.delete({where:{identifier_token:t}});return i.id&&delete i.id,i}catch(e){if("P2025"===e.code)return null;throw e}}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},71810:(e,t,i)=>{"use strict";i.d(t,{b:()=>o});var r=i(5069),a=i(19089);let n=[{id:"first_savings",name:"first_savings",title:"Bắt đầu tiết kiệm",description:"Tiết kiệm được khoản đầu ti\xean của bạn",icon:"\uD83C\uDFAF",category:"SAVINGS",points:10,condition:{type:"savings",target:1,operator:">="}},{id:"savings_100",name:"savings_100",title:"Nh\xe0 tiết kiệm",description:"Tiết kiệm được 100 USD",icon:"\uD83D\uDCB0",category:"SAVINGS",points:50,condition:{type:"savings",target:100,operator:">="}},{id:"savings_500",name:"savings_500",title:"Chuy\xean gia tiết kiệm",description:"Tiết kiệm được 500 USD",icon:"\uD83D\uDC8E",category:"SAVINGS",points:200,condition:{type:"savings",target:500,operator:">="}},{id:"savings_1000",name:"savings_1000",title:"Bậc thầy tiết kiệm",description:"Tiết kiệm được 1,000 USD",icon:"\uD83D\uDC51",category:"SAVINGS",points:500,tier:"SILVER",condition:{type:"savings",target:1e3,operator:">="}},{id:"first_referral",name:"first_referral",title:"Người giới thiệu",description:"Giới thiệu th\xe0nh c\xf4ng người d\xf9ng đầu ti\xean",icon:"\uD83E\uDD1D",category:"REFERRALS",points:25,condition:{type:"referrals",target:1,operator:">="}},{id:"referrals_5",name:"referrals_5",title:"Người kết nối",description:"Giới thiệu th\xe0nh c\xf4ng 5 người d\xf9ng",icon:"\uD83C\uDF1F",category:"REFERRALS",points:100,condition:{type:"referrals",target:5,operator:">="}},{id:"referrals_10",name:"referrals_10",title:"Người dẫn dắt",description:"Giới thiệu th\xe0nh c\xf4ng 10 người d\xf9ng",icon:"\uD83D\uDE80",category:"REFERRALS",points:250,tier:"GOLD",condition:{type:"referrals",target:10,operator:">="}},{id:"streak_7",name:"streak_7",title:"Tuần lễ t\xedch cực",description:"Đăng nhập 7 ng\xe0y li\xean tiếp",icon:"\uD83D\uDD25",category:"ACTIVITY",points:30,condition:{type:"streak",target:7,operator:">="}},{id:"streak_30",name:"streak_30",title:"Th\xe1ng trung th\xe0nh",description:"Đăng nhập 30 ng\xe0y li\xean tiếp",icon:"\uD83D\uDCAA",category:"ACTIVITY",points:150,tier:"SILVER",condition:{type:"streak",target:30,operator:">="}},{id:"volume_100k",name:"volume_100k",title:"Nh\xe0 giao dịch t\xedch cực",description:"Khối lượng giao dịch 100,000 USD",icon:"\uD83D\uDCC8",category:"TRADING",points:40,condition:{type:"trading_volume",target:1e5,operator:">="}},{id:"volume_1m",name:"volume_1m",title:"Nh\xe0 giao dịch chuy\xean nghiệp",description:"Khối lượng giao dịch 1,000,000 USD",icon:"\uD83D\uDCCA",category:"TRADING",points:200,tier:"GOLD",condition:{type:"trading_volume",target:1e6,operator:">="}}],s={BRONZE:0,SILVER:500,GOLD:1500,PLATINUM:3e3,DIAMOND:5e3};class o{static async initializeAchievements(){for(let e of n)await r.db.achievement.upsert({where:{name:e.name},update:{title:e.title,description:e.description,icon:e.icon,category:e.category,points:e.points,tier:e.tier,condition:JSON.stringify(e.condition)},create:{name:e.name,title:e.title,description:e.description,icon:e.icon,category:e.category,points:e.points,tier:e.tier,condition:JSON.stringify(e.condition)}})}static async checkAchievements(e){let t=await r.db.users.findUnique({where:{id:e},include:{achievements:{include:{achievement:!0}}}});if(!t)return;let i=t.achievements.map(e=>e.achievementId);for(let a of(await r.db.achievement.findMany({where:{isActive:!0,id:{notIn:i}}}))){let i=JSON.parse(a.condition);await this.checkCondition(t,i)&&await this.unlockAchievement(e,a.id)}}static async checkCondition(e,t){let{type:i,target:r,operator:a=">="}=t,n=0;switch(i){case"savings":n=e.totalSaved||0;break;case"referrals":n=e.referralCount||0;break;case"streak":n=e.streak||0;break;case"trading_volume":n=e.tradingVolume||0;break;default:return!1}switch(a){case">":return n>r;case">=":default:return n>=r;case"=":return n===r;case"<=":return n<=r}}static async unlockAchievement(e,t){let i=await r.db.achievement.findUnique({where:{id:t}});if(i){await r.db.userAchievement.create({data:{userId:e,achievementId:t,unlockedAt:new Date,progress:100,pointsAwarded:i.points}}),await r.db.users.update({where:{id:e},data:{points:{increment:i.points},badgeCount:{increment:1}}}),await this.logActivity(e,"ACHIEVEMENT_UNLOCKED",`Mở th\xe0nh tựu: ${i.title}`,{achievementId:t,points:i.points},i.points);try{await a.h.onAchievementUnlocked(e,i.title,i.points)}catch(e){console.error("Failed to send achievement email:",e)}await this.checkTierUpgrade(e)}}static async checkTierUpgrade(e){let t=await r.db.users.findUnique({where:{id:e}});if(!t)return;let i=t.tier;if(t.points>=s.DIAMOND?i="DIAMOND":t.points>=s.PLATINUM?i="PLATINUM":t.points>=s.GOLD?i="GOLD":t.points>=s.SILVER&&(i="SILVER"),i!==t.tier){await r.db.users.update({where:{id:e},data:{tier:i}}),await this.logActivity(e,"TIER_UPGRADE",`N\xe2ng cấp l\xean hạng: ${i}`,{oldTier:t.tier,newTier:i},100);try{await a.h.onTierUpgrade(e,i)}catch(e){console.error("Failed to send tier upgrade email:",e)}}}static async logActivity(e,t,i,a,n){await r.db.userActivity.create({data:{userId:e,type:t,description:i,metadata:a?JSON.stringify(a):null,points:n||0}}),n&&n>0&&await r.db.users.update({where:{id:e},data:{points:{increment:n},lastActiveAt:new Date}})}static async updateActivityStreak(e){let t=await r.db.users.findUnique({where:{id:e}});if(!t)return;let i=new Date,a=t.lastActiveAt?new Date(t.lastActiveAt):null,n=a&&i.getDate()===a.getDate()+1&&i.getMonth()===a.getMonth()&&i.getFullYear()===a.getFullYear(),s=1;if(n)s=(t.streak||0)+1;else if(a&&i.toDateString()===a.toDateString())return;await r.db.users.update({where:{id:e},data:{streak:s,lastActiveAt:i}}),await this.logActivity(e,"LOGIN","Đăng nhập h\xe0ng ng\xe0y",{streak:s},5),await this.checkAchievements(e)}static async getUserGamification(e){let t=await r.db.users.findUnique({where:{id:e},include:{achievements:{include:{achievement:!0},orderBy:{unlockedAt:"desc"}},activities:{orderBy:{createdAt:"desc"},take:10},referredUsers:{select:{id:!0,createdAt:!0}}}});if(!t)return null;let i=s[t.tier],a=Object.entries(s).sort(([,e],[,t])=>e-t),n=a.findIndex(([e])=>e===t.tier),o=a[n+1],c=o?o[1]:null,l=c?(t.points-i)/(c-i)*100:100;return{user:{id:t.id,name:t.name,email:t.email,image:t.image,tier:t.tier,points:t.points,totalSaved:t.totalSaved,referralCount:t.referralCount,streak:t.streak,badgeCount:t.badgeCount,lastActiveAt:t.lastActiveAt},achievements:t.achievements,recentActivities:t.activities,referrals:t.referredUsers,tierProgress:{currentTier:t.tier,nextTier:o?o[0]:null,currentPoints:t.points,currentThreshold:i,nextThreshold:c,progressPercentage:Math.min(l,100)}}}static async processReferral(e,t){let i=await r.db.users.findUnique({where:{id:t},select:{name:!0,email:!0}});if(await r.db.users.update({where:{id:e},data:{referralCount:{increment:1}}}),await this.logActivity(e,"REFERRAL","Giới thiệu th\xe0nh c\xf4ng người d\xf9ng mới",{referredUserId:t},50),i)try{await a.h.onReferralSuccess(e,i.name||i.email?.split("@")[0]||"Anonymous")}catch(e){console.error("Failed to send referral success email:",e)}await this.checkAchievements(e)}static async updateSavings(e,t){await r.db.users.update({where:{id:e},data:{totalSaved:{increment:t}}}),await this.logActivity(e,"SAVINGS_MILESTONE",`Tiết kiệm th\xeam $${t.toFixed(2)}`,{amount:t},Math.floor(t/10)),await this.checkAchievements(e)}}},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[7719,4999,580,8044,9854],()=>i(56962));module.exports=r})();