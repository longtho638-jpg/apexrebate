(()=>{var e={};e.id=455,e.ids=[455,5069],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,r)=>{"use strict";r.d(t,{db:()=>i,prisma:()=>a});var n=r(96330);let i=globalThis.prisma??new n.PrismaClient({log:["query"]}),a=i},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,t,r)=>{"use strict";r.d(t,{N:()=>c});var n=r(60890),i=r(13581),a=r(36344),s=r(5069),o=r(85663);let c={adapter:(0,n.y)(s.db),providers:[...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,a.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[],(0,i.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await s.db.users.findUnique({where:{email:e.email}});return t&&t.password&&await o.Ay.compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"}}},13581:(e,t)=>{"use strict";t.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},21111:(e,t,r)=>{"use strict";r.d(t,{Z$:()=>i,ZM:()=>o,gm:()=>s});var n=r(5069),i=function(e){return e.WELCOME="welcome",e.PAYOUT_RECEIVED="payout_received",e.ACHIEVEMENT_UNLOCKED="achievement_unlocked",e.TIER_UPGRADE="tier_upgrade",e.REFERRAL_SUCCESS="referral_success",e.WEEKLY_DIGEST="weekly_digest",e.MONTHLY_REPORT="monthly_report",e.INACTIVITY_WARNING="inactivity_warning",e.MILESTONE_REACHED="milestone_reached",e.CONCIERGE_UPDATE="concierge_update",e}({});class a{constructor(){this.zai=null}static getInstance(){return a.instance||(a.instance=new a),a.instance}async initializeZAI(){try{let e=await r.e(7838).then(r.bind(r,87838));this.zai=await e.create(),console.log("Email service initialized with ZAI SDK")}catch(e){console.error("Failed to initialize ZAI SDK for email service:",e)}}async generateEmailContent(e,t){this.zai||await this.initializeZAI();let r={welcome:{subject:"Ch\xe0o m·ª´ng ƒë·∫øn v·ªõi ApexRebate - D·ªãch v·ª• Ho\xe0n ph\xed Concierge",context:"Generate a welcome email for a new trader who just joined ApexRebate"},payout_received:{subject:"ApexRebate: B·∫°n ƒë\xe3 nh·∫≠n ƒë∆∞·ª£c ho\xe0n ph\xed m·ªõi!",context:"Generate an email notification for a trader who received a new payout"},achievement_unlocked:{subject:"\uD83C\uDF89 Ch\xfac m·ª´ng! B·∫°n ƒë\xe3 m·ªü kh\xf3a th\xe0nh t·ª±u m·ªõi",context:"Generate an email to congratulate a trader on unlocking a new achievement"},tier_upgrade:{subject:"\uD83C\uDFC6 N\xe2ng c·∫•p th\xe0nh c\xf4ng! H·∫°ng m·ªõi c·ªßa b·∫°n t·∫°i ApexRebate",context:"Generate an email to congratulate a trader on upgrading to a new tier"},referral_success:{subject:"Tuy·ªát v·ªùi! L·ªùi gi·ªõi thi·ªáu c·ªßa b·∫°n ƒë\xe3 tham gia ApexRebate",context:"Generate an email to notify a trader that their referral was successful"},weekly_digest:{subject:"ApexRebate Weekly Digest - T·ªïng quan hi·ªáu su·∫•t c·ªßa b·∫°n",context:"Generate a weekly digest email with trading performance summary"},monthly_report:{subject:"ApexRebate Monthly Report - B\xe1o c\xe1o chi ti·∫øt th\xe1ng {month}",context:"Generate a comprehensive monthly report email"},inactivity_warning:{subject:"B·∫°n c\xf3 ·ªïn kh\xf4ng? Ch\xfang t\xf4i nh·ªõ b·∫°n t·∫°i ApexRebate",context:"Generate a gentle re-engagement email for inactive traders"},milestone_reached:{subject:"\uD83C\uDFAF C·ªôt m·ªëc ·∫•n t∆∞·ª£ng! Th\xe0nh t·ª±u c·ªßa b·∫°n t·∫°i ApexRebate",context:"Generate an email to celebrate reaching a significant milestone"},concierge_update:{subject:"C·∫≠p nh·∫≠t t·ª´ Concierge ApexRebate",context:"Generate a personalized update from the concierge service"}}[e];if(!r)throw Error(`Email type ${e} not supported`);try{let e=await this.zai.chat.completions.create({messages:[{role:"system",content:`You are a professional email writer for ApexRebate, a premium trading rebate service. 
            Write emails in Vietnamese that are:
            - Professional yet friendly
            - Data-driven and personalized
            - Motivational and encouraging
            - Clear and concise
            - Include specific numbers and metrics when provided
            
            The email should be well-structured with:
            1. Compelling subject line
            2. Personalized greeting
            3. Main content with specific data
            4. Call to action
            5. Professional closing`},{role:"user",content:`${r.context}
            
            User data: ${JSON.stringify(t,null,2)}
            
            Generate a complete email with subject and HTML content. The email should be engaging and personalized.`}],temperature:.7,max_tokens:1e3}),n=e.choices[0]?.message?.content||"";n.split("\n");let i=r.subject,a=n,s=n.match(/Subject[:\s]*(.+?)(?:\n|$)/i);s&&(i=s[1].trim(),a=n.replace(/Subject[:\s]*(.+?)(?:\n|$)/i,"").trim());let o=this.convertToHTML(a,t);return{subject:i,html:o,text:a.replace(/<[^>]*>/g,"")}}catch(r){return console.error("Failed to generate email content:",r),this.getFallbackTemplate(e,t)}}convertToHTML(e,t){let r=e.replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>");return`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ApexRebate</title>
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; }
          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
          .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }
          .footer { text-align: center; margin-top: 30px; color: #666; font-size: 14px; }
          .btn { display: inline-block; background: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; margin: 10px 0; }
          .metric { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
          .highlight { color: #007bff; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>üöÄ ApexRebate</h1>
            <p>D·ªãch v·ª• Ho\xe0n ph\xed Concierge cho Trader chuy\xean nghi·ªáp</p>
          </div>
          <div class="content">
            <p>${r}</p>
            ${this.generatePersonalizedContent(t)}
          </div>
          <div class="footer">
            <p>\xa9 2024 ApexRebate. All rights reserved.</p>
            <p>ƒê\xe2y l\xe0 email t·ª± ƒë·ªông. Vui l\xf2ng kh\xf4ng tr·∫£ l·ªùi email n\xe0y.</p>
          </div>
        </div>
      </body>
      </html>
    `}generatePersonalizedContent(e){let t="";return e.userName&&(t+=`<div class="metric"><strong>Ch\xe0o ${e.userName},</strong></div>`),e.payoutAmount&&(t+=`<div class="metric">
        <strong>Ho\xe0n ph\xed nh·∫≠n ƒë∆∞·ª£c:</strong> <span class="highlight">$${e.payoutAmount.toLocaleString()}</span>
      </div>`),e.totalSaved&&(t+=`<div class="metric">
        <strong>T·ªïng ƒë\xe3 ti·∫øt ki·ªám:</strong> <span class="highlight">$${e.totalSaved.toLocaleString()}</span>
      </div>`),e.currentTier&&(t+=`<div class="metric">
        <strong>H·∫°ng hi·ªán t·∫°i:</strong> <span class="highlight">${e.currentTier}</span>
      </div>`),e.achievementTitle&&(t+=`<div class="metric">
        <strong>Th\xe0nh t·ª±h m·ªõi:</strong> <span class="highlight">${e.achievementTitle}</span>
      </div>`),e.referralName&&(t+=`<div class="metric">
        <strong>L·ªùi gi·ªõi thi·ªáu th\xe0nh c\xf4ng:</strong> <span class="highlight">${e.referralName}</span>
      </div>`),t+=`
      <div style="text-align: center; margin: 30px 0;">
        <a href="${process.env.NEXT_PUBLIC_APP_URL}/dashboard" class="btn">
          Xem Dashboard
        </a>
      </div>
    `}getFallbackTemplate(e,t){let r={welcome:{subject:"Ch\xe0o m·ª´ng ƒë·∫øn v·ªõi ApexRebate!",html:`<p>Ch\xe0o m·ª´ng ${t.userName||"b·∫°n"} ƒë\xe3 tham gia ApexRebate!</p>
               <p>Ch\xfang t\xf4i r·∫•t vui ƒë∆∞·ª£c ƒë·ªìng h\xe0nh c\xf9ng b·∫°n tr\xean h\xe0nh tr\xecnh t·ªëi ∆∞u h\xf3a l·ª£i nhu·∫≠n giao d·ªãch.</p>`},payout_received:{subject:"B·∫°n ƒë\xe3 nh·∫≠n ƒë∆∞·ª£c ho\xe0n ph\xed m·ªõi!",html:`<p>Ch\xfac m·ª´ng! B·∫°n v·ª´a nh·∫≠n ƒë∆∞·ª£c ho\xe0n ph\xed <strong>$${t.payoutAmount||0}</strong>.</p>`},achievement_unlocked:{subject:"Ch\xfac m·ª´ng th\xe0nh t·ª±u m·ªõi!",html:`<p>Tuy·ªát v·ªùi! B·∫°n ƒë\xe3 m·ªü kh\xf3a th\xe0nh t·ª±h <strong>${t.achievementTitle||"m·ªõi"}</strong>.</p>`}}[e]||{subject:"Th\xf4ng b\xe1o t·ª´ ApexRebate",html:"<p>B·∫°n c\xf3 m·ªôt th\xf4ng b\xe1o m·ªõi t·ª´ ApexRebate.</p>"};return{subject:r.subject,html:this.convertToHTML(r.html,t)}}async createNotification(e,t,r,i,a){let s={id:`email_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userId:e,type:t,recipient:r,subject:"",content:"",data:i,status:"pending",createdAt:new Date,scheduledFor:a};try{await n.db.emailNotification.create({data:{id:s.id,userId:e,type:t,recipient:r,subject:s.subject,content:s.content,data:i?JSON.stringify(i):null,status:s.status,scheduledFor:a}})}catch(e){console.error("Failed to save email notification to database:",e)}return s}async sendEmail(e){try{let t=await this.generateEmailContent(e.type,e.data||{});return e.subject=t.subject,e.content=t.html,console.log("\uD83D\uDCE7 Sending email:",{to:e.recipient,subject:e.subject,type:e.type}),await new Promise(e=>setTimeout(e,1e3)),e.status="sent",e.sentAt=new Date,await n.db.emailNotification.update({where:{id:e.id},data:{subject:e.subject,content:e.content,status:"sent",sentAt:e.sentAt}}),console.log("‚úÖ Email sent successfully"),!0}catch(t){return console.error("Failed to send email:",t),e.status="failed",e.error=t instanceof Error?t.message:"Unknown error",await n.db.emailNotification.update({where:{id:e.id},data:{status:"failed",error:e.error}}),!1}}async scheduleEmail(e,t,r,n,i){return this.createNotification(e,t,r,i,n)}async sendImmediateEmail(e,t,r,n){let i=await this.createNotification(e,t,r,n);return this.sendEmail(i)}async processPendingEmails(){try{let e=await n.db.emailNotification.findMany({where:{status:"pending",OR:[{scheduledFor:null},{scheduledFor:{lte:new Date}}]},orderBy:{createdAt:"asc"},take:50});for(let t of(console.log(`üìß Processing ${e.length} pending emails`),e)){let e={id:t.id,userId:t.userId,type:t.type,recipient:t.recipient,subject:t.subject,content:t.content,data:t.data?JSON.parse(t.data):void 0,status:t.status,createdAt:t.createdAt,sentAt:t.sentAt||void 0,error:t.error||void 0,scheduledFor:t.scheduledFor||void 0};await this.sendEmail(e)}}catch(e){console.error("Failed to process pending emails:",e)}}async getUserEmailPreferences(e){try{let t=await n.db.users.findUnique({where:{id:e},select:{email:!0,emailVerified:!0}});return{enabled:!!t?.emailVerified,email:t?.email}}catch(e){return console.error("Failed to get user email preferences:",e),{enabled:!1,email:null}}}async unsubscribeUser(e,t){console.log(`User ${e} unsubscribed from ${t||"all"} emails`)}}let s=a.getInstance();async function o(e,t,r,n){try{return console.log("\uD83D\uDCE7 Sending email:",{to:e,subject:t}),await new Promise(e=>setTimeout(e,1e3)),console.log("‚úÖ Email sent successfully"),!0}catch(e){return console.error("Failed to send email:",e),!1}}},21820:e=>{"use strict";e.exports=require("os")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},36344:(e,t)=>{"use strict";t.A=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46373:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>p,serverHooks:()=>g,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>m});var n={};r.r(n),r.d(n,{POST:()=>d});var i=r(96559),a=r(48088),s=r(37719),o=r(32190),c=r(19854),l=r(12909),u=r(21111);async function d(e){try{let t,r=await (0,c.getServerSession)(l.N);if(!r?.user?.id)return o.NextResponse.json({success:!1,error:{code:"UNAUTHORIZED",message:"B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p"}},{status:401});let{type:n,recipient:i,data:a,scheduledFor:s}=await e.json();if(!n||!i)return o.NextResponse.json({success:!1,error:{code:"INVALID_INPUT",message:"Thi·∫øu th\xf4ng tin b·∫Øt bu·ªôc"}},{status:400});if(!Object.values(u.Z$).includes(n))return o.NextResponse.json({success:!1,error:{code:"INVALID_TYPE",message:"Lo·∫°i email kh\xf4ng h·ª£p l·ªá"}},{status:400});if(!(await u.gm.getUserEmailPreferences(r.user.id)).enabled)return o.NextResponse.json({success:!1,error:{code:"EMAIL_DISABLED",message:"Ng∆∞·ªùi d\xf9ng ƒë\xe3 t·∫Øt email"}},{status:400});if(s){let e=new Date(s);return t=await u.gm.scheduleEmail(r.user.id,n,i,e,a),o.NextResponse.json({success:!0,data:{id:t.id,scheduledFor:t.scheduledFor,message:"Email ƒë\xe3 ƒë∆∞·ª£c l\xean l·ªãch g·ª≠i"}})}if(await u.gm.sendImmediateEmail(r.user.id,n,i,a))return o.NextResponse.json({success:!0,message:"Email ƒë\xe3 ƒë∆∞·ª£c g·ª≠i th\xe0nh c\xf4ng"});return o.NextResponse.json({success:!1,error:{code:"SEND_FAILED",message:"G·ª≠i email th·∫•t b·∫°i"}},{status:500})}catch(e){return console.error("Send email API error:",e),o.NextResponse.json({success:!1,error:{code:"INTERNAL_ERROR",message:"L·ªói server n·ªôi b·ªô"}},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/notifications/send/route",pathname:"/api/notifications/send",filename:"route",bundlePath:"app/api/notifications/send/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/notifications/send/route.ts",nextConfigOutput:"standalone",userland:n}),{workAsyncStorage:h,workUnitAsyncStorage:m,serverHooks:g}=p;function x(){return(0,s.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:m})}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},60890:(e,t)=>{"use strict";t.y=void 0,t.y=function(e){return{createUser:t=>e.user.create({data:t}),getUser:t=>e.user.findUnique({where:{id:t}}),getUserByEmail:t=>e.user.findUnique({where:{email:t}}),async getUserByAccount(t){var r;let n=await e.account.findUnique({where:{provider_providerAccountId:t},select:{user:!0}});return null!=(r=null==n?void 0:n.user)?r:null},updateUser:({id:t,...r})=>e.user.update({where:{id:t},data:r}),deleteUser:t=>e.user.delete({where:{id:t}}),linkAccount:t=>e.account.create({data:t}),unlinkAccount:t=>e.account.delete({where:{provider_providerAccountId:t}}),async getSessionAndUser(t){let r=await e.session.findUnique({where:{sessionToken:t},include:{user:!0}});if(!r)return null;let{user:n,...i}=r;return{user:n,session:i}},createSession:t=>e.session.create({data:t}),updateSession:t=>e.session.update({where:{sessionToken:t.sessionToken},data:t}),deleteSession:t=>e.session.delete({where:{sessionToken:t}}),async createVerificationToken(t){let r=await e.verificationToken.create({data:t});return r.id&&delete r.id,r},async useVerificationToken(t){try{let r=await e.verificationToken.delete({where:{identifier_token:t}});return r.id&&delete r.id,r}catch(e){if("P2025"===e.code)return null;throw e}}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79748:e=>{"use strict";e.exports=require("fs/promises")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[7719,4999,580,8044,9854],()=>r(46373));module.exports=n})();