(()=>{var e={};e.id=4531,e.ids=[4531,5069],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,r)=>{"use strict";r.d(t,{db:()=>s,prisma:()=>n});var a=r(96330);let s=globalThis.prisma??new a.PrismaClient({log:["query"]}),n=s},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,t,r)=>{"use strict";r.d(t,{N:()=>l});var a=r(60890),s=r(13581),n=r(36344),i=r(5069),o=r(85663);let l={adapter:(0,a.y)(i.db),providers:[...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,n.A)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[],(0,s.A)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await i.db.users.findUnique({where:{email:e.email}});return t&&t.password&&await o.Ay.compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/signin"}}},13581:(e,t)=>{"use strict";t.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},36344:(e,t)=>{"use strict";t.A=function(e){return{id:"google",name:"Google",type:"oauth",wellKnown:"https://accounts.google.com/.well-known/openid-configuration",authorization:{params:{scope:"openid email profile"}},idToken:!0,checks:["pkce","state"],profile:e=>({id:e.sub,name:e.name,email:e.email,image:e.picture}),style:{logo:"/google.svg",bg:"#fff",text:"#000"},options:e}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},60890:(e,t)=>{"use strict";t.y=void 0,t.y=function(e){return{createUser:t=>e.user.create({data:t}),getUser:t=>e.user.findUnique({where:{id:t}}),getUserByEmail:t=>e.user.findUnique({where:{email:t}}),async getUserByAccount(t){var r;let a=await e.account.findUnique({where:{provider_providerAccountId:t},select:{user:!0}});return null!=(r=null==a?void 0:a.user)?r:null},updateUser:({id:t,...r})=>e.user.update({where:{id:t},data:r}),deleteUser:t=>e.user.delete({where:{id:t}}),linkAccount:t=>e.account.create({data:t}),unlinkAccount:t=>e.account.delete({where:{provider_providerAccountId:t}}),async getSessionAndUser(t){let r=await e.session.findUnique({where:{sessionToken:t},include:{user:!0}});if(!r)return null;let{user:a,...s}=r;return{user:a,session:s}},createSession:t=>e.session.create({data:t}),updateSession:t=>e.session.update({where:{sessionToken:t.sessionToken},data:t}),deleteSession:t=>e.session.delete({where:{sessionToken:t}}),async createVerificationToken(t){let r=await e.verificationToken.create({data:t});return r.id&&delete r.id,r},async useVerificationToken(t){try{let r=await e.verificationToken.delete({where:{identifier_token:t}});return r.id&&delete r.id,r}catch(e){if("P2025"===e.code)return null;throw e}}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},65316:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>A,routeModule:()=>g,serverHooks:()=>w,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{GET:()=>y,POST:()=>h});var s=r(96559),n=r(48088),i=r(37719),o=r(32190),l=r(80130),c=r(5069);class u{constructor(e){this.userBaselines=new Map,this.recentAlerts=new Map,this.isAnalyzing=!1,this.config=e,this.initializeDetector()}async initializeDetector(){try{await this.loadUserBaselines(),this.config.realTimeAnalysis&&this.startRealTimeAnalysis(),this.startBatchAnalysis(),l.vF.info("ML Anomaly Detector initialized",{enabled:this.config.enabled,sensitivity:this.config.sensitivity,userBaselines:this.userBaselines.size})}catch(e){l.vF.error("Failed to initialize ML Anomaly Detector",{error:e.message})}}async loadUserBaselines(){try{let e=await c.db.userBaseline.findMany();e.forEach(e=>{this.userBaselines.set(e.userId,{userId:e.userId,avgTransactionAmount:e.avgTransactionAmount,avgTransactionFrequency:e.avgTransactionFrequency,typicalPairs:e.typicalPairs,typicalExchanges:e.typicalExchanges,volumeStdDev:e.volumeStdDev,frequencyStdDev:e.frequencyStdDev,lastUpdated:e.lastUpdated,sampleSize:e.sampleSize})}),l.vF.info("User baselines loaded",{count:e.length})}catch(e){l.vF.error("Failed to load user baselines",{error:e.message})}}async analyzeTransaction(e){if(!this.config.enabled)return[];try{let t=[],r=e.userId,a=this.userBaselines.get(r);if((!a||a.sampleSize<this.config.minSampleSize)&&(a=await this.buildUserBaseline(r))&&this.userBaselines.set(r,a),!a)return[];let s=this.detectVolumeSpike(e,a);s&&t.push(s);let n=this.detectPriceDeviation(e,a);n&&t.push(n);let i=this.detectFrequencyBurst(e,a);i&&t.push(i);let o=this.detectUnusualPattern(e,a);o&&t.push(o);let l=this.detectSecurityRisk(e,a);return l&&t.push(l),t.length>0&&(await this.saveAlerts(t),this.updateRecentAlerts(r,t)),await this.updateUserBaseline(r,e),t}catch(t){return l.vF.error("Failed to analyze transaction",{error:t.message,transactionId:e.metadata?.id||"unknown"}),[]}}async buildUserBaseline(e){try{let t=new Date;t.setDate(t.getDate()-this.config.lookbackPeriod);let r=await c.db.exchangeTransaction.findMany({where:{userId:e,timestamp:{gte:t}},orderBy:{timestamp:"desc"}});if(r.length<this.config.minSampleSize)return null;let a=r.map(e=>e.amount),s=a.reduce((e,t)=>e+t,0)/a.length,n=a.reduce((e,t)=>e+Math.pow(t-s,2),0)/a.length,i=Math.sqrt(n),o=(r[0].timestamp.getTime()-r[r.length-1].timestamp.getTime())/36e5,l=r.length/o,u=this.calculateFrequencyVariance(r),d=Math.sqrt(u),p=new Map,m=new Map;r.forEach(e=>{p.set(e.pair,(p.get(e.pair)||0)+1),m.set(e.exchange,(m.get(e.exchange)||0)+1)});let y=Array.from(p.entries()).sort((e,t)=>t[1]-e[1]).slice(0,5).map(([e])=>e),h=Array.from(m.entries()).sort((e,t)=>t[1]-e[1]).slice(0,3).map(([e])=>e),g={userId:e,avgTransactionAmount:s,avgTransactionFrequency:l,typicalPairs:y,typicalExchanges:h,volumeStdDev:i,frequencyStdDev:d,lastUpdated:new Date,sampleSize:r.length};return await c.db.userBaseline.upsert({where:{userId:e},update:g,create:g}),g}catch(t){return l.vF.error("Failed to build user baseline",{userId:e,error:t.message}),null}}calculateFrequencyVariance(e){if(e.length<2)return 0;let t=[];for(let r=1;r<e.length;r++){let a=(e[r-1].timestamp.getTime()-e[r].timestamp.getTime())/6e4;t.push(a)}let r=t.reduce((e,t)=>e+t,0)/t.length;return t.reduce((e,t)=>e+Math.pow(t-r,2),0)/t.length}detectVolumeSpike(e,t){let r=this.config.alertThresholds.volumeSpike,a=t.avgTransactionAmount+2*t.volumeStdDev,s=e.amount;if(s>a*r){let n=Math.min(1,(s-a)/(a*(r-1)));return{id:`volume-spike-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,userId:e.userId,type:"volume_spike",severity:n>.8?"high":n>.5?"medium":"low",confidence:n,title:"异常交易量激增",description:`检测到交易量 ${s.toFixed(2)} 远超正常水平 ${t.avgTransactionAmount.toFixed(2)}`,detectedAt:new Date,pattern:e,explanation:`正常交易量范围: ${(t.avgTransactionAmount-t.volumeStdDev).toFixed(2)} - ${(t.avgTransactionAmount+t.volumeStdDev).toFixed(2)}`,recommendations:["确认是否为本人操作","检查账户安全性","考虑设置交易限额"],metadata:{expectedAmount:t.avgTransactionAmount,deviationMultiplier:s/t.avgTransactionAmount}}}return null}detectPriceDeviation(e,t){return(e.price,this.config.alertThresholds.priceDeviation,t.typicalPairs.includes(e.pair))?null:{id:`price-deviation-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,userId:e.userId,type:"price_deviation",severity:"medium",confidence:.7,title:"异常交易对",description:`检测到不常见的交易对: ${e.pair}`,detectedAt:new Date,pattern:e,explanation:`您通常交易的货币对: ${t.typicalPairs.join(", ")}`,recommendations:["确认交易对是否正确","了解该交易对的风险","谨慎交易不熟悉的货币对"],metadata:{unusualPair:e.pair,typicalPairs:t.typicalPairs}}}async detectFrequencyBurst(e,t){let r=this.config.alertThresholds.frequencyBurst,a=new Date(new Date().getTime()-36e5);try{let s=await c.db.exchangeTransaction.count({where:{userId:e.userId,timestamp:{gte:a}}}),n=t.avgTransactionFrequency+2*t.frequencyStdDev;if(s>n*r){let a=Math.min(1,(s-n)/(n*(r-1)));return{id:`frequency-burst-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,userId:e.userId,type:"frequency_burst",severity:a>.8?"high":a>.5?"medium":"low",confidence:a,title:"异常交易频率",description:`过去1小时内进行了 ${s} 笔交易，远超正常频率`,detectedAt:new Date,pattern:e,explanation:`正常交易频率: ${t.avgTransactionFrequency.toFixed(2)} 笔/小时`,recommendations:["确认所有交易均为本人操作","检查账户是否被盗用","考虑启用二次验证"],metadata:{recentCount:s,expectedFrequency:t.avgTransactionFrequency}}}}catch(e){l.vF.error("Failed to detect frequency burst",{error:e.message})}return null}detectUnusualPattern(e,t){if(!t.typicalExchanges.includes(e.exchange))return{id:`unusual-pattern-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,userId:e.userId,type:"unusual_pattern",severity:"low",confidence:.6,title:"异常交易所使用",description:`检测到不常用的交易所: ${e.exchange}`,detectedAt:new Date,pattern:e,explanation:`您通常使用的交易所: ${t.typicalExchanges.join(", ")}`,recommendations:["确认交易所安全性","了解该交易所的费用结构","谨慎使用新交易所"],metadata:{unusualExchange:e.exchange,typicalExchanges:t.typicalExchanges}};let r=e.timestamp.getHours();return r>=2&&r<=5?{id:`unusual-pattern-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,userId:e.userId,type:"unusual_pattern",severity:"low",confidence:.5,title:"异常交易时间",description:`检测到深夜时段交易 (${r}:00)`,detectedAt:new Date,pattern:e,explanation:"深夜交易可能存在风险或表示紧急情况",recommendations:["确认交易必要性","注意疲劳交易风险","考虑设置交易时间限制"],metadata:{tradingHour:r}}:null}detectSecurityRisk(e,t){if("transfer"===e.type&&e.amount>10*t.avgTransactionAmount)return{id:`security-risk-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,userId:e.userId,type:"security_risk",severity:"high",confidence:.8,title:"潜在安全风险",description:`检测到异常大额转账: ${e.amount.toFixed(2)}`,detectedAt:new Date,pattern:e,explanation:"大额快速转账可能是账户被盗用的迹象",recommendations:["立即确认是否为本人操作","如非本人操作，立即冻结账户","联系客服并修改密码"],metadata:{transferAmount:e.amount,riskLevel:"high"}};let r=this.checkRecentSmallTransactions(e.userId);return r>20?{id:`security-risk-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,userId:e.userId,type:"security_risk",severity:"medium",confidence:.7,title:"可疑交易模式",description:`检测到连续小额交易 ${r} 笔`,detectedAt:new Date,pattern:e,explanation:"连续小额交易可能是试探性攻击或测试账户权限",recommendations:["检查账户活动日志","确认所有交易均为本人操作","考虑启用交易通知"],metadata:{smallTransactionCount:r,riskLevel:"medium"}}:null}async checkRecentSmallTransactions(e){try{let t=new Date(Date.now()-36e5),r=this.userBaselines.get(e);if(!r)return 0;return await c.db.exchangeTransaction.count({where:{userId:e,timestamp:{gte:t},amount:{lt:.1*r.avgTransactionAmount}}})}catch(e){return l.vF.error("Failed to check recent small transactions",{error:e.message}),0}}async saveAlerts(e){try{for(let t of e)await c.db.anomalyAlert.create({data:{id:t.id,userId:t.userId,type:t.type,severity:t.severity,confidence:t.confidence,title:t.title,description:t.description,detectedAt:t.detectedAt,pattern:t.pattern,explanation:t.explanation,recommendations:t.recommendations,metadata:t.metadata}});l.vF.info("Anomaly alerts saved",{count:e.length})}catch(e){l.vF.error("Failed to save anomaly alerts",{error:e.message})}}updateRecentAlerts(e,t){this.recentAlerts.has(e)||this.recentAlerts.set(e,[]);let r=this.recentAlerts.get(e);r.push(...t);let a=new Date(Date.now()-864e5),s=r.filter(e=>e.detectedAt>a);this.recentAlerts.set(e,s)}async updateUserBaseline(e,t){try{let r=this.userBaselines.get(e);if(!r)return;r.avgTransactionAmount=.9*r.avgTransactionAmount+.1*t.amount,r.lastUpdated=new Date,r.sampleSize++,await c.db.userBaseline.update({where:{userId:e},data:{avgTransactionAmount:r.avgTransactionAmount,lastUpdated:r.lastUpdated,sampleSize:r.sampleSize}})}catch(e){l.vF.error("Failed to update user baseline",{error:e.message})}}startRealTimeAnalysis(){l.vF.info("Real-time anomaly analysis started")}startBatchAnalysis(){setInterval(async()=>{if(!this.isAnalyzing){this.isAnalyzing=!0;try{await this.performBatchAnalysis()}catch(e){l.vF.error("Batch analysis failed",{error:e.message})}finally{this.isAnalyzing=!1}}},60*this.config.batchAnalysisInterval*1e3),l.vF.info("Batch anomaly analysis started",{interval:`${this.config.batchAnalysisInterval} minutes`})}async performBatchAnalysis(){try{let e=new Date(Date.now()-60*this.config.batchAnalysisInterval*1e3),t=await c.db.exchangeTransaction.findMany({where:{timestamp:{gte:e},analyzed:!1},take:1e3}),r=0;for(let e of t){let t=await this.analyzeTransaction({userId:e.userId,timestamp:e.timestamp,amount:e.amount,type:e.type,exchange:e.exchange,pair:e.pair,price:e.price,volume:e.volume,metadata:e.metadata});r+=t.length,await c.db.exchangeTransaction.update({where:{id:e.id},data:{analyzed:!0}})}r>0&&l.vF.info("Batch analysis completed",{transactionsAnalyzed:t.length,alertsDetected:r})}catch(e){l.vF.error("Batch analysis failed",{error:e.message})}}async getUserAlerts(e,t){try{let r={userId:e};return t&&(r.severity=t),(await c.db.anomalyAlert.findMany({where:r,orderBy:{detectedAt:"desc"},take:50})).map(e=>({id:e.id,userId:e.userId,type:e.type,severity:e.severity,confidence:e.confidence,title:e.title,description:e.description,detectedAt:e.detectedAt,pattern:e.pattern,explanation:e.explanation,recommendations:e.recommendations,metadata:e.metadata}))}catch(e){return l.vF.error("Failed to get user alerts",{error:e.message}),[]}}async getSystemStats(){try{let e=await c.db.anomalyAlert.count(),t=this.userBaselines.size,r=await c.db.anomalyAlert.groupBy({by:["type"],_count:!0}),a={};r.forEach(e=>{a[e.type]=e._count});let s=await c.db.anomalyAlert.groupBy({by:["severity"],_count:!0}),n={};s.forEach(e=>{n[e.severity]=e._count});let i=await c.db.anomalyAlert.aggregate({_avg:{confidence:!0}});return{totalAlerts:e,alertsByType:a,alertsBySeverity:n,activeUsers:t,avgConfidence:i._avg.confidence||0}}catch(e){return l.vF.error("Failed to get system stats",{error:e.message}),{totalAlerts:0,alertsByType:{},alertsBySeverity:{},activeUsers:0,avgConfidence:0}}}updateConfig(e){this.config={...this.config,...e},l.vF.info("ML Anomaly Detector configuration updated",{config:this.config})}getStatus(){let e=Array.from(this.recentAlerts.values()).reduce((e,t)=>e+t.length,0);return{enabled:this.config.enabled,isAnalyzing:this.isAnalyzing,userBaselines:this.userBaselines.size,recentAlerts:e,config:this.config}}}let d=new u({enabled:!0,sensitivity:.7,minSampleSize:30,lookbackPeriod:30,alertThresholds:{volumeSpike:3,priceDeviation:20,frequencyBurst:5},realTimeAnalysis:!0,batchAnalysisInterval:15});var p=r(19854),m=r(12909);async function y(e){try{let t=await (0,p.getServerSession)(m.N);if(!t?.user?.id)return o.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=t.user.id,{searchParams:a}=new URL(e.url),s=a.get("severity"),n=await d.getUserAlerts(r,s||void 0);return o.NextResponse.json({success:!0,data:{alerts:n,count:n.length,userId:r,severity:s||"all"}})}catch(e){return console.error("Anomaly alerts API error:",e),o.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to get anomaly alerts"},{status:500})}}async function h(e){try{let t=await (0,p.getServerSession)(m.N);if(!t?.user?.id)return o.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=t.user.id,{transaction:a}=await e.json();if(!a)return o.NextResponse.json({success:!1,error:"Transaction data is required"},{status:400});let s=await d.analyzeTransaction({userId:r,...a,timestamp:new Date(a.timestamp)});return o.NextResponse.json({success:!0,data:{alerts:s,count:s.length,transactionId:a.id||"unknown"}})}catch(e){return console.error("Anomaly detection API error:",e),o.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Failed to analyze transaction"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/anomaly-detection/alerts/route",pathname:"/api/anomaly-detection/alerts",filename:"route",bundlePath:"app/api/anomaly-detection/alerts/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/anomaly-detection/alerts/route.ts",nextConfigOutput:"standalone",userland:a}),{workAsyncStorage:v,workUnitAsyncStorage:f,serverHooks:w}=g;function A(){return(0,i.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:f})}},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},80130:(e,t,r)=>{"use strict";r.d(t,{vF:()=>l});var a=r(33873),s=r.n(a),n=r(29021),i=r.n(n);let o=s().join(process.cwd(),"logs");i().existsSync(o)||i().mkdirSync(o,{recursive:!0});let l=(()=>{let e=(e,t,r)=>{let a=JSON.stringify({timestamp:new Date().toISOString(),level:e,message:t,...r&&{meta:r}})+"\n",n=s().join(o,"combined.log");try{i().appendFileSync(n,a)}catch(e){console.error("Failed to write to log file:",e)}};return{error:(t,r)=>e("error",t,r),warn:(t,r)=>e("warn",t,r),info:(t,r)=>e("info",t,r),http:(t,r)=>e("http",t,r),debug:(t,r)=>e("debug",t,r)}})();setInterval(()=>{let e=Date.now();i().readdir(o,(t,r)=>{if(t)return void l.error("Failed to read logs directory",{error:t.message});r.forEach(t=>{let r=s().join(o,t);i().stat(r,(a,s)=>{if(a)return void l.error("Failed to get file stats",{file:t,error:a.message});e-s.mtime.getTime()>2592e6&&i().unlink(r,e=>{e?l.error("Failed to delete old log file",{file:t,error:e.message}):l.info("Deleted old log file",{file:t})})})})})},864e5)},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[7719,4999,580,8044,9854],()=>r(65316));module.exports=a})();