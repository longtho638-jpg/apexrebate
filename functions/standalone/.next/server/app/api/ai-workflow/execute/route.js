(()=>{var e={};e.id=1426,e.ids=[1426],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},8719:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{isRequestAPICallableInsideAfter:function(){return c},throwForSearchParamsAccessInUseCache:function(){return i},throwWithStaticGenerationBailoutError:function(){return s},throwWithStaticGenerationBailoutErrorWithDynamicError:function(){return o}});let n=r(80023),a=r(3295);function s(e,t){throw Object.defineProperty(new n.StaticGenBailoutError(`Route ${e} couldn't be rendered statically because it used ${t}. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`),"__NEXT_ERROR_CODE",{value:"E576",enumerable:!1,configurable:!0})}function o(e,t){throw Object.defineProperty(new n.StaticGenBailoutError(`Route ${e} with \`dynamic = "error"\` couldn't be rendered statically because it used ${t}. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`),"__NEXT_ERROR_CODE",{value:"E543",enumerable:!1,configurable:!0})}function i(e){let t=Object.defineProperty(Error(`Route ${e.route} used "searchParams" inside "use cache". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use "searchParams" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`),"__NEXT_ERROR_CODE",{value:"E634",enumerable:!1,configurable:!0});throw e.invalidUsageError??=t,t}function c(){let e=a.afterTaskAsyncStorage.getStore();return(null==e?void 0:e.rootTaskSpawnPhase)==="action"}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34863:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>j,routeModule:()=>b,serverHooks:()=>E,workAsyncStorage:()=>P,workUnitAsyncStorage:()=>R});var n={};r.r(n),r.d(n,{GET:()=>d,POST:()=>u});var a=r(96559),s=r(48088),o=r(37719),i=r(32190);let c=new Map;async function u(e){try{let t=await e.json();if(!t.name||!t.steps||!Array.isArray(t.steps))return i.NextResponse.json({error:"工作流数据无效"},{status:400});let r=`exec-${Date.now()}`,n={id:r,name:t.name,description:t.description||"",steps:t.steps,status:"pending",results:{},logs:[]};return c.set(r,n),l(r),i.NextResponse.json({success:!0,executionId:r,message:"工作流已开始执行",status:"pending"})}catch(e){return console.error("工作流执行API错误:",e),i.NextResponse.json({error:"服务器内部错误"},{status:500})}}async function d(e){try{let{searchParams:t}=new URL(e.url),r=t.get("executionId");if(!r)return i.NextResponse.json({error:"缺少执行ID"},{status:400});let n=c.get(r);if(!n)return i.NextResponse.json({error:"执行记录不存在"},{status:404});return i.NextResponse.json({success:!0,data:n})}catch(e){return console.error("获取执行状态API错误:",e),i.NextResponse.json({error:"服务器内部错误"},{status:500})}}async function l(e){let t=c.get(e);if(t)try{for(let r of(t.status="running",t.startTime=new Date,x(e,"info","工作流开始执行"),function(e){let t=[],r=new Set,n=new Set;for(let a of e)!function a(s){if(n.has(s))throw Error(`检测到循环依赖: ${s}`);if(r.has(s))return;n.add(s);let o=e.find(e=>e.id===s);if(o)for(let e of o.dependencies)a(e);n.delete(s),r.add(s),t.push(s)}(a.id);return t}(t.steps))){let n=t.steps.find(e=>e.id===r);if(n)try{await f(e,n)}catch(a){let r=a instanceof Error?a.message:String(a);x(e,"error",`步骤 ${n.name} 执行失败`,{error:r}),n.status="error",t.status="failed",t.endTime=new Date;return}}t.status="completed",t.endTime=new Date,x(e,"info","工作流执行完成")}catch(r){t.status="failed",t.endTime=new Date,x(e,"error","工作流执行失败",{error:r instanceof Error?r.message:String(r)})}}async function f(e,t){if(!c.get(e))throw Error("执行记录不存在");t.status="running",x(e,"info",`开始执行步骤: ${t.name}`);try{switch(t.type){case"api":await p(e,t);break;case"data":await m(e,t);break;case"notification":await g(e,t);break;case"calculation":await h(e,t);break;case"validation":await w(e,t);break;case"cleanup":await y(e,t);break;default:throw Error(`未知的步骤类型: ${t.type}`)}t.status="completed",x(e,"info",`步骤完成: ${t.name}`)}catch(e){throw t.status="error",e}}async function p(e,t){let{url:r,method:n="GET",headers:a={},body:s}=t.config;x(e,"info",`调用API: ${n} ${r}`),await new Promise(e=>setTimeout(e,1e3));let o={status:"success",data:{message:"API调用成功",timestamp:new Date().toISOString()}},i=c.get(e);i&&(i.results[t.id]=o),x(e,"info","API调用成功",o)}async function m(e,t){let{operation:r,source:n,target:a}=t.config;x(e,"info",`执行数据操作: ${r}`),await new Promise(e=>setTimeout(e,800));let s={processed:!0,records:Math.floor(1e3*Math.random())+100,operation:r},o=c.get(e);o&&(o.results[t.id]=s),x(e,"info","数据处理完成",s)}async function g(e,t){let{type:r,recipients:n,message:a,template:s}=t.config;x(e,"info",`发送${r}通知给 ${n?.length||0} 个接收者`),await new Promise(e=>setTimeout(e,500));let o={sent:!0,recipients:n?.length||0,type:r,messageId:`msg-${Date.now()}`},i=c.get(e);i&&(i.results[t.id]=o),x(e,"info","通知发送成功",o)}async function h(e,t){let{formula:r,variables:n}=t.config;x(e,"info",`执行计算: ${r}`),await new Promise(e=>setTimeout(e,300));let a={formula:r,result:Math.floor(1e4*Math.random())+1e3,variables:n,timestamp:new Date().toISOString()},s=c.get(e);s&&(s.results[t.id]=a),x(e,"info","计算完成",a)}async function w(e,t){let{rules:r,data:n}=t.config;x(e,"info",`执行验证: ${r?.length||0} 条规则`),await new Promise(e=>setTimeout(e,200));let a={valid:Math.random()>.2,rules:r?.length||0,passed:Math.floor(Math.random()*(r?.length||5))+1,failed:+(Math.random()>.8)},s=c.get(e);s&&(s.results[t.id]=a),x(e,"info","验证完成",a)}async function y(e,t){let{target:r,policy:n}=t.config;x(e,"info",`执行清理: ${r}`),await new Promise(e=>setTimeout(e,400));let a={cleaned:!0,target:r,policy:n,items:Math.floor(100*Math.random())+10,space:`${Math.floor(100*Math.random())+10}MB`},s=c.get(e);s&&(s.results[t.id]=a),x(e,"info","清理完成",a)}function x(e,t,r,n){let a=c.get(e);a&&a.logs.push({stepId:"system",timestamp:new Date,level:t,message:r,data:n})}let b=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/ai-workflow/execute/route",pathname:"/api/ai-workflow/execute",filename:"route",bundlePath:"app/api/ai-workflow/execute/route"},resolvedPagePath:"/Users/macbookprom1/apexrebate-1/src/app/api/ai-workflow/execute/route.ts",nextConfigOutput:"standalone",userland:n}),{workAsyncStorage:P,workUnitAsyncStorage:R,serverHooks:E}=b;function j(){return(0,o.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:R})}},43763:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"ReflectAdapter",{enumerable:!0,get:function(){return r}});class r{static get(e,t,r){let n=Reflect.get(e,t,r);return"function"==typeof n?n.bind(e):n}static set(e,t,r,n){return Reflect.set(e,t,r,n)}static has(e,t){return Reflect.has(e,t)}static deleteProperty(e,t){return Reflect.deleteProperty(e,t)}}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[7719,580],()=>r(34863));module.exports=n})();